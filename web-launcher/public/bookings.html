<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookings - Fleetillo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .nav-group.expanded .nav-children {
            display: flex;
        }
    </style>
</head>

<body class="dark-theme">
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <img src="assets/images/fleetillo_logo.png" alt="Fleetillo" style="height: 60px;">
            </div>

            <nav class="nav-menu">
                <!-- Dashboard -->
                <a href="index.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                        </svg>
                    </span>
                    Dashboard
                </a>

                <!-- PLANNING -->
                <div class="menu-header">PLANNING</div>

                <a href="customers.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </span>
                    Customers
                </a>

                <a href="services.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                    </span>
                    Services
                </a>

                <a href="bookings.html" class="nav-item active">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                    </span>
                    Bookings
                </a>

                <a href="calendar.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </span>
                    Calendar
                </a>

                <a href="locations.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </span>
                    Locations
                </a>

                <!-- FLEET -->
                <div class="menu-header">FLEET</div>

                <a href="vehicles.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                    </span>
                    Vehicles
                </a>

                <a href="drivers.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </span>
                    Drivers
                </a>

                <!-- OPERATIONS -->
                <div class="menu-header">OPERATIONS</div>

                <a href="routes.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="6" cy="19" r="3" />
                            <path d="M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15" />
                            <circle cx="18" cy="5" r="3" />
                        </svg>
                    </span>
                    Routes
                </a>

                <a href="dispatch.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </span>
                    Dispatch
                    <span class="badge new">New</span>
                </a>

                <!-- SYSTEM -->
                <div class="menu-header">SYSTEM</div>

                <a href="#" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                    </span>
                    Reports
                </a>

                <a href="settings.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </span>
                    Settings
                </a>
            </nav>
            <script>
                // Auto-expand current group if any
                document.addEventListener('DOMContentLoaded', () => {
                    const activeLink = document.querySelector('.nav-item.active');
                    if (activeLink) {
                        // Ensure it's visible, though flatter structure makes this simpler
                    }
                });
            </script>


            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="avatar">JM</div>
                    <div class="details">
                        <span class="name">Admin User</span>
                        <span class="role">Administrator</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="search-input" placeholder="Search bookings...">
                </div>
                <div class="actions">
                    <button class="btn-secondary" id="import-btn">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        Import
                    </button>
                    <button class="btn-primary" id="add-booking-btn">+ New Booking</button>
                </div>
            </header>

            <div class="content-wrapper">
                <div class="page-header">
                    <h2>Bookings</h2>
                    <span class="date">Manage service appointments</span>
                </div>

                <!-- Filters Bar -->
                <div class="filters-bar"
                    style="background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 16px; margin-bottom: 20px; display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end;">
                    <div class="filter-group" style="display: flex; flex-direction: column; gap: 6px;">
                        <label style="font-size: 0.8rem; color: var(--text-secondary); font-weight: 500;">Date
                            Range</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="date" id="filter-date-from"
                                style="background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); color: var(--text-primary); padding: 8px; border-radius: 6px; font-family: inherit;">
                            <span style="color: var(--text-secondary);">to</span>
                            <input type="date" id="filter-date-to"
                                style="background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); color: var(--text-primary); padding: 8px; border-radius: 6px; font-family: inherit;">
                        </div>
                    </div>

                    <div class="filter-group"
                        style="display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 150px; max-width: 250px;">
                        <label
                            style="font-size: 0.8rem; color: var(--text-secondary); font-weight: 500;">Customer</label>
                        <select id="filter-client"
                            style="background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); color: var(--text-primary); padding: 8px; border-radius: 6px; width: 100%;">
                            <option value="">All Customers</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <div class="filter-group"
                        style="display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 150px; max-width: 250px;">
                        <label
                            style="font-size: 0.8rem; color: var(--text-secondary); font-weight: 500;">Vehicle</label>
                        <select id="filter-vehicle"
                            style="background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); color: var(--text-primary); padding: 8px; border-radius: 6px; width: 100%;">
                            <option value="">All Vehicles</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <div class="filter-group"
                        style="display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 150px; max-width: 250px;">
                        <label style="font-size: 0.8rem; color: var(--text-secondary); font-weight: 500;">Route</label>
                        <select id="filter-route"
                            style="background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); color: var(--text-primary); padding: 8px; border-radius: 6px; width: 100%;">
                            <option value="">All Routes</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <div class="filter-group"
                        style="display: flex; flex-direction: column; gap: 6px; min-width: 140px;">
                        <label style="font-size: 0.8rem; color: var(--text-secondary); font-weight: 500;">Status</label>
                        <select id="filter-status"
                            style="background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); color: var(--text-primary); padding: 8px; border-radius: 6px; width: 100%;">
                            <option value="">All Statuses</option>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                            <option value="no_show">No Show</option>
                        </select>
                    </div>

                    <div class="filter-actions" style="margin-left: auto; padding-bottom: 2px;">
                        <button id="clear-filters-btn" class="btn-secondary"
                            style="height: 36px; padding: 0 16px; background: transparent; border: 1px solid var(--border-subtle); color: var(--text-secondary); border-radius: 6px; cursor: pointer; transition: all 0.2s;">
                            Clear Filters
                        </button>
                    </div>
                </div>

                <!-- Bookings Table -->
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Booking #</th>
                                <th>Customer</th>
                                <th>Service / Type</th>
                                <th>Location</th>
                                <th>Date & Time</th>
                                <th>Status</th>
                                <th>Price</th>
                                <th style="min-width: 100px;">
                                    <div
                                        style="display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                                        <span>Actions</span>
                                        <div style="position: relative; display: inline-block;">
                                            <button type="button" id="bulk-status-btn" class="action-btn tooltip-bottom"
                                                style="display: none; color: var(--text-primary);"
                                                data-tooltip="Change Status">
                                                <svg width="18" height="18" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round"
                                                    stroke-linejoin="round">
                                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                                </svg>
                                            </button>
                                            <div id="bulk-status-dropdown" class="bulk-status-dropdown"
                                                style="display: none; position: absolute; right: 0; top: 100%; background: #1e1e2e; border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.6); z-index: 1000; min-width: 180px; overflow: hidden;">
                                                <div
                                                    style="padding: 8px 12px; font-size: 0.75rem; color: var(--text-secondary); border-bottom: 1px solid var(--border-color); font-weight: 600;">
                                                    Change Status To</div>
                                                <button type="button" class="bulk-status-option" data-status="pending"
                                                    style="width: 100%; text-align: left; padding: 10px 12px; background: transparent; border: none; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.15s;">
                                                    <span
                                                        style="width: 10px; height: 10px; border-radius: 50%; background: #8b949e;"></span>Pending
                                                </button>
                                                <button type="button" class="bulk-status-option" data-status="confirmed"
                                                    style="width: 100%; text-align: left; padding: 10px 12px; background: transparent; border: none; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.15s;">
                                                    <span
                                                        style="width: 10px; height: 10px; border-radius: 50%; background: #3fb950;"></span>Confirmed
                                                </button>
                                                <button type="button" class="bulk-status-option" data-status="scheduled"
                                                    style="width: 100%; text-align: left; padding: 10px 12px; background: transparent; border: none; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.15s;">
                                                    <span
                                                        style="width: 10px; height: 10px; border-radius: 50%; background: #3fb950;"></span>Scheduled
                                                </button>
                                                <button type="button" class="bulk-status-option"
                                                    data-status="in_progress"
                                                    style="width: 100%; text-align: left; padding: 10px 12px; background: transparent; border: none; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.15s;">
                                                    <span
                                                        style="width: 10px; height: 10px; border-radius: 50%; background: #58a6ff;"></span>In
                                                    Progress
                                                </button>
                                                <button type="button" class="bulk-status-option" data-status="completed"
                                                    style="width: 100%; text-align: left; padding: 10px 12px; background: transparent; border: none; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.15s;">
                                                    <span
                                                        style="width: 10px; height: 10px; border-radius: 50%; background: #3fb950;"></span>Completed
                                                </button>
                                                <button type="button" class="bulk-status-option" data-status="cancelled"
                                                    style="width: 100%; text-align: left; padding: 10px 12px; background: transparent; border: none; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.15s;">
                                                    <span
                                                        style="width: 10px; height: 10px; border-radius: 50%; background: #f85149;"></span>Cancelled
                                                </button>
                                            </div>
                                        </div>
                                        <!-- Bulk Delete -->
                                        <button type="button" id="bulk-delete-btn"
                                            class="action-btn delete-btn tooltip-bottom"
                                            style="display: none; color: var(--text-danger);"
                                            data-tooltip="Delete Selected">
                                            <svg width="18" height="18" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round"
                                                stroke-linejoin="round">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path
                                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                                </path>
                                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                                <line x1="14" y1="11" x2="14" y2="17"></line>
                                            </svg>
                                        </button>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="bookings-table-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Footer -->
                <div class="pagination-footer"
                    style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between;">
                    <div class="rows-per-page">
                        <label for="rows-select" style="margin-right: 8px; color: var(--text-secondary);">Rows per
                            page:</label>
                        <select id="rows-select"
                            style="background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px; padding: 4px 8px;">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="pagination-controls" style="display: flex; align-items: center; gap: 16px;">
                        <span id="pagination-info" style="color: var(--text-secondary); font-size: 0.9rem;">0-0 of
                            0</span>
                        <div class="page-nav">
                            <button id="prev-page-btn" class="action-btn" style="padding: 4px 8px;"
                                disabled>Previous</button>
                            <button id="next-page-btn" class="action-btn" style="padding: 4px 8px;"
                                disabled>Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Booking Modal -->
    <div id="add-booking-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 id="modal-title">Add New Booking</h2>
                    <div id="booking-id-display"
                        style="display: none; font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">
                        Booking #: <span id="booking-id-text"></span>
                    </div>
                </div>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="booking-form">
                    <input type="hidden" id="booking-id">

                    <div class="form-group" style="position: relative;">
                        <label>Customer *</label>
                        <input type="text" id="client-search" placeholder="Search customer by name..."
                            autocomplete="off">
                        <input type="hidden" id="client-id">
                        <div id="client-search-results"
                            style="display: none; position: absolute; width: 100%; top: 100%; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; z-index: 10; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
                        </div>
                        <div id="selected-client-display"
                            style="display: none; margin-top: 8px; padding: 8px; background: rgba(88, 166, 255, 0.1); border-radius: 4px; align-items: center; justify-content: space-between;">
                            <span id="selected-client-name" style="font-weight: 500;"></span>
                            <button type="button" id="clear-client-btn"
                                style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">‚úï</button>
                        </div>
                    </div>

                    <div class="form-group" style="position: relative;">
                        <label>Services</label>
                        <input type="text" id="service-search" placeholder="Search to add service..."
                            autocomplete="off">
                        <div id="service-search-results"
                            style="display: none; position: absolute; width: 100%; top: 100%; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; z-index: 10; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
                        </div>

                        <!-- Selected Services List -->
                        <div class="table-container"
                            style="margin-top: 10px; border: 1px solid var(--border-subtle); border-radius: 6px; max-height: 200px; overflow-y: auto;">
                            <table class="data-table" id="selected-services-table" style="margin: 0;">
                                <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 1;">
                                    <tr>
                                        <th style="padding: 8px;">Service</th>
                                        <th style="width: 60px; padding: 8px;">Qty</th>
                                        <th style="width: 80px; padding: 8px;">Price</th>
                                        <th style="width: 80px; padding: 8px;">Total</th>
                                        <th style="width: 40px; padding: 8px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="selected-services-tbody">
                                    <tr id="no-services-row">
                                        <td colspan="5"
                                            style="text-align: center; color: var(--text-secondary); padding: 12px;">No
                                            services added</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Service Totals -->
                        <div
                            style="display: flex; justify-content: flex-end; margin-top: 8px; gap: 16px; font-size: 0.9rem;">
                            <div>Est. Time: <span id="total-estimated-time-display" style="font-weight: 600;">0
                                    min</span></div>
                            <div>List Price: <span id="total-list-price-display" style="font-weight: 600;">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="position: relative;">
                        <label>Location</label>
                        <input type="text" id="location-search" placeholder="Search location by name..."
                            autocomplete="off">
                        <input type="hidden" id="location-id">
                        <div id="location-search-results"
                            style="display: none; position: absolute; width: 100%; top: 100%; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; z-index: 10; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
                        </div>
                        <div id="selected-location-display"
                            style="display: none; margin-top: 8px; padding: 8px; background: rgba(88, 166, 255, 0.1); border-radius: 4px; align-items: center; justify-content: space-between;">
                            <div style="display:flex; flex-direction:column;">
                                <span id="selected-location-name" style="font-weight: 500;"></span>
                                <span id="selected-location-address"
                                    style="font-size: 0.8rem; color: var(--text-secondary);"></span>
                            </div>
                            <button type="button" id="clear-location-btn"
                                style="background: none; border: none; color: var(--text-secondary); cursor: pointer;">‚úï</button>
                        </div>
                        <div id="location-client-hint"
                            style="display: none; margin-top: 4px; font-size: 0.8rem; color: var(--text-secondary);">
                            Select a customer first to filter locations
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="booking-type">Booking Type *</label>
                            <select id="booking-type" required>
                                <option value="one_time">One Time</option>
                                <option value="recurring">Recurring</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status">
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <!-- 'scheduled' is set automatically when assigned to a route -->
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="no_show">No Show</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="scheduled-date">Date *</label>
                            <input type="date" id="scheduled-date" required>
                        </div>
                        <div class="form-group">
                            <label for="scheduled-start-time">Start Time</label>
                            <select id="scheduled-start-time">
                                <option value="">Select time...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="quoted-price">Quoted Price</label>
                            <input type="number" id="quoted-price" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label for="estimated-duration">Est. Duration (min)</label>
                            <input type="number" id="estimated-duration" min="1">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="special-instructions">Notes / Special Instructions</label>
                        <textarea id="special-instructions" rows="2"
                            placeholder="Gate codes, access details, etc."></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary close-modal-btn">Cancel</button>
                        <button type="submit" class="btn-primary">Save Booking</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Enhanced Import Wizard Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content import-wizard-modal"
            style="width: 85vw; max-width: 1400px; height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2>Import Bookings</h2>
                <span class="close-import-modal">&times;</span>
            </div>

            <!-- Stepper with Integrated Navigation -->
            <div style="padding: 20px 24px; border-bottom: 1px solid var(--border-color); flex-shrink: 0;">
                <!-- Step circles row -->
                <div class="import-stepper" style="display: flex; align-items: center; justify-content: center;">
                    <div class="stepper-step active" data-step="1">
                        <div class="stepper-circle">1</div>
                        <div class="stepper-label">Data Load</div>
                    </div>
                    <div class="stepper-line"></div>
                    <div class="stepper-step" data-step="2">
                        <div class="stepper-circle">2</div>
                        <div class="stepper-label">Mapping</div>
                    </div>
                    <div class="stepper-line"></div>
                    <div class="stepper-step" data-step="3">
                        <div class="stepper-circle">3</div>
                        <div class="stepper-label">Validation</div>
                    </div>
                    <div class="stepper-line"></div>
                    <div class="stepper-step" data-step="4">
                        <div class="stepper-circle">4</div>
                        <div class="stepper-label">Results</div>
                    </div>
                </div>

                <!-- Navigation row - same width as stepper steps -->
                <div
                    style="display: flex; align-items: center; justify-content: space-between; margin-top: 16px; max-width: 520px; margin-left: auto; margin-right: auto;">
                    <!-- Left side - Back button under Data Load -->
                    <div style="width: 80px;">
                        <button type="button" id="import-back-btn" class="import-nav-btn" style="display: none;">
                            ‚Üê Back
                        </button>
                    </div>
                    <!-- Right side - Cancel/Next under Results -->
                    <div style="display: flex; gap: 10px;">
                        <button type="button" id="import-cancel-btn" class="import-nav-btn">Cancel</button>
                        <button type="button" id="import-next-btn" class="import-nav-btn-primary" disabled>Next
                            ‚Üí</button>
                        <button type="button" id="import-load-data-btn" class="import-nav-btn-primary"
                            style="display: none;">Load Data</button>
                        <button type="button" id="import-done-btn" class="import-nav-btn-primary"
                            style="display: none;">Done</button>
                    </div>
                </div>
            </div>

            <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <div style="padding: 24px 48px; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                    <!-- Step 1: Data Load Source -->
                    <div id="import-step-1" class="import-step">
                        <!-- Centered container for compact layout -->
                        <div style="max-width: 500px; margin: 0 auto;">
                            <!-- Template Download Section -->
                            <div class="import-template-section"
                                style="margin-bottom: 20px; padding: 16px; background: rgba(88, 166, 255, 0.05); border: 1px solid rgba(88, 166, 255, 0.2); border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <svg width="24" height="24" fill="none" stroke="var(--accent-success)"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; color: var(--text-primary);">Need a template?
                                        </div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Download a CSV
                                            template
                                            with the required columns</div>
                                    </div>
                                    <button type="button" id="import-download-template-btn" class="import-nav-btn"
                                        style="white-space: nowrap;">
                                        <svg width="14" height="14" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 4px;">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                        </svg>
                                        Download Template
                                    </button>
                                </div>
                            </div>

                            <!-- File Upload Drop Zone -->
                            <div id="import-drop-zone" class="csv-drop-zone">
                                <div class="drop-zone-content">
                                    <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        style="margin: 0 auto; color: var(--text-secondary);">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                    </svg>
                                    <p style="margin: 16px 0 8px; font-size: 1rem; color: var(--text-primary);">Drag and
                                        drop
                                        your CSV file here</p>
                                    <p style="margin: 0 0 16px; font-size: 0.875rem; color: var(--text-secondary);">or
                                    </p>
                                    <button type="button" id="import-file-select-btn" class="import-nav-btn">Select
                                        File</button>
                                    <input type="file" id="import-file-input" accept=".csv" style="display: none;">
                                </div>
                                <div id="import-file-preview" class="file-preview" style="display: none;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <svg width="20" height="20" fill="none" stroke="var(--accent-success)"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                        </svg>
                                        <span id="import-file-name" style="font-weight: 500;"></span>
                                    </div>
                                    <button type="button" id="import-clear-file" class="btn-icon"
                                        style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.2rem;">‚úï</button>
                                </div>
                            </div>

                            <!-- Required Columns Info -->
                            <div
                                style="margin-top: 16px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 6px; font-size: 0.8rem; color: var(--text-secondary);">
                                <strong style="color: var(--text-primary);">Required columns:</strong> Booking #
                                (optional),
                                Customer Name, Service Name, Location Name, Date (YYYY-MM-DD)
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Data/Table Mapping -->
                <div id="import-step-2" class="import-step" style="display: none;">
                    <p style="margin-bottom: 16px; color: var(--text-secondary);">Map the columns from your CSV file
                        to
                        the system fields. Use "Do Not Load" to skip a column.</p>

                    <div class="table-container"
                        style="overflow-x: auto; border: 1px solid var(--border-subtle); border-radius: 8px;">
                        <table class="data-table mapping-table" id="import-mapping-table"
                            style="margin: 0; min-width: 100%;">
                            <thead>
                                <tr id="mapping-target-row" style="background: var(--bg-card);">
                                    <!-- Target column dropdowns populated dynamically -->
                                </tr>
                                <tr id="mapping-source-row" style="background: rgba(88, 166, 255, 0.05);">
                                    <!-- Source column names populated dynamically -->
                                </tr>
                            </thead>
                            <tbody id="mapping-preview-tbody">
                                <!-- Preview rows populated dynamically (first 5 rows) -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Step 3: Data Validation -->
                <div id="import-step-3" class="import-step" style="display: none;">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div>
                            <span id="validation-status-text" style="color: var(--text-secondary);">Validating
                                rows...</span>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" id="delete-selected-btn" class="btn-secondary"
                                style="padding: 6px 12px; font-size: 0.85rem; display: none;">
                                Delete Selected
                            </button>
                        </div>
                    </div>

                    <div class="table-scroll-container">
                        <table class="data-table validation-table" id="import-validation-table" style="margin: 0;">
                            <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 1;">
                                <tr>
                                    <th style="width: 30px;"><input type="checkbox" id="validation-select-all"></th>
                                    <th style="width: 30px;">Status</th>
                                    <th>Booking #</th>
                                    <th>Customer</th>
                                    <th>Service</th>
                                    <th>Location</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="import-validation-tbody">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top: 12px; font-size: 0.8rem; color: var(--text-secondary);">
                        <span style="color: #2ea043;">‚úì</span> Valid row &nbsp;&nbsp;
                        <span style="color: #f85149;">‚úï</span> Invalid row - click red cells to fix
                    </div>
                </div>

                <!-- Step 4: Results -->
                <div id="import-step-4" class="import-step" style="display: none;">
                    <div id="import-results-summary" style="display: flex; gap: 16px; margin-bottom: 20px;">
                        <div id="import-success-count"
                            style="flex: 1; padding: 16px; background: rgba(46, 160, 67, 0.1); border: 1px solid rgba(46, 160, 67, 0.3); border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 600; color: #2ea043;">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Imported</div>
                        </div>
                        <div id="import-skipped-count"
                            style="flex: 1; padding: 16px; background: rgba(248, 81, 73, 0.1); border: 1px solid rgba(248, 81, 73, 0.3); border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 600; color: #f85149;">0</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Skipped</div>
                        </div>
                    </div>

                    <div class="table-scroll-container">
                        <table class="data-table" id="import-results-table" style="margin: 0;">
                            <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 1;">
                                <tr>
                                    <th style="width: 40px;">Status</th>
                                    <th>Booking #</th>
                                    <th>Customer</th>
                                    <th>Service</th>
                                    <th>Location</th>
                                    <th>Date</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="import-results-tbody">
                                <!-- Populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Modal Styles -->
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--bg-card);
            margin: 5% auto;
            padding: 0;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 500px;
        }

        /* Action Buttons & Tooltips */


        button.action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 0 2px;
        }

        button.action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        button.action-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Tooltip */
        button.action-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.75rem;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-bottom: 8px;
            z-index: 100;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            font-weight: 500;
        }

        button.action-btn:hover::after {
            opacity: 1;
        }

        /* Tooltip Bottom Variant for Header */
        button.action-btn.tooltip-bottom::after {
            bottom: auto;
            top: 100%;
            margin-bottom: 0;
            margin-top: 8px;
        }



        @keyframes slideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close-modal {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: normal;
            cursor: pointer;
            line-height: 1;
        }

        .close-modal:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s;
            box-sizing: border-box;
            /* Fix for width: 100% overflowing */
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            background-color: rgba(64, 169, 255, 0.05);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 32px;
        }

        /* CSV Upload Modal Styles */
        .csv-drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            transition: all 0.2s;
            background: rgba(0, 0, 0, 0.2);
        }

        .csv-drop-zone.drag-over {
            border-color: var(--accent-primary);
            background: rgba(88, 166, 255, 0.05);
        }

        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .file-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(88, 166, 255, 0.1);
            border-radius: 6px;
            margin-top: 16px;
        }

        /* Close import modal button */
        .close-import-modal {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: normal;
            cursor: pointer;
            line-height: 1;
        }

        .close-import-modal:hover {
            color: var(--text-primary);
        }

        /* Spinner animation */
        .spinner-large {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(88, 166, 255, 0.2);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes toastFadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes toastFadeOut {
            from {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }

            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
        }

        /* Import modal status icons */
        .status-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .status-icon.success {
            background: rgba(46, 160, 67, 0.2);
            color: #2ea043;
        }

        .status-icon.error {
            background: rgba(248, 81, 73, 0.2);
            color: #f85149;
        }

        /* Import table row styling */
        #import-results-table td,
        #import-validation-table td {
            padding: 10px 8px;
            font-size: 0.85rem;
        }

        /* Stepper Component */
        .import-stepper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0;
        }

        .stepper-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .stepper-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s;
        }

        .stepper-step.active .stepper-circle {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .stepper-step.completed .stepper-circle {
            background: #2ea043;
            border-color: #2ea043;
            color: white;
        }

        .stepper-step.completed .stepper-circle::before {
            content: '‚úì';
        }

        .stepper-label {
            margin-top: 6px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .stepper-step.active .stepper-label {
            color: var(--text-primary);
            font-weight: 500;
        }

        .stepper-line {
            width: 60px;
            height: 2px;
            background: var(--border-color);
            margin: 0 12px 18px;
        }

        .stepper-step.completed+.stepper-line,
        .stepper-line.completed {
            background: #2ea043;
        }

        /* Import Wizard Navigation Buttons */
        .import-step {
            flex-direction: column;
            height: 100%;
        }

        .table-scroll-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
        }

        .import-nav-btn {
            padding: 8px 16px;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .import-nav-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        .import-nav-btn-primary {
            padding: 8px 16px;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--accent-primary);
            border: none;
            color: white;
        }

        .import-nav-btn-primary:hover:not(:disabled) {
            background: #4a9eff;
        }

        .import-nav-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Mapping Table */
        .mapping-table th,
        .mapping-table td {
            padding: 10px 8px;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .mapping-table select {
            width: 100%;
            padding: 6px 8px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.8rem;
            cursor: pointer;
        }

        .mapping-table select:focus {
            border-color: var(--accent-primary);
            outline: none;
        }

        /* Validation Table */
        .validation-table .cell-invalid {
            background: rgba(248, 81, 73, 0.15) !important;
            cursor: pointer;
            position: relative;
        }

        .validation-table .cell-invalid:hover {
            background: rgba(248, 81, 73, 0.25) !important;
        }

        .validation-table .cell-editable {
            cursor: pointer;
            transition: background 0.2s;
        }

        .validation-table .cell-editable:hover {
            background: rgba(88, 166, 255, 0.1);
        }

        .validation-table tr.row-valid {
            background: transparent;
        }

        .validation-table tr.row-invalid {
            background: rgba(248, 81, 73, 0.03);
        }

        /* Cell Edit Dropdown */
        .cell-edit-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 200px;
            max-height: 200px;
            overflow-y: auto;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 100;
        }

        .cell-edit-dropdown input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.2);
            border: none;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .cell-edit-dropdown input:focus {
            outline: none;
        }

        .cell-edit-dropdown .dropdown-options {
            max-height: 150px;
            overflow-y: auto;
        }

        .cell-edit-dropdown .dropdown-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .cell-edit-dropdown .dropdown-option:hover {
            background: rgba(88, 166, 255, 0.1);
        }

        /* Validation checkbox */
        .validation-table input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* Layout Fixes for Main Page Scrolling */
        html,
        body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        .app-container {
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
            padding-bottom: 0 !important;
            /* Move bottom spacing to footer or container */
        }

        .table-container {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            border-bottom: none !important;
            /* Remove border if handled by footer */
        }

        /* Ensure sticky header works on main table */
        .data-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bg-card);
            /* Ensure no transparency */
        }

        /* Pin Pagination Footer */
        .pagination-footer {
            flex-shrink: 0;
            background-color: var(--bg-card);
            border-top: 1px solid var(--border-color);
            z-index: 20;
        }
    </style>

    <script src="preload.js"></script>
    <script src="confirmation-modal.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Helper function to format dates without timezone conversion
            // Dates from DB are in YYYY-MM-DD format and should be displayed as-is
            function formatDateForDisplay(dateStr) {
                if (!dateStr) return 'N/A';

                // If it's a Date object, convert to ISO string first
                if (dateStr instanceof Date) {
                    dateStr = dateStr.toISOString().split('T')[0];
                }

                // Ensure it's a string
                if (typeof dateStr !== 'string') {
                    dateStr = String(dateStr);
                }

                // Parse YYYY-MM-DD format directly without timezone conversion
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    const month = parseInt(parts[1], 10);
                    const day = parseInt(parts[2], 10);
                    const year = parts[0];
                    return `${month}/${day}/${year}`;
                }
                return dateStr;
            }

            const bookingsTable = document.getElementById('bookings-table-body');
            const searchInput = document.getElementById('search-input');
            const addBookingBtn = document.getElementById('add-booking-btn');
            const modal = document.getElementById('add-booking-modal');
            const form = document.getElementById('booking-form');
            const modalTitle = document.getElementById('modal-title');
            const closeButtons = document.querySelectorAll('.close-modal, .close-modal-btn');

            let isEditing = false;
            let currentBookingId = null;
            let currentBookingNumber = null;
            let currentPage = 1;
            let limit = 10;
            let totalItems = 0;

            const rowsSelect = document.getElementById('rows-select');
            const prevPageBtn = document.getElementById('prev-page-btn');
            const nextPageBtn = document.getElementById('next-page-btn');
            const paginationInfo = document.getElementById('pagination-info');

            // --- Import Modal Elements ---
            const importModal = document.getElementById('import-modal');
            const importDropZone = document.getElementById('import-drop-zone');
            const importFileInput = document.getElementById('import-file-input');
            const importFileSelectBtn = document.getElementById('import-file-select-btn');
            const importFilePreview = document.getElementById('import-file-preview');
            const importFileName = document.getElementById('import-file-name');
            const importClearFileBtn = document.getElementById('import-clear-file');
            const importNextBtn = document.getElementById('import-next-btn');
            const importBackBtn = document.getElementById('import-back-btn');
            const importCancelBtn = document.getElementById('import-cancel-btn');
            const importDoneBtn = document.getElementById('import-done-btn');
            const closeImportModal = document.querySelector('.close-import-modal');

            // Wizard state
            let currentImportStep = 1;
            let selectedImportFile = null;
            let parsedCSVData = { headers: [], rows: [] };
            let columnMapping = {};
            let validatedRows = [];
            let importResults = { success: [], skipped: [] };
            let cachedCustomers = [];
            let cachedServices = [];
            let cachedLocations = [];
            let cachedBookingNumbers = [];

            // Bulk Delete State
            let selectedBookingIds = new Set();

            function updateBulkActionsUI() {
                const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
                const bulkStatusBtn = document.getElementById('bulk-status-btn');
                const bulkStatusDropdown = document.getElementById('bulk-status-dropdown');
                if (selectedBookingIds.size > 0) {
                    bulkDeleteBtn.style.display = 'inline-flex';
                    bulkStatusBtn.style.display = 'inline-flex';
                } else {
                    bulkDeleteBtn.style.display = 'none';
                    bulkStatusBtn.style.display = 'none';
                    bulkStatusDropdown.style.display = 'none';
                }
            }

            // Alias for backward compatibility
            function updateBulkDeleteUI() {
                updateBulkActionsUI();
            }

            // Initialize Bulk Delete Button Listener
            const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
            if (bulkDeleteBtn) {
                bulkDeleteBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    console.log('Bulk delete clicked', selectedBookingIds.size); // Debug log

                    if (selectedBookingIds.size === 0) return;

                    if (await showConfirm(`Are you sure you want to delete ${selectedBookingIds.size} selected booking(s)?`, 'Bulk Delete', 'Delete', 'Cancel')) {
                        try {
                            const idsToDelete = Array.from(selectedBookingIds);
                            // Delete sequentially for now to avoid race conditions or backend overload
                            for (const id of idsToDelete) {
                                await window.electronAPI.bookings.delete(id);
                            }
                            selectedBookingIds.clear();
                            updateBulkDeleteUI();
                            loadBookings();
                        } catch (error) {
                            console.error('Bulk delete failed:', error);
                            alert('Failed to delete some bookings: ' + error.message);
                            loadBookings();
                        }
                    }
                });
            }

            // Initialize Bulk Status Change Button Listener
            const bulkStatusBtn = document.getElementById('bulk-status-btn');
            const bulkStatusDropdown = document.getElementById('bulk-status-dropdown');

            if (bulkStatusBtn && bulkStatusDropdown) {
                // Toggle dropdown on button click
                bulkStatusBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const isVisible = bulkStatusDropdown.style.display === 'block';
                    bulkStatusDropdown.style.display = isVisible ? 'none' : 'block';
                });

                // Handle status option clicks
                document.querySelectorAll('.bulk-status-option').forEach(option => {
                    option.addEventListener('click', async (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        const newStatus = option.dataset.status;
                        const count = selectedBookingIds.size;

                        if (count === 0) return;

                        if (await showConfirm(`Change status to "${newStatus}" for ${count} selected booking(s)?`, 'Bulk Status Change', 'Confirm', 'Cancel')) {
                            bulkStatusDropdown.style.display = 'none';

                            try {
                                const idsToUpdate = Array.from(selectedBookingIds);
                                let successCount = 0;
                                let failCount = 0;

                                for (const id of idsToUpdate) {
                                    try {
                                        await window.electronAPI.bookings.update({ id, status: newStatus });
                                        successCount++;
                                    } catch (err) {
                                        console.error(`Failed to update booking ${id}:`, err);
                                        failCount++;
                                    }
                                }

                                selectedBookingIds.clear();
                                updateBulkActionsUI();
                                loadBookings();

                                if (failCount > 0) {
                                    alert(`Updated ${successCount} booking(s). ${failCount} failed.`);
                                }
                            } catch (error) {
                                console.error('Bulk status update failed:', error);
                                alert('Failed to update bookings: ' + error.message);
                                loadBookings();
                            }
                        }
                    });

                    // Hover effect
                    option.addEventListener('mouseenter', () => {
                        option.style.background = 'rgba(255,255,255,0.1)';
                    });
                    option.addEventListener('mouseleave', () => {
                        option.style.background = 'transparent';
                    });
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!bulkStatusBtn.contains(e.target) && !bulkStatusDropdown.contains(e.target)) {
                        bulkStatusDropdown.style.display = 'none';
                    }
                });
            }

            // --- Filter UI Elements ---
            const filterDateFrom = document.getElementById('filter-date-from');
            const filterDateTo = document.getElementById('filter-date-to');
            const filterClient = document.getElementById('filter-client');
            const filterVehicle = document.getElementById('filter-vehicle');
            const filterRoute = document.getElementById('filter-route');
            const filterStatus = document.getElementById('filter-status');
            const clearFiltersBtn = document.getElementById('clear-filters-btn');

            // Populate time select with 15-minute intervals
            const timeSelect = document.getElementById('scheduled-start-time');
            for (let hour = 6; hour <= 20; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    const h = hour.toString().padStart(2, '0');
                    const m = minute.toString().padStart(2, '0');
                    const value = `${h}:${m}`;
                    const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
                    const ampm = hour >= 12 ? 'PM' : 'AM';
                    const label = `${displayHour}:${m} ${ampm}`;
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = label;
                    timeSelect.appendChild(option);
                }
            }

            // --- Helper: Update Status Options Based on Current Status ---
            // Allowed status transitions:
            // - pending: confirmed, cancelled
            // - confirmed: cancelled, no_show
            // - scheduled: cancelled, no_show (with confirmation warning - handled in form submit)
            // - in_progress: completed, cancelled
            // - completed: (no changes allowed - final state)
            // - cancelled: (no changes allowed - final state)
            let originalBookingStatus = null; // Store original status for comparison

            function updateStatusOptions(selectElement, currentStatus) {
                const allStatuses = {
                    pending: 'Pending',
                    confirmed: 'Confirmed',
                    scheduled: 'Scheduled',
                    in_progress: 'In Progress',
                    completed: 'Completed',
                    cancelled: 'Cancelled',
                    no_show: 'No Show'
                };

                // Define allowed transitions from each status
                const allowedTransitions = {
                    pending: ['pending', 'confirmed', 'cancelled'],
                    confirmed: ['confirmed', 'cancelled', 'no_show'],
                    scheduled: ['scheduled', 'cancelled', 'no_show'], // Warning shown on cancel
                    in_progress: ['in_progress', 'completed', 'cancelled'],
                    completed: ['completed'], // Final state
                    cancelled: ['cancelled'], // Final state
                    no_show: ['no_show'], // Final state
                };

                const allowed = allowedTransitions[currentStatus] || [currentStatus];

                // Clear existing options
                selectElement.innerHTML = '';

                // Add allowed options
                allowed.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = allStatuses[status] || status;
                    selectElement.appendChild(option);
                });

                // Store original status for form submit comparison
                originalBookingStatus = currentStatus;
            }

            // --- Initialization ---
            initialize();

            async function initialize() {
                await populateFilters();
                loadBookings();
            }

            async function populateFilters() {
                try {
                    // Load Clients
                    const clientsRes = await window.electronAPI.clients.getAll();
                    // Handle wrapped response
                    const clients = clientsRes.data && Array.isArray(clientsRes.data.data)
                        ? clientsRes.data.data
                        : (Array.isArray(clientsRes.data) ? clientsRes.data : []);

                    clients.sort((a, b) => a.name.localeCompare(b.name));

                    clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.name;
                        filterClient.appendChild(option);
                    });

                    // Load Vehicles
                    const vehiclesRes = await window.electronAPI.vehicles.getAll();
                    const vehicles = vehiclesRes.data || [];

                    vehicles.sort((a, b) => a.name.localeCompare(b.name));

                    vehicles.forEach(vehicle => {
                        const option = document.createElement('option');
                        option.value = vehicle.id;
                        option.textContent = vehicle.name;
                        filterVehicle.appendChild(option);
                    });

                    // Load Routes
                    const routesRes = await window.electronAPI.routes.getAll();
                    const routes = (routesRes.data?.data || routesRes.data || []);

                    routes.sort((a, b) => (a.routeName || '').localeCompare(b.routeName || ''));

                    routes.forEach(route => {
                        const option = document.createElement('option');
                        option.value = route.id;
                        option.textContent = route.routeCode || route.routeName || route.id;
                        filterRoute.appendChild(option);
                    });
                } catch (error) {
                    console.error('Failed to populate filters:', error);
                }
            }

            // --- Event Listeners ---
            addBookingBtn.addEventListener('click', () => openModal());

            closeButtons.forEach(btn => {
                btn.addEventListener('click', closeModal);
            });

            form.addEventListener('submit', handleFormSubmit);

            // Check Import Button Visibility setting
            (async () => {
                try {
                    const settings = await window.electronAPI.settings.getAll();
                    const importBtn = document.getElementById('import-btn');
                    if (importBtn && settings) {
                        // Default to true if not set
                        const showImport = settings['data.enableImportBookings'] !== false;
                        importBtn.style.display = showImport ? 'inline-flex' : 'none';
                    }
                } catch (error) {
                    console.error('Failed to load settings:', error);
                }
            })();

            // Filter Change Listeners
            [filterDateFrom, filterDateTo, filterClient, filterVehicle, filterRoute, filterStatus].forEach(el => {
                if (el) {
                    el.addEventListener('change', () => {
                        currentPage = 1;
                        loadBookings();
                    });
                }
            });

            if (clearFiltersBtn) {
                clearFiltersBtn.addEventListener('click', () => {
                    filterDateFrom.value = '';
                    filterDateTo.value = '';
                    filterClient.value = '';
                    filterVehicle.value = '';
                    filterRoute.value = '';
                    filterStatus.value = '';
                    searchInput.value = '';
                    currentPage = 1;
                    loadBookings();
                });
            }

            // Search functionality with debounce
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    loadBookings(); // Uses current input value
                }, 300);
            });

            // Sorting State
            let currentSortBy = 'scheduled_date';
            let currentSortOrder = 'asc';

            const dateTimeHeader = document.querySelector('th:nth-child(5)'); // Date & Time column
            if (dateTimeHeader) {
                dateTimeHeader.style.cursor = 'pointer';
                dateTimeHeader.title = 'Click to sort by Date & Time';
                dateTimeHeader.innerHTML = 'Date & Time <span id="sort-indicator" style="font-size: 0.8em; margin-left: 4px;">‚ñ≤</span>';

                dateTimeHeader.addEventListener('click', () => {
                    if (currentSortBy === 'scheduled_date') {
                        currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentSortBy = 'scheduled_date';
                        currentSortOrder = 'asc';
                    }
                    updateSortIndicator();
                    loadBookings();
                });
            }

            function updateSortIndicator() {
                const indicator = document.getElementById('sort-indicator');
                if (indicator) {
                    indicator.textContent = currentSortBy === 'scheduled_date'
                        ? (currentSortOrder === 'asc' ? '‚ñ≤' : '‚ñº')
                        : '';
                }
            }

            // Pagination Listeners
            rowsSelect.addEventListener('change', (e) => {
                limit = parseInt(e.target.value);
                currentPage = 1;
                loadBookings();
            });

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadBookings();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(totalItems / limit);
                if (currentPage < totalPages) {
                    currentPage++;
                    loadBookings();
                }
            });

            async function loadBookings(searchTermOverride = null) {
                try {
                    // Use override if provided (legacy support), otherwise read input
                    const term = searchTermOverride !== null ? searchTermOverride : (searchInput ? searchInput.value : '');

                    // Gather filters from UI
                    const filters = {
                        searchTerm: term,
                        scheduledDateFrom: filterDateFrom.value || undefined,
                        scheduledDateTo: filterDateTo.value || undefined,
                        clientId: filterClient.value || undefined,
                        vehicleId: filterVehicle.value || undefined,
                        routeId: filterRoute.value || undefined,
                        status: filterStatus.value || undefined
                    };

                    console.log(`Requesting bookings... Page: ${currentPage}, Limit: ${limit}`, filters, `Sort: ${currentSortBy} (${currentSortOrder})`);
                    const pagination = {
                        page: currentPage,
                        limit,
                        sortBy: currentSortBy,
                        sortOrder: currentSortOrder
                    };

                    const response = await window.electronAPI.bookings.getAll(filters, pagination);

                    // Handle PaginatedResponse
                    let bookings = [];
                    if (response.pagination) {
                        bookings = response.data;
                        const meta = response.pagination;
                        totalItems = meta.total;
                        updatePaginationControls(meta);
                    } else if (response.data && Array.isArray(response.data)) {
                        bookings = response.data;
                        totalItems = bookings.length;
                    } else if (Array.isArray(response)) {
                        bookings = response;
                        totalItems = bookings.length;
                    }

                    // Update pagination info if no metadata returned (legacy fallback)
                    if (!response.pagination) {
                        // Simple client-side pagination display if server doesn't return meta
                        const totalPages = Math.ceil(totalItems / limit);
                        updatePaginationControls({ page: currentPage, limit, total: totalItems, totalPages });
                    }

                    renderTable(bookings);
                } catch (error) {
                    console.error('Error loading bookings:', error);
                    bookingsTable.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: var(--text-error, red);">Error loading bookings: ' + error.message + '</td></tr>';
                }
            }

            function updatePaginationControls(meta) {
                const { page, limit, total, totalPages } = meta;
                const start = total === 0 ? 0 : (page - 1) * limit + 1;
                const end = Math.min(page * limit, total);

                paginationInfo.textContent = `${start}-${end} of ${total}`;
                prevPageBtn.disabled = page <= 1;
                nextPageBtn.disabled = page >= totalPages;
            }

            function renderTable(bookings) {
                bookingsTable.innerHTML = '';

                if (!bookings || bookings.length === 0) {
                    bookingsTable.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: var(--text-secondary);">No bookings found</td></tr>';
                    return;
                }

                bookings.forEach(booking => {
                    const row = document.createElement('tr');

                    const priceDisplay = new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD'
                    }).format(booking.quotedPrice || 0);

                    // Badge logic
                    let badgeClass = 'inactive';
                    if (['confirmed', 'scheduled', 'in_progress', 'completed'].includes(booking.status)) badgeClass = 'active';
                    if (['cancelled', 'no_show'].includes(booking.status)) badgeClass = 'suspended';

                    let statusStyle = '';
                    if (booking.status === 'in_progress') statusStyle = 'color: #58a6ff; border-color: rgba(88,166,255,0.2); background-color: rgba(88,166,255,0.15);';

                    // Location display
                    const locationDisplay = booking.locationName || '-';

                    row.innerHTML = `
                        <td>
                            <div style="font-family: monospace; font-weight: 600;">${booking.bookingNumber || 'N/A'}</div>
                        </td>
                        <td>${booking.clientName || 'Unknown Client'}</td>
                        <td>
                            <div><strong>${(booking.serviceItems && booking.serviceItems.length > 0) ? booking.serviceItems[0].name : (booking.serviceName || 'Unknown Service')}</strong>${(booking.serviceItems && booking.serviceItems.length > 1) ? ' <span style="font-size:0.8em; color:var(--text-secondary);">+' + (booking.serviceItems.length - 1) + ' more</span>' : ''}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); text-transform: capitalize;">${(booking.bookingType || '').replace('_', ' ')}</div>
                        </td>
                        <td>
                            <div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${locationDisplay}">${locationDisplay}</div>
                        </td>
                        <td>
                            <div>${formatDateForDisplay(booking.scheduledDate)}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${booking.scheduledStartTime ? booking.scheduledStartTime.substring(0, 5) : ''}</div>
                        </td>
                        <td>${booking.status === 'scheduled' && booking.routeId ? `<span class="status-badge ${badgeClass}" style="${statusStyle}; cursor: pointer;" data-tooltip="Route: ${booking.routeCode || booking.routeId}" onclick="window.location.href='routes.html?routeId=${booking.routeId}'">${booking.status}</span>` : `<span class="status-badge ${badgeClass}" style="${statusStyle}">${booking.status}</span>`}</td>
                        <td>${priceDisplay}</td>
                        <td>
                            <div style="display: flex; align-items: center; justify-content: flex-end; gap: 4px;">
                                <button class="action-btn edit-btn" data-id="${booking.id}" data-tooltip="Edit Booking">
                                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <input type="checkbox" class="booking-checkbox" data-id="${booking.id}" 
                                    style="cursor: pointer; width: 16px; height: 16px; accent-color: var(--accent-primary);"
                                    ${selectedBookingIds.has(booking.id) ? 'checked' : ''}>
                            </div>
                        </td>
                    `;

                    bookingsTable.appendChild(row);
                });

                // Attach event listeners to buttons
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        openEditModal(id);
                    });
                });

                // Attach event listeners to checkboxes
                document.querySelectorAll('.booking-checkbox').forEach(chk => {
                    chk.addEventListener('change', (e) => {
                        const id = e.target.dataset.id;
                        if (e.target.checked) {
                            selectedBookingIds.add(id);
                        } else {
                            selectedBookingIds.delete(id);
                        }
                        updateBulkDeleteUI();
                    });
                });
            }

            const clientSearchInput = document.getElementById('client-search');
            const clientIdInput = document.getElementById('client-id');
            const clientSearchResults = document.getElementById('client-search-results');
            const selectedClientDisplay = document.getElementById('selected-client-display');
            const selectedClientName = document.getElementById('selected-client-name');
            const clearClientBtn = document.getElementById('clear-client-btn');

            const serviceSearchInput = document.getElementById('service-search');
            const serviceSearchResults = document.getElementById('service-search-results');
            // Multi-Service State
            let selectedServices = []; // Array of { id, name, quantity, unitPrice, total, duration }

            // Elements for totals
            const totalEstimatedTimeDisplay = document.getElementById('total-estimated-time-display');
            const totalListPriceDisplay = document.getElementById('total-list-price-display');
            const selectedServicesTbody = document.getElementById('selected-services-tbody');

            const locationSearchInput = document.getElementById('location-search');
            const locationIdInput = document.getElementById('location-id');
            const locationSearchResults = document.getElementById('location-search-results');
            const selectedLocationDisplay = document.getElementById('selected-location-display');
            const selectedLocationName = document.getElementById('selected-location-name');
            const selectedLocationAddress = document.getElementById('selected-location-address');
            const clearLocationBtn = document.getElementById('clear-location-btn');
            const locationClientHint = document.getElementById('location-client-hint');

            // --- Service Search Logic ---
            let serviceSearchTimeout;
            serviceSearchInput.addEventListener('input', (e) => {
                clearTimeout(serviceSearchTimeout);
                const term = e.target.value.trim();

                if (term.length < 2) {
                    serviceSearchResults.style.display = 'none';
                    return;
                }

                serviceSearchTimeout = setTimeout(async () => {
                    try {
                        const result = await window.electronAPI.services.getAll({ searchTerm: term, limit: 10 });
                        const services = result.data.data || result.data || [];
                        renderServiceResults(services);
                    } catch (err) {
                        console.error('Service search failed', err);
                    }
                }, 300);
            });

            function renderServiceResults(services) {
                serviceSearchResults.innerHTML = '';
                if (services.length === 0) {
                    const div = document.createElement('div');
                    div.style.padding = '8px 12px';
                    div.style.color = 'var(--text-secondary)';
                    div.textContent = 'No services found';
                    serviceSearchResults.appendChild(div);
                } else {
                    services.forEach(service => {
                        const div = document.createElement('div');
                        div.style.padding = '8px 12px';
                        div.style.cursor = 'pointer';
                        div.style.borderBottom = '1px solid var(--border-subtle)';
                        div.innerHTML = `<div style="font-weight:500">${service.name}</div><div style="font-size:0.8rem; color:var(--text-secondary)">$${Number(service.price || service.basePrice || 0).toFixed(2)} | ${service.averageDurationMinutes || service.durationMinutes || service.avgDurationMinutes || 0} min</div>`;
                        div.addEventListener('mouseover', () => div.style.backgroundColor = 'rgba(255,255,255,0.05)');
                        div.addEventListener('mouseout', () => div.style.backgroundColor = 'transparent');
                        div.addEventListener('click', () => {
                            addService(service);
                        });
                        serviceSearchResults.appendChild(div);
                    });
                }
                serviceSearchResults.style.display = 'block';
            }

            function addService(service) {
                // Check if already added
                const existing = selectedServices.find(s => s.id === service.id);
                if (existing) {
                    existing.quantity++;
                } else {
                    selectedServices.push({
                        id: service.id,
                        name: service.name,
                        quantity: 1,
                        unitPrice: Number(service.price || service.basePrice || 0),
                        duration: Number(service.averageDurationMinutes || service.durationMinutes || service.avgDurationMinutes || 0),
                    });
                }

                renderServicesTable();
                calculateTotals(true);

                // Clear search
                serviceSearchInput.value = '';
                serviceSearchResults.style.display = 'none';
            }

            function removeService(index) {
                selectedServices.splice(index, 1);
                renderServicesTable();
                calculateTotals(true);
            }

            function updateServiceQuantity(index, newQty) {
                const qty = parseInt(newQty);
                if (qty > 0) {
                    selectedServices[index].quantity = qty;
                    renderServicesTable(); // Re-render to update totals in row
                    calculateTotals(true);
                }
            }

            function updateServicePrice(index, newPrice) {
                const price = parseFloat(newPrice);
                if (!isNaN(price) && price >= 0) {
                    selectedServices[index].unitPrice = price;
                    renderServicesTable(); // Re-render to update totals in row
                    calculateTotals(true);
                }
            }

            function renderServicesTable() {
                selectedServicesTbody.innerHTML = '';

                if (selectedServices.length === 0) {
                    selectedServicesTbody.innerHTML = `
                        <tr id="no-services-row">
                            <td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 12px;">No services added</td>
                        </tr>
                    `;
                    return;
                }

                selectedServices.forEach((item, index) => {
                    const row = document.createElement('tr');
                    const rowTotal = item.quantity * item.unitPrice;

                    row.innerHTML = `
                        <td style="padding: 8px;">${item.name}</td>
                        <td style="padding: 8px;">
                            <input type="number" class="form-input qty-input" value="${item.quantity}" min="1" 
                                style="width: 50px; padding: 4px;" data-index="${index}">
                        </td>
                        <td style="padding: 8px;">
                            <input type="number" class="form-input price-input" value="${item.unitPrice.toFixed(2)}" min="0" step="0.01" 
                                style="width: 70px; padding: 4px;" data-index="${index}">
                        </td>
                        <td style="padding: 8px;">$${rowTotal.toFixed(2)}</td>
                        <td style="padding: 8px; text-align: right;">
                            <button type="button" class="btn-icon remove-service-btn" data-index="${index}" style="color: var(--text-danger); background: none; border: none; cursor: pointer;">‚úï</button>
                        </td>
                    `;
                    selectedServicesTbody.appendChild(row);
                });

                // Attach listeners
                document.querySelectorAll('.qty-input').forEach(input => {
                    input.addEventListener('change', (e) => updateServiceQuantity(e.target.dataset.index, e.target.value));
                });
                document.querySelectorAll('.price-input').forEach(input => {
                    input.addEventListener('change', (e) => updateServicePrice(e.target.dataset.index, e.target.value));
                });
                document.querySelectorAll('.remove-service-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => removeService(e.target.dataset.index));
                });
            }

            function calculateTotals(updateQuotedPrice = false) {
                let totalTime = 0;
                let totalPrice = 0;

                selectedServices.forEach(item => {
                    totalTime += (item.quantity * item.duration);
                    totalPrice += (item.quantity * item.unitPrice);
                });

                totalEstimatedTimeDisplay.textContent = `${totalTime} min`;
                totalListPriceDisplay.textContent = `$${totalPrice.toFixed(2)}`;

                // Auto-update form fields
                const durationInput = document.getElementById('estimated-duration');
                const priceInput = document.getElementById('quoted-price');

                // Always auto-update duration as it's purely calculated (unless user wants to pad it manually? let's stick to auto for now or only if empty)
                // For better UX, let's update it if the user hasn't manually edited it away from the previous calculation.
                // Simpler: Just update it. User can edit it *after* adding services if they want padding.
                durationInput.value = totalTime;

                // For quoted price, update if it is empty, 0, OR if we are explicitly updating (user added/removed service)
                if (updateQuotedPrice || !priceInput.value || parseFloat(priceInput.value) === 0) {
                    priceInput.value = totalPrice.toFixed(2);
                }
            }


            // --- Client Search Logic ---
            let clientSearchTimeout;
            clientSearchInput.addEventListener('input', (e) => {
                clearTimeout(clientSearchTimeout);
                const term = e.target.value.trim();

                if (term.length < 2) {
                    clientSearchResults.style.display = 'none';
                    return;
                }

                clientSearchTimeout = setTimeout(async () => {
                    try {
                        const result = await window.electronAPI.clients.getAll({ searchTerm: term, limit: 5 });
                        const clients = result.data.data || result.data || [];
                        renderClientResults(clients);
                    } catch (err) {
                        console.error('Client search failed', err);
                    }
                }, 300);
            });

            function renderClientResults(clients) {
                clientSearchResults.innerHTML = '';
                if (clients.length === 0) {
                    const div = document.createElement('div');
                    div.style.padding = '8px 12px';
                    div.style.color = 'var(--text-secondary)';
                    div.textContent = 'No clients found';
                    clientSearchResults.appendChild(div);
                } else {
                    clients.forEach(client => {
                        const div = document.createElement('div');
                        div.style.padding = '8px 12px';
                        div.style.cursor = 'pointer';
                        div.style.borderBottom = '1px solid var(--border-subtle)';
                        div.innerHTML = `<div style="font-weight:500">${client.name}</div><div style="font-size:0.8rem; color:var(--text-secondary)">${client.email || ''}</div>`;
                        div.addEventListener('mouseover', () => div.style.backgroundColor = 'rgba(255,255,255,0.05)');
                        div.addEventListener('mouseout', () => div.style.backgroundColor = 'transparent');
                        div.addEventListener('click', () => {
                            selectClient(client);
                        });
                        clientSearchResults.appendChild(div);
                    });
                }
                clientSearchResults.style.display = 'block';
            }

            function selectClient(client) {
                clientIdInput.value = client.id;
                selectedClientName.textContent = client.name;
                clientSearchInput.style.display = 'none';
                clientSearchResults.style.display = 'none';
                selectedClientDisplay.style.display = 'flex';

                // Show hint for location if no location selected yet
                if (!locationIdInput.value) {
                    locationClientHint.style.display = 'block';
                }
            }

            clearClientBtn.addEventListener('click', () => {
                clientIdInput.value = '';
                selectedClientDisplay.style.display = 'none';
                clientSearchInput.style.display = 'block';
                clientSearchInput.value = '';
                clientSearchInput.focus();

                // Clear location as well since it might be client-specific
                // Or at least hide the hint
                locationClientHint.style.display = 'none';
            });

            // --- Location Search Logic ---
            let locationSearchTimeout;
            locationSearchInput.addEventListener('input', (e) => {
                clearTimeout(locationSearchTimeout);
                const term = e.target.value.trim();

                if (term.length < 2) {
                    locationSearchResults.style.display = 'none';
                    return;
                }

                locationSearchTimeout = setTimeout(async () => {
                    try {
                        // Filter locations by client if selected
                        const filters = { searchTerm: term, limit: 5 };
                        if (clientIdInput.value) {
                            filters.clientId = clientIdInput.value;
                        }

                        const result = await window.electronAPI.locations.getAll(filters);
                        const locations = result.data.data || result.data || [];
                        renderLocationResults(locations);
                    } catch (err) {
                        console.error('Location search failed', err);
                    }
                }, 300);
            });

            function renderLocationResults(locations) {
                locationSearchResults.innerHTML = '';
                if (locations.length === 0) {
                    const div = document.createElement('div');
                    div.style.padding = '8px 12px';
                    div.style.color = 'var(--text-secondary)';
                    div.textContent = 'No locations found';
                    locationSearchResults.appendChild(div);
                } else {
                    locations.forEach(location => {
                        const div = document.createElement('div');
                        div.style.padding = '8px 12px';
                        div.style.cursor = 'pointer';
                        div.style.borderBottom = '1px solid var(--border-subtle)';
                        div.innerHTML = `
                            <div style="font-weight:500">${location.name}</div>
                            <div style="font-size:0.8rem; color:var(--text-secondary)">${location.addressLine1}, ${location.city}</div>
                        `;
                        div.addEventListener('mouseover', () => div.style.backgroundColor = 'rgba(255,255,255,0.05)');
                        div.addEventListener('mouseout', () => div.style.backgroundColor = 'transparent');
                        div.addEventListener('click', () => {
                            selectLocation(location);
                        });
                        locationSearchResults.appendChild(div);
                    });
                }
                locationSearchResults.style.display = 'block';
            }

            function selectLocation(location) {
                locationIdInput.value = location.id;
                selectedLocationName.textContent = location.name;
                selectedLocationAddress.textContent = `${location.addressLine1}, ${location.city}`;
                locationSearchInput.style.display = 'none';
                locationSearchResults.style.display = 'none';
                selectedLocationDisplay.style.display = 'flex';
                locationClientHint.style.display = 'none';
            }

            clearLocationBtn.addEventListener('click', () => {
                locationIdInput.value = '';
                selectedLocationDisplay.style.display = 'none';
                locationSearchInput.style.display = 'block';
                locationSearchInput.value = '';
                locationSearchInput.focus();
                if (clientIdInput.value) {
                    locationClientHint.style.display = 'block';
                }
            });


            async function openEditModal(id) {
                try {
                    const response = await window.electronAPI.bookings.getById(id);
                    const booking = response.data || response;

                    if (!booking) throw new Error('Booking not found');
                    currentBookingId = booking.id;
                    currentBookingNumber = booking.bookingNumber || null;

                    // Populate simple fields
                    let dateValue = '';
                    if (booking.scheduledDate) {
                        if (typeof booking.scheduledDate === 'string') {
                            dateValue = booking.scheduledDate.substring(0, 10);
                        } else if (booking.scheduledDate instanceof Date) {
                            dateValue = booking.scheduledDate.toISOString().split('T')[0];
                        }
                    }
                    document.getElementById('scheduled-date').value = dateValue;
                    document.getElementById('scheduled-start-time').value = booking.scheduledStartTime || '';
                    document.getElementById('booking-type').value = booking.bookingType || 'one_time';

                    // Update status dropdown based on current status
                    const statusSelect = document.getElementById('status');
                    const currentStatus = booking.status || 'pending';
                    updateStatusOptions(statusSelect, currentStatus);
                    statusSelect.value = currentStatus;

                    document.getElementById('quoted-price').value = booking.quotedPrice || '';
                    document.getElementById('estimated-duration').value = booking.estimatedDurationMinutes || '';
                    const notesField = document.getElementById('special-instructions');
                    if (notesField) notesField.value = booking.specialInstructions || '';

                    // Populate Client
                    if (booking.clientId) {
                        if (booking.clientName) {
                            selectClient({ id: booking.clientId, name: booking.clientName, email: booking.clientEmail });
                        } else {
                            try {
                                const clientData = await window.electronAPI.clients.getById(booking.clientId);
                                const client = clientData.data || clientData;
                                selectClient({ id: booking.clientId, name: client.name || 'Unknown Client' });
                            } catch (e) {
                                console.error('Failed to fetch client details', e);
                                selectClient({ id: booking.clientId, name: 'Unknown Client' });
                            }
                        }
                    } else {
                        clearClientBtn.click();
                    }

                    // Populate Services (Multi-service)
                    selectedServices = []; // Clear existing
                    if (booking.serviceItems && booking.serviceItems.length > 0) {
                        // Use stored service items
                        // We need names for display. serviceItems might have normalized data.
                        // Assuming booking.serviceItems has structure from updated backend query
                        booking.serviceItems.forEach(item => {
                            selectedServices.push({
                                id: item.serviceId,
                                name: item.name || item.serviceName || item.service?.name || 'Unknown Service',
                                quantity: item.quantity,
                                unitPrice: item.unitPrice,
                                duration: Number(item.duration || 0)
                                // Actually, for calculation, we need duration. 
                                // If duration is not in item, we might need to fetch service details?
                                // Optimization: If backend returns joined service details in items.
                            });
                        });
                        // Fetch missing details (names/durations) if needed?
                        // For MVP, if names are missing, we might need to fetch. 
                        // But let's assume getById returns joined data or we accept basic display.
                    } else if (booking.serviceId) {
                        // Legacy single service fallback
                        try {
                            const serviceData = await window.electronAPI.services.getById(booking.serviceId);
                            const service = serviceData.data || serviceData;
                            addService({
                                ...service,
                                price: booking.quotedPrice // Treat quoted as unit price for legacy? Or just base.
                            });
                            // Reset quantity to 1 if addService incremented it (it shouldn't have since array was empty)
                        } catch (e) {
                            console.error('Failed to fetch legacy service details', e);
                        }
                    } else {
                        // No services
                    }
                    renderServicesTable();
                    calculateTotals();


                    // Populate Location
                    if (booking.locationId) {
                        try {
                            if (booking.locationName) {
                                selectLocation({
                                    id: booking.locationId,
                                    name: booking.locationName,
                                    addressLine1: booking.locationAddressLine1 || '',
                                    city: booking.locationCity || '',
                                    state: booking.locationState || ''
                                });
                            } else {
                                const locData = await window.electronAPI.locations.getById(booking.locationId);
                                const loc = locData.data || locData;
                                selectLocation(loc);
                            }
                        } catch (e) {
                            console.error('Failed to fetch location details', e);
                            selectLocation({ id: booking.locationId, name: 'Unknown Location', addressLine1: '' });
                        }
                    } else {
                        clearLocationBtn.click();
                    }

                    openModal(true);
                } catch (error) {
                    console.error('Failed to open edit modal:', error);
                    alert('Failed to load booking details: ' + error.message);
                }
            }

            function openModal(isEdit = false) {
                modal.style.display = 'block';
                modalTitle.textContent = isEdit ? 'Edit Booking' : 'Add New Booking';
                isEditing = isEdit;

                // Show/hide booking ID display
                const bookingIdDisplay = document.getElementById('booking-id-display');
                const bookingIdText = document.getElementById('booking-id-text');
                if (isEdit && currentBookingNumber) {
                    bookingIdDisplay.style.display = 'block';
                    bookingIdText.textContent = currentBookingNumber;
                } else {
                    bookingIdDisplay.style.display = 'none';
                    bookingIdText.textContent = '';
                }

                if (!isEdit) {
                    // Reset for new booking
                    form.reset();
                    currentBookingId = null;
                    originalBookingStatus = null;

                    // Clear custom inputs
                    clientIdInput.value = '';
                    selectedClientDisplay.style.display = 'none';
                    clientSearchInput.style.display = 'block';

                    locationIdInput.value = '';
                    selectedLocationDisplay.style.display = 'none';
                    locationSearchInput.style.display = 'block';
                    locationClientHint.style.display = 'none'; // Re-hide hint

                    selectedServices = [];
                    renderServicesTable();
                    calculateTotals();

                    // Set default date
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('scheduled-date').value = today;

                    // Update status options for new booking (default: pending)
                    const statusSelect = document.getElementById('status');
                    updateStatusOptions(statusSelect, 'pending');
                    statusSelect.value = 'pending';
                }
            }

            function closeModal() {
                if (modal) modal.style.display = 'none';
                if (form && !isEditing) {
                    form.reset();
                    clearClientBtn.click();
                    // clearServiceBtn.click(); // Function removed
                    selectedServices = [];
                    renderServicesTable();
                    calculateTotals();
                    clearLocationBtn.click();
                }
                isEditing = false;
                currentBookingId = null;
            }

            /**
             * Show a modal when a route was invalidated due to booking changes
             */
            async function showRouteInvalidationModal(routeId, scheduledDate) {
                const proceed = await showConfirm(
                    'The booking you just edited is part of a route. ' +
                    'This route now needs to be recalculated to reflect the changes.\n\n' +
                    'Would you like to re-plan this route now?',
                    'Route Needs Recalculation',
                    'Re-plan Now',
                    'Re-plan Later'
                );
                if (proceed) {
                    // Navigate to routes page with the date to trigger replanning
                    const dateParam = scheduledDate || '';
                    window.location.href = `routes.html?replanDate=${encodeURIComponent(dateParam)}&invalidatedRouteId=${encodeURIComponent(routeId)}`;
                }
            }

            async function handleFormSubmit(e) {
                e.preventDefault();

                const newStatus = document.getElementById('status').value;

                // Check if cancelling a scheduled booking
                if (isEditing && originalBookingStatus === 'scheduled' &&
                    (newStatus === 'cancelled' || newStatus === 'no_show')) {
                    const confirmed = await showConfirm(
                        '‚ö†Ô∏è This booking is currently assigned to a route.\n\n' +
                        'Changing the status will remove it from the route. ' +
                        'The route will be flagged for recalculation.\n\n' +
                        'Do you want to continue?',
                        'Confirm Status Change'
                    );
                    if (!confirmed) {
                        return;
                    }
                }

                const bookingData = {
                    clientId: clientIdInput.value || null,
                    locationId: locationIdInput.value || null,
                    // serviceId: serviceIdInput.value, // Removed single service ID
                    serviceIds: selectedServices.map(s => s.id),
                    serviceItems: selectedServices.map(s => ({
                        serviceId: s.id,
                        quantity: s.quantity,
                        unitPrice: s.unitPrice,
                        name: s.name,
                        duration: s.duration,
                        total: s.quantity * s.unitPrice
                    })),
                    scheduledDate: document.getElementById('scheduled-date').value,
                    scheduledStartTime: document.getElementById('scheduled-start-time').value,
                    bookingType: document.getElementById('booking-type').value,
                    status: newStatus,
                    quotedPrice: parseFloat(document.getElementById('quoted-price').value) || 0,
                    estimatedDurationMinutes: parseInt(document.getElementById('estimated-duration').value) || undefined,
                    specialInstructions: document.getElementById('special-instructions').value
                };

                try {
                    if (isEditing && currentBookingId) {
                        bookingData.id = currentBookingId;

                        // If cancelling a scheduled booking, remove it from route
                        if (originalBookingStatus === 'scheduled' &&
                            (newStatus === 'cancelled' || newStatus === 'no_show')) {
                            try {
                                await window.electronAPI.bookings.removeFromRoute(currentBookingId);
                            } catch (routeErr) {
                                console.warn('Could not remove from route:', routeErr);
                            }
                        }

                        const updateResult = await window.electronAPI.bookings.update(bookingData);

                        // Check if the update invalidated a route
                        if (updateResult?.routeWasInvalidated && updateResult?.invalidatedRouteId) {
                            closeModal();
                            loadBookings();
                            // Show route recalculation prompt
                            showRouteInvalidationModal(updateResult.invalidatedRouteId, bookingData.scheduledDate);
                            return; // Exit early to avoid double modal close
                        }
                    } else {
                        await window.electronAPI.bookings.create(bookingData);
                    }
                    closeModal();
                    loadBookings();
                } catch (error) {
                    console.error('Save failed', error);
                    alert('Failed to save booking: ' + error.message);
                }
            }

            // Close search dropdowns on click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#client-search-results') && e.target !== clientSearchInput) {
                    clientSearchResults.style.display = 'none';
                }
                if (!e.target.closest('#service-search-results') && e.target !== serviceSearchInput) {
                    serviceSearchResults.style.display = 'none';
                }
                if (!e.target.closest('#location-search-results') && e.target !== locationSearchInput) {
                    locationSearchResults.style.display = 'none';
                }
            });

            // ========================================
            // IMPORT WIZARD FUNCTIONALITY (4-STEP)
            // ========================================

            // Target columns for the import
            const TARGET_COLUMNS = [
                { key: 'bookingNumber', label: 'Booking #', required: false },
                { key: 'customerName', label: 'Customer Name', required: true },
                { key: 'serviceName', label: 'Service Name', required: true },
                { key: 'locationName', label: 'Location Name', required: true },
                { key: 'date', label: 'Date', required: true }
            ];

            // Preload entity data and booking numbers
            async function loadEntityCaches() {
                try {
                    const [customersRes, servicesRes, locationsRes, bookingsRes] = await Promise.all([
                        window.electronAPI.clients.getAll(),
                        window.electronAPI.services.getAll(),
                        window.electronAPI.locations.getAll(),
                        window.electronAPI.bookings.getAll({}, { page: 1, limit: 10000 })
                    ]);

                    cachedCustomers = customersRes.data?.data || customersRes.data || [];
                    cachedServices = servicesRes.data?.data || servicesRes.data || [];
                    cachedLocations = locationsRes.data || [];

                    // Extract existing booking numbers (exclude deleted ones to allow reuse)
                    const bookings = bookingsRes.data?.data || bookingsRes.data || [];
                    cachedBookingNumbers = bookings
                        .filter(b => !b.deletedAt)
                        .map(b => b.bookingNumber)
                        .filter(Boolean);

                    console.log(`Loaded: ${cachedCustomers.length} customers, ${cachedServices.length} services, ${cachedLocations.length} locations, ${cachedBookingNumbers.length} booking numbers`);
                } catch (error) {
                    console.error('Failed to load entity caches:', error);
                }
            }

            loadEntityCaches();

            // --- Step Navigation ---
            function updateStepperUI() {
                document.querySelectorAll('.stepper-step').forEach((step, index) => {
                    const stepNum = index + 1;
                    step.classList.remove('active', 'completed');
                    if (stepNum === currentImportStep) {
                        step.classList.add('active');
                    } else if (stepNum < currentImportStep) {
                        step.classList.add('completed');
                    }
                });

                // Update step visibility
                for (let i = 1; i <= 4; i++) {
                    const stepEl = document.getElementById(`import-step-${i}`);
                    if (stepEl) {
                        stepEl.style.display = i === currentImportStep ? 'flex' : 'none';
                    }
                }

                // Update buttons
                const loadDataBtn = document.getElementById('import-load-data-btn');
                importBackBtn.style.display = currentImportStep > 1 && currentImportStep < 4 ? 'inline-block' : 'none';

                // Show Next on Steps 1-2, Load Data on Step 3, Done on Step 4
                importNextBtn.style.display = currentImportStep < 3 ? 'inline-block' : 'none';
                loadDataBtn.style.display = currentImportStep === 3 ? 'inline-block' : 'none';
                importDoneBtn.style.display = currentImportStep === 4 ? 'inline-block' : 'none';
            }

            function goToStep(step) {
                currentImportStep = step;
                updateStepperUI();

                if (step === 2) renderMappingStep();
                if (step === 3) renderValidationStep();
            }

            // Back button
            importBackBtn.addEventListener('click', () => {
                if (currentImportStep > 1) {
                    goToStep(currentImportStep - 1);
                }
            });

            // Next button
            importNextBtn.addEventListener('click', () => {
                if (currentImportStep === 1 && selectedImportFile) {
                    goToStep(2);
                } else if (currentImportStep === 2) {
                    goToStep(3);
                } else if (currentImportStep === 3) {
                    // Should use Load Data button instead
                }
            });

            // Done button
            importDoneBtn.addEventListener('click', () => {
                closeImportModalFn();
                loadBookings();
            });

            // --- Drag and Drop Setup ---
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                importDropZone.addEventListener(eventName, (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                }, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                importDropZone.addEventListener(eventName, () => {
                    importDropZone.classList.add('drag-over');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                importDropZone.addEventListener(eventName, () => {
                    importDropZone.classList.remove('drag-over');
                }, false);
            });

            importDropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) handleImportFile(files[0]);
            }, false);

            importFileSelectBtn.addEventListener('click', () => importFileInput.click());

            importFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) handleImportFile(e.target.files[0]);
            });

            function validateImportFile(file) {
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    return { valid: false, error: 'Please select a CSV file (.csv)' };
                }
                if (file.size > 10 * 1024 * 1024) {
                    return { valid: false, error: 'File size must be less than 10MB' };
                }
                return { valid: true };
            }

            async function handleImportFile(file) {
                const validation = validateImportFile(file);
                if (!validation.valid) {
                    alert(validation.error);
                    return;
                }

                selectedImportFile = file;
                importFileName.textContent = file.name;
                importDropZone.querySelector('.drop-zone-content').style.display = 'none';
                importFilePreview.style.display = 'flex';

                // Parse CSV
                const content = await file.text();
                parsedCSVData = parseCSVContent(content);

                importNextBtn.disabled = parsedCSVData.rows.length === 0;
            }

            importClearFileBtn.addEventListener('click', () => {
                selectedImportFile = null;
                parsedCSVData = { headers: [], rows: [] };
                importFileInput.value = '';
                importFilePreview.style.display = 'none';
                importDropZone.querySelector('.drop-zone-content').style.display = 'flex';
                importNextBtn.disabled = true;
            });

            // --- Template Download ---
            document.getElementById('import-download-template-btn').addEventListener('click', (e) => {
                e.preventDefault();
                const headers = ['Booking #', 'Customer Name', 'Service Name', 'Location Name', 'Date'];
                const exampleRow = ['BK-001', 'Example Customer', 'Example Service', 'Main Location', '2026-02-01'];
                const csvContent = headers.join(',') + '\n' + exampleRow.join(',');
                const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
                const link = document.createElement('a');
                link.href = dataUri;
                link.download = 'bookings_import_template.csv';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            // --- Modal Open/Close ---
            document.getElementById('import-btn').addEventListener('click', openImportModal);

            function openImportModal() {
                importModal.style.display = 'block';
                resetImportModal();
            }

            function closeImportModalFn() {
                importModal.style.display = 'none';
                resetImportModal();
            }

            function resetImportModal() {
                currentImportStep = 1;
                selectedImportFile = null;
                parsedCSVData = { headers: [], rows: [] };
                columnMapping = {};
                validatedRows = [];
                importResults = { success: [], skipped: [] };
                importFileInput.value = '';
                importFilePreview.style.display = 'none';
                importDropZone.querySelector('.drop-zone-content').style.display = 'flex';
                importNextBtn.disabled = true;
                updateStepperUI();
            }

            closeImportModal.addEventListener('click', closeImportModalFn);
            importCancelBtn.addEventListener('click', closeImportModalFn);
            importModal.addEventListener('click', (e) => {
                if (e.target === importModal) closeImportModalFn();
            });

            // --- CSV Parsing ---
            function parseCSVContent(content) {
                const lines = content.split(/\r?\n/).filter(line => line.trim());
                if (lines.length < 2) return { headers: [], rows: [] };

                const headers = parseCSVLine(lines[0]);
                const rows = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.some(v => v.trim())) {
                        rows.push({ _rowIndex: i, values });
                    }
                }

                return { headers, rows };
            }

            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            }

            // --- Step 2: Column Mapping ---
            function renderMappingStep() {
                const targetRow = document.getElementById('mapping-target-row');
                const sourceRow = document.getElementById('mapping-source-row');
                const previewTbody = document.getElementById('mapping-preview-tbody');

                // Clear existing
                targetRow.innerHTML = '';
                sourceRow.innerHTML = '';
                previewTbody.innerHTML = '';

                // Auto-detect column mapping
                columnMapping = {};
                parsedCSVData.headers.forEach((header, idx) => {
                    const headerLower = header.toLowerCase().replace(/[^a-z]/g, '');
                    TARGET_COLUMNS.forEach(target => {
                        const targetLower = target.label.toLowerCase().replace(/[^a-z]/g, '');
                        if (headerLower.includes(targetLower) || targetLower.includes(headerLower)) {
                            if (!Object.values(columnMapping).includes(target.key)) {
                                columnMapping[idx] = target.key;
                            }
                        }
                    });
                });

                // Build header rows
                parsedCSVData.headers.forEach((header, idx) => {
                    // Target column dropdown
                    const targetTh = document.createElement('th');
                    targetTh.style.cssText = 'padding: 12px 8px;';
                    const select = document.createElement('select');
                    select.dataset.columnIndex = idx;
                    select.innerHTML = `<option value="">Do Not Load</option>` +
                        TARGET_COLUMNS.map(t => `<option value="${t.key}" ${columnMapping[idx] === t.key ? 'selected' : ''}>${t.label}${t.required ? ' *' : ''}</option>`).join('');
                    select.addEventListener('change', (e) => {
                        if (e.target.value) {
                            columnMapping[idx] = e.target.value;
                        } else {
                            delete columnMapping[idx];
                        }
                    });
                    targetTh.appendChild(select);
                    targetRow.appendChild(targetTh);

                    // Source column name
                    const sourceTh = document.createElement('th');
                    sourceTh.style.cssText = 'padding: 12px 8px; font-weight: 500;';
                    sourceTh.textContent = header;
                    sourceRow.appendChild(sourceTh);
                });

                // Preview first 5 rows
                const previewRows = parsedCSVData.rows.slice(0, 5);
                previewRows.forEach((row, rowIdx) => {
                    const tr = document.createElement('tr');
                    row.values.forEach(val => {
                        const td = document.createElement('td');
                        td.style.cssText = 'padding: 8px; font-size: 0.85rem;';
                        td.textContent = val || '-';
                        tr.appendChild(td);
                    });
                    previewTbody.appendChild(tr);
                });
            }

            // --- Step 3: Validation ---
            function renderValidationStep() {
                const tbody = document.getElementById('import-validation-tbody');
                tbody.innerHTML = '';
                validatedRows = [];

                // Phase 1: Map all data according to column mapping
                parsedCSVData.rows.forEach((row, idx) => {
                    const mappedRow = { _rowIndex: idx + 1, errors: {}, data: {}, resolvedEntities: {} };

                    parsedCSVData.headers.forEach((header, colIdx) => {
                        const targetKey = columnMapping[colIdx];
                        if (targetKey) {
                            mappedRow.data[targetKey] = row.values[colIdx] || '';
                        }
                    });

                    validatedRows.push(mappedRow);
                });

                // Phase 2: Validate all rows (now all rows exist for cross-reference checking)
                validatedRows.forEach(row => validateRow(row));

                renderValidationTable();
                updateValidationStatus();
            }

            function validateRow(row) {
                row.errors = {};
                row.resolvedEntities = {};

                // Validate customer
                if (!row.data.customerName) {
                    row.errors.customerName = 'Required';
                } else {
                    const customer = cachedCustomers.find(c => c.name.toLowerCase() === row.data.customerName.toLowerCase());
                    if (customer) {
                        row.resolvedEntities.customer = customer;
                    } else {
                        row.errors.customerName = 'Not found';
                    }
                }

                // Validate service
                if (!row.data.serviceName) {
                    row.errors.serviceName = 'Required';
                } else {
                    const service = cachedServices.find(s => s.name.toLowerCase() === row.data.serviceName.toLowerCase());
                    if (service) {
                        row.resolvedEntities.service = service;
                    } else {
                        row.errors.serviceName = 'Not found';
                    }
                }

                // Validate location (must exist AND belong to the customer)
                if (!row.data.locationName) {
                    row.errors.locationName = 'Required';
                } else {
                    const location = cachedLocations.find(l => l.name.toLowerCase() === row.data.locationName.toLowerCase());
                    if (location) {
                        // Check if location belongs to the resolved customer
                        const customer = row.resolvedEntities?.customer;
                        if (customer && location.clientId !== customer.id) {
                            row.errors.locationName = 'Wrong customer';
                        } else {
                            row.resolvedEntities.location = location;
                        }
                    } else {
                        row.errors.locationName = 'Not found';
                    }
                }

                // Validate date
                if (!row.data.date) {
                    row.errors.date = 'Required';
                } else if (!/^\d{4}-\d{2}-\d{2}$/.test(row.data.date)) {
                    row.errors.date = 'Invalid format';
                }

                // Validate booking # uniqueness
                if (row.data.bookingNumber) {
                    const isDuplicate = cachedBookingNumbers.includes(row.data.bookingNumber) ||
                        validatedRows.some((r, i) => r !== row && r.data.bookingNumber === row.data.bookingNumber);
                    if (isDuplicate) {
                        row.errors.bookingNumber = 'Duplicate';
                    }
                }

                row.isValid = Object.keys(row.errors).length === 0;
            }

            function renderValidationTable() {
                const tbody = document.getElementById('import-validation-tbody');
                tbody.innerHTML = '';

                validatedRows.forEach((row, idx) => {
                    const tr = document.createElement('tr');
                    tr.className = row.isValid ? 'row-valid' : 'row-invalid';
                    tr.dataset.rowIndex = idx;

                    tr.innerHTML = `
                        <td><input type="checkbox" class="validation-row-checkbox" data-index="${idx}"></td>
                        <td><span class="status-icon ${row.isValid ? 'success' : 'error'}">${row.isValid ? '‚úì' : '‚úï'}</span></td>
                        <td class="cell-editable ${row.errors.bookingNumber ? 'cell-invalid' : ''}" data-field="bookingNumber" title="${row.errors.bookingNumber || ''}">${row.data.bookingNumber || '<span style="color: var(--text-secondary);">Auto</span>'}</td>
                        <td class="cell-editable ${row.errors.customerName ? 'cell-invalid' : ''}" data-field="customerName" title="${row.errors.customerName || ''}">${escapeHtml(row.data.customerName) || '-'}</td>
                        <td class="cell-editable ${row.errors.serviceName ? 'cell-invalid' : ''}" data-field="serviceName" title="${row.errors.serviceName || ''}">${escapeHtml(row.data.serviceName) || '-'}</td>
                        <td class="cell-editable ${row.errors.locationName ? 'cell-invalid' : ''}" data-field="locationName" title="${row.errors.locationName || ''}">${escapeHtml(row.data.locationName) || '-'}</td>
                        <td class="cell-editable ${row.errors.date ? 'cell-invalid' : ''}" data-field="date" title="${row.errors.date || ''}">${row.data.date || '-'}</td>
                    `;

                    // Add click handlers for editable cells
                    tr.querySelectorAll('.cell-editable').forEach(cell => {
                        cell.addEventListener('click', () => openCellEditor(idx, cell.dataset.field, cell));
                    });

                    tbody.appendChild(tr);
                });

                // Select all checkbox
                document.getElementById('validation-select-all').addEventListener('change', (e) => {
                    document.querySelectorAll('.validation-row-checkbox').forEach(cb => cb.checked = e.target.checked);
                    updateDeleteButton();
                });

                // Update delete button on checkbox change
                tbody.querySelectorAll('.validation-row-checkbox').forEach(cb => {
                    cb.addEventListener('change', updateDeleteButton);
                });
            }

            function updateDeleteButton() {
                const checked = document.querySelectorAll('.validation-row-checkbox:checked').length;
                document.getElementById('delete-selected-btn').style.display = checked > 0 ? 'inline-block' : 'none';
            }

            function updateValidationStatus() {
                const validCount = validatedRows.filter(r => r.isValid).length;
                const total = validatedRows.length;
                document.getElementById('validation-status-text').textContent = `${validCount} of ${total} rows valid`;

                // Enable/disable the Load Data button based on valid rows
                const loadBtn = document.getElementById('import-load-data-btn');
                loadBtn.disabled = validCount === 0;
            }

            // --- Cell Editor ---
            let activeDropdown = null;

            // Toast notification function
            function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 100px;
                    left: 50%;
                    transform: translateX(-50%);
                    padding: 12px 24px;
                    background: ${type === 'error' ? 'rgba(248, 81, 73, 0.95)' : type === 'warning' ? 'rgba(255, 166, 0, 0.95)' : 'rgba(88, 166, 255, 0.95)'};
                    color: white;
                    border-radius: 8px;
                    font-size: 0.9rem;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    animation: toastFadeIn 0.3s ease;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'toastFadeOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            function openCellEditor(rowIndex, field, cell) {
                closeCellEditor();

                const row = validatedRows[rowIndex];
                const dropdown = document.createElement('div');
                dropdown.className = 'cell-edit-dropdown';

                let options = [];
                if (field === 'customerName') {
                    options = cachedCustomers.map(c => ({ id: c.id, name: c.name }));
                } else if (field === 'serviceName') {
                    options = cachedServices.map(s => ({ id: s.id, name: s.name }));
                } else if (field === 'locationName') {
                    // Check if customer is resolved first
                    const customer = row.resolvedEntities?.customer;
                    if (!customer) {
                        showToast('Please select a customer first', 'warning');
                        return;
                    }
                    // Filter locations by customer
                    options = cachedLocations
                        .filter(l => l.clientId === customer.id)
                        .map(l => ({ id: l.id, name: l.name }));

                    if (options.length === 0) {
                        showToast('No locations found for this customer', 'warning');
                        return;
                    }
                } else if (field === 'date') {
                    // Date picker - auto show calendar
                    const input = document.createElement('input');
                    input.type = 'date';
                    input.value = row.data.date || '';
                    input.style.cssText = 'width: 180px; padding: 10px 12px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 6px; font-size: 0.9rem;';
                    input.addEventListener('change', () => {
                        row.data.date = input.value;
                        validateRow(row);
                        renderValidationTable();
                        updateValidationStatus();
                        closeCellEditor();
                    });
                    dropdown.appendChild(input);
                    cell.style.position = 'relative';
                    cell.appendChild(dropdown);
                    activeDropdown = dropdown;
                    input.focus();
                    // Auto-show the calendar picker
                    if (input.showPicker) {
                        try { input.showPicker(); } catch (e) { /* ignore */ }
                    }
                    return;
                } else if (field === 'bookingNumber') {
                    // Text input for booking #
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = row.data.bookingNumber || '';
                    input.placeholder = 'Enter booking # or leave blank for auto';
                    input.style.cssText = 'width: 200px; padding: 8px; background: var(--bg-card); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;';

                    const applyBookingChange = () => {
                        row.data.bookingNumber = input.value.trim();
                        // Re-validate ALL rows to properly update duplicate detection
                        validatedRows.forEach(r => validateRow(r));
                        renderValidationTable();
                        updateValidationStatus();
                        closeCellEditor();
                    };

                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            applyBookingChange();
                        } else if (e.key === 'Escape') {
                            closeCellEditor();
                        }
                    });
                    input.addEventListener('blur', () => {
                        applyBookingChange();
                    });
                    dropdown.appendChild(input);
                    cell.style.position = 'relative';
                    cell.appendChild(dropdown);
                    activeDropdown = dropdown;
                    input.focus();
                    return;
                }

                // Search input
                const searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.placeholder = 'Search...';
                dropdown.appendChild(searchInput);

                // Options container
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'dropdown-options';
                dropdown.appendChild(optionsDiv);

                function renderOptions(filter = '') {
                    const filtered = filter ? options.filter(o => o.name.toLowerCase().includes(filter.toLowerCase())) : options;
                    optionsDiv.innerHTML = filtered.map(o => `<div class="dropdown-option" data-id="${o.id}" data-name="${escapeHtml(o.name)}">${escapeHtml(o.name)}</div>`).join('');

                    optionsDiv.querySelectorAll('.dropdown-option').forEach(opt => {
                        opt.addEventListener('click', () => {
                            row.data[field] = opt.dataset.name;
                            validateRow(row);
                            renderValidationTable();
                            updateValidationStatus();
                            closeCellEditor();
                        });
                    });
                }

                searchInput.addEventListener('input', () => renderOptions(searchInput.value));
                renderOptions();

                cell.style.position = 'relative';
                cell.appendChild(dropdown);
                activeDropdown = dropdown;
                searchInput.focus();
            }

            function closeCellEditor() {
                if (activeDropdown) {
                    activeDropdown.remove();
                    activeDropdown = null;
                }
            }

            document.addEventListener('click', (e) => {
                if (activeDropdown && !activeDropdown.contains(e.target) && !e.target.classList.contains('cell-editable')) {
                    closeCellEditor();
                }
            });

            // --- Delete Selected Rows ---
            document.getElementById('delete-selected-btn').addEventListener('click', () => {
                const checkboxes = document.querySelectorAll('.validation-row-checkbox:checked');
                const indicesToDelete = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
                validatedRows = validatedRows.filter((_, i) => !indicesToDelete.includes(i));
                renderValidationTable();
                updateValidationStatus();
            });

            // --- Load Data ---
            document.getElementById('import-load-data-btn').addEventListener('click', async () => {
                const validRows = validatedRows.filter(r => r.isValid);
                if (validRows.length === 0) {
                    alert('No valid rows to import');
                    return;
                }

                const loadBtn = document.getElementById('import-load-data-btn');
                loadBtn.disabled = true;
                loadBtn.textContent = 'Importing...';

                importResults = { success: [], skipped: [] };

                for (const row of validRows) {
                    try {
                        const customer = row.resolvedEntities.customer;
                        const service = row.resolvedEntities.service;
                        const location = row.resolvedEntities.location;

                        const bookingData = {
                            clientId: customer.id,
                            serviceId: service.id, // Required for join/display logic
                            serviceItems: [{
                                serviceId: service.id,
                                name: service.name,
                                quantity: 1,
                                unitPrice: service.price || service.basePrice || 0
                            }],
                            locationId: location.id,
                            scheduledDate: row.data.date,
                            bookingType: 'one_time',
                            status: 'pending'
                        };

                        // Add custom booking number if provided
                        if (row.data.bookingNumber) {
                            bookingData.bookingNumber = row.data.bookingNumber;
                        }

                        const result = await window.electronAPI.bookings.create(bookingData);

                        importResults.success.push({
                            bookingNumber: result.bookingNumber || row.data.bookingNumber,
                            customerName: customer.name,
                            serviceName: service.name,
                            locationName: location.name,
                            date: row.data.date
                        });

                        // Add to cached booking numbers
                        if (result.bookingNumber) {
                            cachedBookingNumbers.push(result.bookingNumber);
                        }
                    } catch (err) {
                        importResults.skipped.push({
                            ...row.data,
                            error: err.message
                        });
                    }
                }

                // Add invalid rows to skipped
                validatedRows.filter(r => !r.isValid).forEach(r => {
                    importResults.skipped.push({
                        ...r.data,
                        error: Object.values(r.errors).join(', ')
                    });
                });

                loadBtn.disabled = false;
                loadBtn.textContent = 'Load Data';
                goToStep(4);
                renderResultsStep();
            });

            // --- Step 4: Results ---
            function renderResultsStep() {
                document.querySelector('#import-success-count div:first-child').textContent = importResults.success.length;
                document.querySelector('#import-skipped-count div:first-child').textContent = importResults.skipped.length;

                const tbody = document.getElementById('import-results-tbody');
                tbody.innerHTML = '';

                importResults.success.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span class="status-icon success">‚úì</span></td>
                        <td>${escapeHtml(row.bookingNumber || 'Auto')}</td>
                        <td>${escapeHtml(row.customerName)}</td>
                        <td>${escapeHtml(row.serviceName)}</td>
                        <td>${escapeHtml(row.locationName)}</td>
                        <td>${row.date}</td>
                        <td style="color: #2ea043;">Imported</td>
                    `;
                    tbody.appendChild(tr);
                });

                importResults.skipped.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.style.background = 'rgba(248, 81, 73, 0.05)';
                    tr.innerHTML = `
                        <td><span class="status-icon error">‚úï</span></td>
                        <td>${escapeHtml(row.bookingNumber || '-')}</td>
                        <td>${escapeHtml(row.customerName || '-')}</td>
                        <td>${escapeHtml(row.serviceName || '-')}</td>
                        <td>${escapeHtml(row.locationName || '-')}</td>
                        <td>${row.date || '-'}</td>
                        <td style="color: #f85149; font-size: 0.75rem;" title="${escapeHtml(row.error)}">${truncateText(row.error, 15)}</td>
                    `;
                    tbody.appendChild(tr);
                });

                // Refresh bookings if we had successes
                if (importResults.success.length > 0) {
                    loadBookings();
                }
            }

            function truncateText(text, maxLength) {
                if (!text) return '';
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            }

            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }


        });
    </script>
</body>

</html>