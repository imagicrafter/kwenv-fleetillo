<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drivers - Fleetillo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .nav-group.expanded .nav-children {
            display: flex;
        }

        /* Modal Styles matching bookings.html */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--bg-card);
            margin: 5% auto;
            padding: 0;
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            width: 500px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-modal {
            color: var(--text-secondary);
            font-size: 28px;
            font-weight: normal;
            cursor: pointer;
            line-height: 1;
            background: none;
            border: none;
        }

        .close-modal:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
            background-color: rgba(64, 169, 255, 0.05);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 32px;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .btn-secondary:hover {
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        /* Layout Fixes for Main Page Scrolling */
        html,
        body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        .app-container {
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
            padding-bottom: 0 !important;
        }

        .table-container {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            border-bottom: none !important;
        }

        .data-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bg-card);
        }

        .pagination-footer {
            flex-shrink: 0;
            background-color: var(--bg-card);
            border-top: 1px solid var(--border-color);
            z-index: 20;
        }

        /* Driver-specific styles for avatar display */
        .driver-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--bg-tertiary);
        }

        .driver-avatar-initials {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        /* Status badge colors for drivers */
        .status-badge.driver-active {
            background-color: rgba(46, 213, 115, 0.15);
            border-color: rgba(46, 213, 115, 0.3);
            color: var(--accent-success);
        }

        .status-badge.driver-inactive {
            background-color: rgba(128, 128, 128, 0.15);
            border-color: rgba(128, 128, 128, 0.3);
            color: var(--text-secondary);
        }

        .status-badge.driver-on-leave {
            background-color: rgba(255, 193, 7, 0.15);
            border-color: rgba(255, 193, 7, 0.3);
            color: #ffc107;
        }

        .status-badge.driver-terminated {
            background-color: rgba(255, 107, 107, 0.15);
            border-color: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        /* License expiry warning */
        .license-expiry-warning {
            color: #ffc107;
            font-weight: 500;
        }

        /* Avatar upload section in modal */
        .avatar-upload-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            background: var(--bg-tertiary);
            margin-bottom: 12px;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-initials {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 600;
            color: white;
            background: var(--accent-primary);
        }

        .avatar-actions {
            display: flex;
            gap: 8px;
        }

        .avatar-hint {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .btn-danger {
            background-color: rgba(255, 107, 107, 0.15);
            border-color: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        .btn-danger:hover {
            background-color: rgba(255, 107, 107, 0.25);
            border-color: #ff6b6b;
        }

        /* Section title styling */
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Accordion Styles */
        details.form-section-accordion {
            margin-top: 16px;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.02);
        }

        details.form-section-accordion summary {
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-primary);
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }

        details.form-section-accordion summary:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        details.form-section-accordion summary::-webkit-details-marker {
            display: none;
        }

        details.form-section-accordion summary::after {
            content: '+';
            font-size: 1.2em;
            font-weight: 300;
            color: var(--text-secondary);
        }

        details.form-section-accordion[open] summary::after {
            content: '‚àí';
        }

        details.form-section-accordion[open] summary {
            border-bottom: 1px solid var(--border-subtle);
        }

        details.form-section-accordion .section-content {
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
        }

        /* Toast notification styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 12px 20px;
            border-radius: 6px;
            min-width: 250px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideInRight 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.success {
            background: var(--accent-success);
            color: white;
        }

        .toast.error {
            background: #ff6b6b;
            color: white;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Status Message Styles */
        .status-waiting {
            color: var(--accent-warning);
            font-weight: 500;
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .status-waiting::before {
            content: '';
            width: 12px;
            height: 12px;
            border: 2px solid var(--accent-warning);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .status-connected {
            color: var(--accent-success);
            font-weight: 600;
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <style>
        /* Action Buttons & Tooltips */
        .action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 0 2px;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .action-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Tooltip */
        .action-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.75rem;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-bottom: 8px;
            z-index: 100;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            font-weight: 500;
        }

        .action-btn:hover::after {
            opacity: 1;
        }

        /* Tag Chip Styles */
        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(64, 169, 255, 0.15);
            border: 1px solid rgba(64, 169, 255, 0.3);
            color: var(--accent-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .tag-chip .tag-remove {
            cursor: pointer;
            opacity: 0.7;
            font-size: 1rem;
            line-height: 1;
            margin-left: 2px;
        }

        .tag-chip .tag-remove:hover {
            opacity: 1;
        }
    </style>
</head>

<body class="dark-theme">
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <img src="assets/images/fleetillo_logo.png" alt="Fleetillo" style="height: 60px;">
            </div>

            <nav class="nav-menu">
                <!-- Dashboard -->
                <a href="index.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                        </svg>
                    </span>
                    Dashboard
                </a>

                <!-- PLANNING -->
                <div class="menu-header">PLANNING</div>

                <a href="customers.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </span>
                    Customers
                </a>

                <a href="services.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                    </span>
                    Services
                </a>

                <a href="bookings.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                    </span>
                    Bookings
                </a>

                <a href="calendar.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </span>
                    Calendar
                </a>

                <a href="locations.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </span>
                    Locations
                </a>

                <!-- FLEET -->
                <div class="menu-header">FLEET</div>

                <a href="vehicles.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                    </span>
                    Vehicles
                </a>

                <a href="drivers.html" class="nav-item active">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </span>
                    Drivers
                </a>

                <!-- OPERATIONS -->
                <div class="menu-header">OPERATIONS</div>

                <a href="routes.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="6" cy="19" r="3" />
                            <path d="M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15" />
                            <circle cx="18" cy="5" r="3" />
                        </svg>
                    </span>
                    Routes
                </a>

                <a href="dispatch.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </span>
                    Dispatch
                    <span class="badge new">New</span>
                </a>

                <!-- SYSTEM -->
                <div class="menu-header">SYSTEM</div>

                <a href="#" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                    </span>
                    Reports
                </a>

                <a href="settings.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </span>
                    Settings
                </a>
            </nav>
            <script>
                // Auto-expand current group if any
                document.addEventListener('DOMContentLoaded', () => {
                    const activeLink = document.querySelector('.nav-item.active');
                    if (activeLink) {
                        // Ensure it's visible, though flatter structure makes this simpler
                    }
                });
            </script>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="avatar">JM</div>
                    <div class="details">
                        <span class="name">Admin User</span>
                        <span class="role">Administrator</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="search-input" placeholder="Search drivers...">
                </div>
                <div class="filters" style="display: flex; gap: 12px; align-items: center;">
                    <select id="status-filter"
                        style="padding: 8px 12px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary); font-size: 0.95rem;">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="on_leave">On Leave</option>
                        <option value="terminated">Terminated</option>
                    </select>
                </div>
                <div class="actions">
                    <button class="btn-primary" id="add-driver-btn">+ Add Driver</button>
                </div>
            </header>

            <div class="content-wrapper">
                <div class="page-header">
                    <h2>Drivers</h2>
                    <span class="date">Manage your driver roster</span>
                </div>

                <div class="data-table-container table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Driver</th>
                                <th>Contact</th>
                                <th>License Expiry</th>
                                <th>Assigned Vehicle</th>
                                <th>Tags</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="drivers-table-body">
                            <!-- Table will be populated by JavaScript -->
                            <tr>
                                <td colspan="7"
                                    style="text-align:center; padding: 40px 20px; color: var(--text-secondary);">
                                    No drivers found. Click "Add Driver" to create one.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Footer -->
                <div class="pagination-footer"
                    style="padding: 16px 20px; border-top: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between;">
                    <div class="rows-per-page">
                        <label for="rows-select" style="margin-right: 8px; color: var(--text-secondary);">Rows per
                            page:</label>
                        <select id="rows-select"
                            style="background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); color: var(--text-primary); border-radius: 4px; padding: 4px 8px;">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="pagination-controls" style="display: flex; align-items: center; gap: 16px;">
                        <span id="pagination-info" style="color: var(--text-secondary); font-size: 0.9rem;">0-0 of
                            0</span>
                        <div class="page-nav">
                            <button id="prev-page-btn" class="action-btn" style="padding: 4px 8px;"
                                disabled>Previous</button>
                            <button id="next-page-btn" class="action-btn" style="padding: 4px 8px;"
                                disabled>Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Driver Modal -->
    <div id="driver-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add Driver</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="driver-form">
                    <input type="hidden" id="driver-id">

                    <!-- Avatar Upload Section -->
                    <div class="avatar-upload-section">
                        <div class="avatar-preview" id="avatarPreview">
                            <img id="avatarImage" src="" alt="Driver avatar" style="display:none;">
                            <div id="avatarInitials" class="avatar-initials"></div>
                        </div>
                        <div class="avatar-actions">
                            <input type="file" id="avatarInput" accept="image/jpeg,image/png,image/webp" hidden>
                            <button type="button" class="btn-secondary" id="uploadAvatarBtn">Upload Photo</button>
                            <button type="button" class="btn-secondary btn-danger" id="removeAvatarBtn"
                                style="display:none;">Remove</button>
                        </div>
                        <p class="avatar-hint">JPEG, PNG or WebP. Max 5MB.</p>
                    </div>

                    <!-- Personal Information Section (Modified) -->
                    <div class="form-section">
                        <h4 class="section-title">Driver Details</h4>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="first-name">First Name *</label>
                                <input type="text" id="first-name" required placeholder="John">
                            </div>
                            <div class="form-group">
                                <label for="last-name">Last Name *</label>
                                <input type="text" id="last-name" required placeholder="Doe">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="phone-number">Phone Number</label>
                                <input type="tel" id="phone-number" placeholder="+1 (555) 123-4567">
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" id="email" placeholder="john.doe@example.com">
                            </div>
                        </div>

                        <!-- Emergency Contact (Moved Up) -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="emergency-contact-name">Emergency Contact Name</label>
                                <input type="text" id="emergency-contact-name" placeholder="Jane Doe">
                            </div>
                            <div class="form-group">
                                <label for="emergency-contact-phone">Emergency Contact Phone</label>
                                <input type="tel" id="emergency-contact-phone" placeholder="+1 (555) 987-6543">
                            </div>
                        </div>

                        <!-- Notes (Moved Up) -->
                        <div class="form-group" style="margin-top: 12px;">
                            <label for="driver-notes">Notes</label>
                            <textarea id="driver-notes" rows="2"
                                style="width: 100%; padding: 10px 12px; background-color: rgba(0, 0, 0, 0.2); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary); font-family: inherit; font-size: 0.95rem; resize: vertical;"
                                placeholder="Additional notes about the driver..."></textarea>
                        </div>

                        <!-- Tags -->
                        <div class="form-group" style="margin-top: 12px;">
                            <label for="driver-tag-input">Tags</label>
                            <div class="tag-input-container"
                                style="display: flex; flex-wrap: wrap; gap: 6px; padding: 8px 12px; background-color: rgba(0, 0, 0, 0.2); border: 1px solid var(--border-subtle); border-radius: 6px; min-height: 42px; align-items: center;">
                                <div id="driver-tag-chips" style="display: flex; flex-wrap: wrap; gap: 6px;"></div>
                                <input type="text" id="driver-tag-input" placeholder="Add tag and press Enter"
                                    style="flex: 1; min-width: 120px; background: transparent; border: none; color: var(--text-primary); font-family: inherit; font-size: 0.95rem; outline: none; padding: 2px 0;">
                            </div>
                            <small
                                style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 4px; display: block;">
                                Press Enter or comma to add a tag
                            </small>
                        </div>

                    </div>

                    <details class="form-section-accordion">
                        <summary>Dispatch Registration</summary>
                        <div class="section-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="preferred-channel">Preferred Channel</label>
                                    <select id="preferred-channel">
                                        <option value="telegram">Telegram</option>
                                        <option value="email">Email</option>
                                    </select>
                                </div>
                                <div class="form-group" style="display: flex; align-items: center; margin-top: 28px;">
                                    <input type="checkbox" id="fallback-enabled"
                                        style="width: auto; margin-right: 8px;">
                                    <label for="fallback-enabled" style="margin-bottom: 0; cursor: pointer;">Enable
                                        Channel
                                        Fallback</label>
                                </div>
                            </div>
                            <small style="color: var(--text-secondary); font-size: 0.75rem;">
                                If enabled, system will try alternate channel if primary fails.
                            </small>

                            <!-- Telegram Registration (Moved into Dispatch Preferences) -->
                            <div class="form-group"
                                style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                                <label for="telegram-chat-id">Telegram Chat ID (Set via Telegram registration)</label>
                                <input type="text" id="telegram-chat-id" placeholder="Registered via Telegram" readonly>
                                <small style="color: var(--text-secondary); font-size: 0.75rem;">
                                    For route notifications and updates
                                </small>
                                <div id="telegram-registration-area" style="margin-top: 12px; display: none;">
                                    <div style="display: flex; gap: 8px;">
                                        <button type="button" class="btn btn-secondary btn-sm"
                                            onclick="showTelegramQrCode()">
                                            <i class="lucide-qr-code"
                                                style="width: 14px; height: 14px; margin-right: 6px;"></i>
                                            Show QR Code
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm"
                                            onclick="sendTelegramRegistrationEmail()">
                                            <i class="lucide-mail"
                                                style="width: 14px; height: 14px; margin-right: 6px;"></i>
                                            Send Link
                                        </button>
                                    </div>
                                    <div id="telegram-status-msg"
                                        style="margin-top: 8px; font-size: 0.75rem; color: #10b981; display: none;">
                                        <i class="lucide-check-circle"
                                            style="width: 12px; height: 12px; vertical-align: middle;"></i>
                                        Registration Active
                                    </div>
                                </div>
                                <div id="registration-placeholder"
                                    style="margin-top: 12px; color: var(--text-secondary); font-style: italic; font-size: 0.85rem; display: none;">
                                    <i class="lucide-info"
                                        style="width: 14px; height: 14px; vertical-align: middle; margin-right: 4px;"></i>
                                    Save driver to enable registration options
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- License Information Section (Accordion) -->
                    <details class="form-section-accordion">
                        <summary>License Information</summary>
                        <div class="section-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="license-number">License Number</label>
                                    <input type="text" id="license-number" placeholder="D1234567">
                                </div>
                                <div class="form-group">
                                    <label for="license-class">License Class</label>
                                    <input type="text" id="license-class" placeholder="Class C">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="license-expiry">License Expiry Date</label>
                                <input type="date" id="license-expiry">
                                <small style="color: var(--text-secondary); font-size: 0.75rem;">
                                    You'll be notified when licenses are expiring soon
                                </small>
                            </div>
                        </div>
                    </details>

                    <!-- Employment Information Section (Accordion) -->
                    <details class="form-section-accordion">
                        <summary>Employment Information</summary>
                        <div class="section-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="driver-status">Status *</label>
                                    <select id="driver-status" required>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                        <option value="on_leave">On Leave</option>
                                        <option value="terminated">Terminated</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="hire-date">Hire Date</label>
                                    <input type="date" id="hire-date">
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- Vehicle Assignment Section (Accordion) -->
                    <details class="form-section-accordion">
                        <summary>Vehicle Assignment</summary>
                        <div class="section-content">
                            <div class="form-group">
                                <label for="assigned-vehicle">Assigned Vehicle</label>
                                <select id="assigned-vehicle" name="assignedVehicle">
                                    <option value="">-- No Vehicle Assigned --</option>
                                    <!-- Populated dynamically by JavaScript -->
                                </select>
                            </div>
                        </div>
                    </details>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn-secondary close-modal-btn">Cancel</button>
                        <button type="submit" class="btn-primary">Save Driver</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Vehicle Assignment Modal -->
    <div id="vehicle-assign-modal" class="modal">
        <div class="modal-content" style="width: 400px;">
            <div class="modal-header">
                <h3>Assign Vehicle</h3>
                <button class="close-modal" onclick="closeVehicleAssignModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Assigning vehicle to: <strong id="assign-driver-name"></strong></p>
                <div class="form-group">
                    <label for="vehicle-select">Select Vehicle</label>
                    <select id="vehicle-select">
                        <option value="">-- No Vehicle Assigned --</option>
                        <!-- Populated dynamically by JavaScript -->
                    </select>
                </div>
                <div class="form-actions">
                    <button class="btn-secondary" onclick="closeVehicleAssignModal()">Cancel</button>
                    <button class="btn-primary" onclick="confirmVehicleAssignment()">Assign</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content" style="width: 400px;">
            <div class="modal-header">
                <h3>Confirm Delete</h3>
                <button class="close-modal" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete driver <strong id="delete-driver-name"></strong>?</p>
                <p style="color: #ff6b6b; font-size: 0.9rem; margin-top: 12px;">‚ö†Ô∏è This action cannot be undone.</p>
                <div class="form-actions" style="margin-top: 24px;">
                    <button class="btn-secondary" onclick="closeDeleteModal()">Cancel</button>
                    <button class="btn-danger" id="confirm-delete-btn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>

    <script src="js/config.js"></script>
    <script src="js/api-client.js"></script>
    <script src="confirmation-modal.js"></script>
    <script>
        // State variables
        let drivers = [];
        let vehicles = [];
        let currentPage = 1;
        let pageSize = 10;
        let totalDrivers = 0;
        let editingDriverId = null;
        let pendingAvatarFile = null;
        let searchTerm = '';
        let statusFilter = '';
        let currentDriverTags = [];

        // Toast notification function
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Debounce utility function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Tag management functions
        function renderDriverTagChips() {
            const container = document.getElementById('driver-tag-chips');
            container.innerHTML = currentDriverTags.map((tag, i) =>
                `<span class="tag-chip">${tag}<span class="tag-remove" data-index="${i}">&times;</span></span>`
            ).join('');

            // Attach click handlers for remove buttons
            container.querySelectorAll('.tag-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    currentDriverTags.splice(index, 1);
                    renderDriverTagChips();
                });
            });
        }

        function setupDriverTagInput() {
            const tagInput = document.getElementById('driver-tag-input');
            if (!tagInput) return;

            tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const tag = tagInput.value.trim().replace(/,/g, '');
                    if (tag && !currentDriverTags.includes(tag)) {
                        currentDriverTags.push(tag);
                        renderDriverTagChips();
                    }
                    tagInput.value = '';
                }
            });

            // Also handle blur to add any pending tag
            tagInput.addEventListener('blur', () => {
                const tag = tagInput.value.trim().replace(/,/g, '');
                if (tag && !currentDriverTags.includes(tag)) {
                    currentDriverTags.push(tag);
                    renderDriverTagChips();
                }
                tagInput.value = '';
            });
        }

        // RPC helper function removed - replaced by api-client.js

        // Load drivers with pagination and filters
        async function loadDrivers() {
            try {
                const params = {
                    page: currentPage,
                    pageSize: pageSize
                };

                // Add filters if set
                if (statusFilter) {
                    params.status = statusFilter;
                }
                if (searchTerm) {
                    params.searchTerm = searchTerm;
                }

                const result = await window.apiClient.drivers.getAll(params);

                drivers = result.data || result.drivers || [];
                totalDrivers = result.total || drivers.length;

                renderDriversTable();
                updatePagination();
            } catch (error) {
                console.error('Failed to load drivers:', error);
                document.getElementById('drivers-table-body').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align:center; padding: 40px 20px; color: var(--text-secondary);">
                            Error loading drivers: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Load vehicles for assignment dropdown
        async function loadVehicles() {
            try {
                const result = await window.apiClient.vehicles.getAll({ page: 1, pageSize: 1000 });
                vehicles = result.data || result.vehicles || [];
                populateVehicleDropdowns();
            } catch (error) {
                console.error('Failed to load vehicles:', error);
            }
        }

        // Populate vehicle dropdowns
        function populateVehicleDropdowns() {
            const assignedVehicleSelect = document.getElementById('assigned-vehicle');
            const vehicleSelectModal = document.getElementById('vehicle-select');

            const options = vehicles.map(v =>
                `<option value="${v.id}">${v.name || (v.make + ' ' + v.model)} (${v.licensePlate || 'No Plate'})</option>`
            ).join('');

            if (assignedVehicleSelect) {
                assignedVehicleSelect.innerHTML = '<option value="">-- No Vehicle Assigned --</option>' + options;
            }
            if (vehicleSelectModal) {
                vehicleSelectModal.innerHTML = '<option value="">-- No Vehicle Assigned --</option>' + options;
            }
        }

        // Get initials for avatar fallback
        function getInitials(firstName, lastName) {
            const first = firstName ? firstName.charAt(0).toUpperCase() : '';
            const last = lastName ? lastName.charAt(0).toUpperCase() : '';
            return first + last;
        }

        // Get status badge CSS class
        function getStatusBadgeClass(status) {
            const statusMap = {
                'active': 'driver-active',
                'inactive': 'driver-inactive',
                'on_leave': 'driver-on-leave',
                'terminated': 'driver-terminated'
            };
            return statusMap[status] || 'driver-inactive';
        }

        // Format status for display
        function formatStatus(status) {
            const statusMap = {
                'active': 'Active',
                'inactive': 'Inactive',
                'on_leave': 'On Leave',
                'terminated': 'Terminated'
            };
            return statusMap[status] || status;
        }

        // Render drivers table
        function renderDriversTable() {
            const tbody = document.getElementById('drivers-table-body');

            if (drivers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align:center; padding: 40px 20px; color: var(--text-secondary);">
                            No drivers found. Click "Add Driver" to create one.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = drivers.map(driver => {
                const initials = getInitials(driver.firstName, driver.lastName);
                const avatarHtml = driver.profileImageUrl
                    ? `<img src="${driver.profileImageUrl}" alt="${driver.firstName} ${driver.lastName}" class="driver-avatar">`
                    : `<div class="driver-avatar-initials">${initials}</div>`;

                // Look up vehicle name from vehicles array
                let vehicleDisplay = 'Unassigned';
                if (driver.assignedVehicleId) {
                    const assignedVehicle = vehicles.find(v => v.id === driver.assignedVehicleId);
                    if (assignedVehicle) {
                        vehicleDisplay = assignedVehicle.name || 'Unknown Vehicle';
                    }
                }

                const licenseExpiry = driver.licenseExpiry
                    ? new Date(driver.licenseExpiry).toLocaleDateString()
                    : 'N/A';

                // Format Tags
                const tags = driver.tags || [];
                const tagsHtml = tags.map(tag => `<span style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-right: 4px;">${tag}</span>`).join('');

                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                ${avatarHtml}
                                <div>
                                    <div style="font-weight: 500;">${driver.firstName} ${driver.lastName}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-secondary);">${driver.licenseNumber || 'No license'}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div>${driver.phoneNumber || 'N/A'}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">${driver.email || 'N/A'}</div>
                        </td>
                        <td>${licenseExpiry}</td>
                        <td>${vehicleDisplay}</td>
                        <td>${tagsHtml || '<span style="color: var(--text-muted);">-</span>'}</td>
                        <td>
                            <span class="status-badge ${getStatusBadgeClass(driver.status)}">${formatStatus(driver.status)}</span>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <button class="action-btn" onclick="openVehicleAssignModal('${driver.id}', '${driver.firstName} ${driver.lastName}')" data-tooltip="Assign Vehicle">
                                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"></path>
                                        <circle cx="7" cy="17" r="2"></circle>
                                        <path d="M9 17h6"></path>
                                        <circle cx="17" cy="17" r="2"></circle>
                                    </svg>
                                </button>
                                <button class="action-btn" onclick="openEditDriverModal('${driver.id}')" data-tooltip="Edit Driver">
                                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button class="action-btn" onclick="deleteDriver('${driver.id}')" data-tooltip="Delete Driver">
                                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Open add driver modal
        function openAddDriverModal() {
            editingDriverId = null;
            document.getElementById('modal-title').textContent = 'Add Driver';
            document.getElementById('driver-form').reset();
            document.getElementById('driver-form').reset();
            document.getElementById('driver-id').value = '';

            // Hide registration area for new drivers (must save first)
            const regArea = document.getElementById('telegram-registration-area');
            const regPlaceholder = document.getElementById('registration-placeholder');
            if (regArea) regArea.style.display = 'none';
            if (regPlaceholder) regPlaceholder.style.display = 'block';

            // Reset avatar preview
            document.getElementById('avatarImage').style.display = 'none';
            document.getElementById('avatarInitials').textContent = '';
            document.getElementById('removeAvatarBtn').style.display = 'none';
            pendingAvatarFile = null;

            // Reset tags
            currentDriverTags = [];
            renderDriverTagChips();

            document.getElementById('driver-modal').style.display = 'block';
        }

        // Open edit driver modal
        async function openEditDriverModal(driverId) {
            editingDriverId = driverId;
            document.getElementById('modal-title').textContent = 'Edit Driver';

            const driver = drivers.find(d => d.id === driverId);
            if (!driver) {
                console.error('Driver not found:', driverId);
                return;
            }

            // Populate form fields (driver uses camelCase from service)
            document.getElementById('driver-id').value = driver.id;
            document.getElementById('first-name').value = driver.firstName || '';
            document.getElementById('last-name').value = driver.lastName || '';
            document.getElementById('phone-number').value = driver.phoneNumber || '';
            document.getElementById('email').value = driver.email || '';
            document.getElementById('telegram-chat-id').value = driver.telegramChatId || '';

            // Telegram Registration UI
            const regArea = document.getElementById('telegram-registration-area');
            const regPlaceholder = document.getElementById('registration-placeholder');
            const statusMsg = document.getElementById('telegram-status-msg');

            if (regArea) {
                regArea.style.display = 'block'; // Always show for edit mode to allow re-registration
                if (regPlaceholder) regPlaceholder.style.display = 'none';

                // Check both property names (camelCase/snake_case) and current input value
                const hasTelegram = driver.telegramChatId || driver.telegram_chat_id || document.getElementById('telegram-chat-id').value;

                if (hasTelegram) {
                    statusMsg.style.display = 'block';
                    statusMsg.innerHTML = '<i class="lucide-check-circle" style="width: 12px; height: 12px; vertical-align: middle;"></i> Connected to Telegram';
                    statusMsg.style.color = '#10b981';
                } else {
                    statusMsg.style.display = 'block';
                    statusMsg.innerHTML = '<i class="lucide-alert-circle" style="width: 12px; height: 12px; vertical-align: middle;"></i> Not connected';
                    statusMsg.style.color = '#f59e0b';
                }
            }

            // Dispatch preferences
            document.getElementById('preferred-channel').value = driver.preferredChannel || 'telegram';
            document.getElementById('fallback-enabled').checked = driver.fallbackEnabled !== false; // Default true

            document.getElementById('license-number').value = driver.licenseNumber || '';
            document.getElementById('license-class').value = driver.licenseClass || '';
            // Format date for input field (YYYY-MM-DD)
            document.getElementById('license-expiry').value = driver.licenseExpiry
                ? new Date(driver.licenseExpiry).toISOString().split('T')[0]
                : '';
            document.getElementById('driver-status').value = driver.status || 'active';
            document.getElementById('hire-date').value = driver.hireDate
                ? new Date(driver.hireDate).toISOString().split('T')[0]
                : '';
            document.getElementById('assigned-vehicle').value = driver.assignedVehicleId || '';
            document.getElementById('emergency-contact-name').value = driver.emergencyContactName || '';
            document.getElementById('emergency-contact-phone').value = driver.emergencyContactPhone || '';
            document.getElementById('driver-notes').value = driver.notes || '';

            // Set avatar preview
            if (driver.profileImageUrl) {
                document.getElementById('avatarImage').src = driver.profileImageUrl;
                document.getElementById('avatarImage').style.display = 'block';
                document.getElementById('avatarInitials').textContent = '';
                document.getElementById('removeAvatarBtn').style.display = 'inline-block';
            } else {
                const initials = getInitials(driver.firstName, driver.lastName);
                document.getElementById('avatarImage').style.display = 'none';
                document.getElementById('avatarInitials').textContent = initials;
                document.getElementById('removeAvatarBtn').style.display = 'none';
            }

            // Load tags
            currentDriverTags = driver.tags || [];
            renderDriverTagChips();

            document.getElementById('driver-modal').style.display = 'block';
        }

        // Close driver modal
        function closeDriverModal() {
            document.getElementById('driver-modal').style.display = 'none';
            editingDriverId = null;
            pendingAvatarFile = null;
        }

        // Save driver (create or update)
        async function saveDriver(event) {
            event.preventDefault();

            // Get vehicle selection (handled separately via assignToVehicle RPC)
            const selectedVehicleId = document.getElementById('assigned-vehicle').value || null;

            const formData = {
                first_name: document.getElementById('first-name').value,
                last_name: document.getElementById('last-name').value,
                phone_number: document.getElementById('phone-number').value || null,
                email: document.getElementById('email').value || null,
                // telegram_chat_id is NOT included - managed by Telegram registration flow only
                license_number: document.getElementById('license-number').value || null,
                license_class: document.getElementById('license-class').value || null,
                license_expiry: document.getElementById('license-expiry').value || null,
                status: document.getElementById('driver-status').value,
                hire_date: document.getElementById('hire-date').value || null,
                // Note: assigned_vehicle_id is NOT included - handled via assignToVehicle RPC
                emergency_contact_name: document.getElementById('emergency-contact-name').value || null,
                emergency_contact_phone: document.getElementById('emergency-contact-phone').value || null,
                notes: document.getElementById('driver-notes').value || null,
                tags: currentDriverTags
            };

            try {
                let driverId;

                if (editingDriverId) {
                    const existingDriver = drivers.find(d => d.id === editingDriverId);
                    // When updating, preserve existing profile_image_url if not uploading a new one
                    if (existingDriver && existingDriver.profileImageUrl && !pendingAvatarFile) {
                        formData.profile_image_url = existingDriver.profileImageUrl;
                    }

                    // Add dispatch preferences to update
                    formData.preferred_channel = document.getElementById('preferred-channel').value;
                    formData.fallback_enabled = document.getElementById('fallback-enabled').checked;

                    // Update existing driver
                    await window.apiClient.drivers.update({ id: editingDriverId, ...formData });
                    driverId = editingDriverId;

                    // Handle vehicle assignment change
                    const currentVehicleId = existingDriver?.assignedVehicleId || null;
                    if (selectedVehicleId !== currentVehicleId) {
                        if (selectedVehicleId) {
                            // Assign to new vehicle
                            await window.apiClient.drivers.assignToVehicle({ driverId, vehicleId: selectedVehicleId });
                        } else if (currentVehicleId) {
                            // Unassign from current vehicle
                            await window.apiClient.drivers.unassignFromVehicle({ driverId });
                        }
                    }

                    showToast('Driver updated successfully', 'success');
                } else {
                    // Create new driver
                    formData.preferred_channel = document.getElementById('preferred-channel').value;
                    formData.fallback_enabled = document.getElementById('fallback-enabled').checked;

                    const result = await window.apiClient.drivers.create(formData);
                    driverId = result.data?.id || result.id;

                    // Assign to vehicle if selected
                    if (selectedVehicleId && driverId) {
                        await window.apiClient.drivers.assignToVehicle({ driverId, vehicleId: selectedVehicleId });
                    }

                    showToast('Driver created successfully', 'success');
                }

                // Upload avatar if pending
                if (pendingAvatarFile && driverId) {
                    try {
                        await uploadAvatar(driverId);
                    } catch (avatarError) {
                        console.error('Failed to upload avatar:', avatarError);
                        showToast('Driver saved but avatar upload failed', 'error');
                    }
                }

                closeDriverModal();
                await loadDrivers();
            } catch (error) {
                console.error('Failed to save driver:', error);
                showToast('Failed to save driver: ' + error.message, 'error');
            }
        }

        // Delete driver
        async function deleteDriver(driverId) {
            const driver = drivers.find(d => d.id === driverId);
            if (!driver) return;

            const driverName = `${driver.firstName} ${driver.lastName}`;
            if (!await showConfirm(`Are you sure you want to delete driver ${driverName}?`, 'Delete Driver', 'Delete', 'Cancel')) return;

            try {
                await window.apiClient.drivers.delete({ id: driverId });
                showToast('Driver deleted successfully', 'success');
                await loadDrivers();
            } catch (error) {
                console.error('Failed to delete driver:', error);
                showToast('Failed to delete driver: ' + error.message, 'error');
            }
        }

        // Update pagination UI
        function updatePagination() {
            const totalPages = Math.ceil(totalDrivers / pageSize);
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, totalDrivers);

            document.getElementById('pagination-info').textContent =
                `${start}-${end} of ${totalDrivers}`;

            document.getElementById('prev-page-btn').disabled = currentPage === 1;
            document.getElementById('next-page-btn').disabled = currentPage >= totalPages;
        }

        // Go to specific page
        function goToPage(page) {
            const totalPages = Math.ceil(totalDrivers / pageSize);
            if (page < 1 || page > totalPages) return;

            currentPage = page;
            loadDrivers();
        }

        // Avatar upload functions
        function setupAvatarUpload() {
            const input = document.getElementById('avatarInput');
            const uploadBtn = document.getElementById('uploadAvatarBtn');
            const removeBtn = document.getElementById('removeAvatarBtn');

            uploadBtn.addEventListener('click', () => input.click());
            input.addEventListener('change', handleAvatarSelect);
            removeBtn.addEventListener('click', handleAvatarRemove);
        }

        function handleAvatarSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('Invalid file type. Please upload JPEG, PNG, or WebP image.');
                e.target.value = '';
                return;
            }

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File too large. Maximum size is 5MB.');
                e.target.value = '';
                return;
            }

            // Preview the image
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('avatarImage').src = e.target.result;
                document.getElementById('avatarImage').style.display = 'block';
                document.getElementById('avatarInitials').textContent = '';
                document.getElementById('removeAvatarBtn').style.display = 'inline-block';
            };
            reader.readAsDataURL(file);

            pendingAvatarFile = file; // Store for upload on save
        }

        function handleAvatarRemove() {
            // Clear preview
            document.getElementById('avatarImage').src = '';
            document.getElementById('avatarImage').style.display = 'none';
            document.getElementById('removeAvatarBtn').style.display = 'none';

            // Show initials if editing existing driver
            if (editingDriverId) {
                const driver = drivers.find(d => d.id === editingDriverId);
                if (driver) {
                    const initials = getInitials(driver.first_name, driver.last_name);
                    document.getElementById('avatarInitials').textContent = initials;
                }
            }

            // Clear file input and pending file
            document.getElementById('avatarInput').value = '';
            pendingAvatarFile = null;

            // If editing, mark for avatar deletion on save
            if (editingDriverId) {
                // Will be handled by deleteAvatar() when saving
            }
        }

        async function uploadAvatar(driverId) {
            if (!pendingAvatarFile) return null;

            try {
                const formData = new FormData();
                formData.append('avatar', pendingAvatarFile);

                const response = await fetch(`/api/drivers/${driverId}/avatar`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (!result.success) throw new Error(result.error || 'Avatar upload failed');

                pendingAvatarFile = null;
                return result.data?.avatarUrl || result.data?.avatar_url;
            } catch (error) {
                console.error('Failed to upload avatar:', error);
                throw error;
            }
        }

        async function deleteAvatar(driverId) {
            try {
                const response = await fetch(`/api/drivers/${driverId}/avatar`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (!result.success) throw new Error(result.error || 'Avatar deletion failed');

                return true;
            } catch (error) {
                console.error('Failed to delete avatar:', error);
                throw error;
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Load data
            loadDrivers();
            loadVehicles();

            // Setup avatar upload
            setupAvatarUpload();

            // Setup tag input
            setupDriverTagInput();

            // Add driver button
            document.getElementById('add-driver-btn').addEventListener('click', openAddDriverModal);

            // Search input with debounce
            document.getElementById('search-input').addEventListener('input', debounce((e) => {
                searchTerm = e.target.value.trim();
                currentPage = 1; // Reset to first page
                loadDrivers();
            }, 300));

            // Status filter
            document.getElementById('status-filter').addEventListener('change', (e) => {
                statusFilter = e.target.value;
                currentPage = 1; // Reset to first page
                loadDrivers();
            });

            // Close modal buttons
            document.querySelectorAll('.close-modal, .close-modal-btn').forEach(btn => {
                btn.addEventListener('click', closeDriverModal);
            });

            // Form submit
            document.getElementById('driver-form').addEventListener('submit', saveDriver);

            // Pagination
            document.getElementById('prev-page-btn').addEventListener('click', () => goToPage(currentPage - 1));
            document.getElementById('next-page-btn').addEventListener('click', () => goToPage(currentPage + 1));

            // Rows per page
            document.getElementById('rows-select').addEventListener('change', (e) => {
                pageSize = parseInt(e.target.value);
                currentPage = 1;
                loadDrivers();
            });

            // Modal click outside to close
            document.getElementById('driver-modal').addEventListener('click', (e) => {
                if (e.target.id === 'driver-modal') {
                    closeDriverModal();
                }
            });
        });

        // Vehicle assignment modal functions
        function populateVehicleDropdown(selectId, currentVehicleId = null) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- No Vehicle Assigned --</option>';

            vehicles.forEach(v => {
                // Show vehicle name and current assignment status
                const assignedTo = v.assignedDriverId ? ' (Assigned)' : '';
                const option = document.createElement('option');
                option.value = v.id;
                option.textContent = `${v.name || (v.make + ' ' + v.model)} (${v.licensePlate || 'No Plate'})${assignedTo}`;
                if (v.id === currentVehicleId) option.selected = true;
                select.appendChild(option);
            });
        }

        function openVehicleAssignModal(driverId, driverName) {
            document.getElementById('assign-driver-name').textContent = driverName;
            document.getElementById('vehicle-assign-modal').dataset.driverId = driverId;

            // Find driver's current vehicle
            const driver = drivers.find(d => d.id === driverId);
            populateVehicleDropdown('vehicle-select', driver?.assignedVehicleId);

            document.getElementById('vehicle-assign-modal').style.display = 'block';
        }

        function closeVehicleAssignModal() {
            document.getElementById('vehicle-assign-modal').style.display = 'none';
        }

        async function confirmVehicleAssignment() {
            const driverId = document.getElementById('vehicle-assign-modal').dataset.driverId;
            const vehicleId = document.getElementById('vehicle-select').value;

            try {
                if (vehicleId) {
                    await window.apiClient.drivers.assignToVehicle({ driverId, vehicleId });
                    showToast('Vehicle assigned successfully', 'success');
                } else {
                    // Unassign - need to remove vehicle assignment
                    await window.apiClient.drivers.unassignFromVehicle({ driverId });
                    showToast('Vehicle unassigned', 'success');
                }
                closeVehicleAssignModal();
                await loadDrivers(); // Refresh table
            } catch (error) {
                console.error('Failed to assign vehicle:', error);
                showToast('Failed to assign vehicle: ' + error.message, 'error');
            }
        }

        // Telegram Registration Logic
        let currentRegistrationLink = '';
        let registrationPollInterval = null;

        async function showTelegramQrCode() {
            if (!editingDriverId) {
                showToast('Please save the driver first', 'error');
                return;
            }

            document.getElementById('qr-modal').style.display = 'block';
            document.getElementById('qr-code-container').innerHTML = '<div class="loading-spinner"></div>';
            document.getElementById('qr-status-message').textContent = 'Waiting for connection...';
            document.getElementById('qr-status-message').className = 'status-waiting';

            try {
                // Fetch registration link from backend
                const response = await fetch(`/dispatch/api/v1/telegram/registration/${editingDriverId}`, {
                    credentials: 'same-origin'
                });
                if (!response.ok) throw new Error('Failed to get registration link');

                const data = await response.json();

                // Backend returns flat object: { registrationLink, qrCodeUrl, ... }
                if (!data.registrationLink) throw new Error('Invalid registration data received');

                const link = data.registrationLink;
                currentRegistrationLink = link;

                // Update UI
                document.getElementById('registration-link-input').value = link;
                document.getElementById('open-telegram-btn').href = link;

                // Use the server-generated QR code (data URI)
                if (data.qrCodeUrl) {
                    document.getElementById('qr-code-container').innerHTML = `
                        <img src="${data.qrCodeUrl}" alt="Telegram Registration QR Code" width="200" height="200" style="display: block;">
                    `;
                } else {
                    // Fallback to external API if server side failed for some reason (shouldn't happen with new backend)
                    const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(link)}`;
                    document.getElementById('qr-code-container').innerHTML = `
                        <img src="${qrUrl}" alt="Telegram Registration QR Code" width="200" height="200" style="display: block;">
                    `;
                }

                // Start polling for connection
                startRegistrationPolling(editingDriverId);

            } catch (error) {
                console.error('QR Code Error:', error);
                document.getElementById('qr-code-container').innerHTML = `
                    <div style="color: var(--danger-color); padding: 20px;">
                        <i class="lucide-alert-circle" style="margin-bottom: 8px;"></i><br>
                        Failed to load registration link
                    </div>
                `;
                showToast('Failed to generate registration link', 'error');
            }
        }

        function startRegistrationPolling(driverId) {
            // Clear existing poll if any
            if (registrationPollInterval) clearInterval(registrationPollInterval);

            let attempts = 0;
            const maxAttempts = 60; // 2 minutes (assuming 2s interval)

            registrationPollInterval = setInterval(async () => {
                attempts++;
                if (attempts > maxAttempts) {
                    clearInterval(registrationPollInterval);
                    return; // Stop polling after timeout
                }

                try {
                    // Fetch fresh driver data
                    const driver = await window.apiClient.drivers.getById({ id: driverId });

                    if (driver && (driver.telegramChatId || driver.telegram_chat_id)) {
                        // Connected!
                        clearInterval(registrationPollInterval);

                        // Update local drivers array
                        const localDriver = drivers.find(d => d.id === driverId);
                        if (localDriver) {
                            localDriver.telegramChatId = driver.telegramChatId || driver.telegram_chat_id;
                        }

                        // Update QR Modal UI
                        const qrStatus = document.getElementById('qr-status-message');
                        if (qrStatus) {
                            qrStatus.innerHTML = '<i class="lucide-check-circle"></i> Connected Successfully!';
                            qrStatus.className = 'status-connected';
                        }
                        // Close QR modal after a brief delay if it's open (optional, maybe better to let user close)
                        // setTimeout(closeQrModal, 2000);

                        // Update Edit Modal UI
                        const statusMsg = document.getElementById('telegram-status-msg');
                        if (statusMsg) {
                            statusMsg.style.display = 'block';
                            statusMsg.innerHTML = '<i class="lucide-check-circle" style="width: 12px; height: 12px; vertical-align: middle;"></i> Connected to Telegram';
                            statusMsg.style.color = '#10b981';
                        }

                        showToast('Driver successfully connected to Telegram!', 'success');
                    }
                } catch (err) {
                    console.error('Polling error:', err);
                    // Don't stop polling on transient errors
                }
            }, 2000); // Poll every 2 seconds
        }

        function closeQrModal() {
            document.getElementById('qr-modal').style.display = 'none';
            if (registrationPollInterval) clearInterval(registrationPollInterval);
        }

        function copyRegistrationLink() {
            const input = document.getElementById('registration-link-input');
            input.select();
            document.execCommand('copy');
            showToast('Link copied to clipboard', 'success');
        }

        async function sendTelegramRegistrationEmail() {
            if (!editingDriverId) return;

            // Simple confirmation
            // Simple confirmation
            if (!await showConfirm('Send registration instructions to driver via email?', 'Send Email', 'Send', 'Cancel')) return;

            try {
                const response = await fetch('/dispatch/api/v1/telegram/send-registration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ driverId: editingDriverId }),
                    credentials: 'same-origin'
                });

                const result = await response.json();
                if (result.success) {
                    showToast('Registration email sent successfully', 'success');
                    // Start polling since they might click the email link soon
                    startRegistrationPolling(editingDriverId);
                } else {
                    throw new Error(result.message || 'Failed to send email');
                }
            } catch (error) {
                console.error('Email Error:', error);
                showToast('Failed to send email: ' + error.message, 'error');
            }
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('driver-modal');
            const qrModal = document.getElementById('qr-modal');
            const vehicleModal = document.getElementById('vehicle-assign-modal');

            if (event.target == modal) {
                closeDriverModal();
            }
            if (event.target == qrModal) {
                closeQrModal();
            }
            if (event.target == vehicleModal) {
                closeVehicleAssignModal();
            }
        }
    </script>

    <div id="qr-modal" class="modal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="modal-header">
                <h3 id="qr-modal-title">Telegram Registration</h3>
                <button class="close-btn" onclick="closeQrModal()">
                    <i class="lucide-x"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <p style="margin-bottom: 20px; color: var(--text-secondary);">
                    Scan this QR code with your phone or open the link to start the Telegram bot.
                </p>
                <div id="qr-code-container"
                    style="margin-bottom: 12px; background: white; padding: 16px; display: inline-block; border-radius: 8px; border: 1px solid var(--border-color);">
                    <!-- QR Image will be injected here -->
                    <div class="loading-spinner"></div>
                </div>
                <div id="qr-status-message" style="margin-bottom: 20px; min-height: 24px;"></div>
                <div class="form-group">
                    <label>Registration Link</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="registration-link-input" readonly style="margin-bottom: 0;">
                        <button class="btn btn-secondary" onclick="copyRegistrationLink()">
                            <i class="lucide-copy"></i>
                        </button>
                    </div>
                </div>
                <div style="margin-top: 24px;">
                    <a id="open-telegram-btn" href="#" target="_blank" class="btn btn-primary"
                        style="width: 100%; justify-content: center;">
                        <i class="lucide-send" style="margin-right: 8px;"></i> Open in Telegram
                    </a>
                </div>
            </div>
        </div>
    </div>
</body>

</html>