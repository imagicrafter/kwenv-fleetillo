<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptiRoute Dashboard (V1)</title>
    <!-- Use a modern Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>

<body class="dark-theme">
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <h1>OptiRoute<svg width="22" height="22" fill="none" stroke="var(--accent-success)" viewBox="0 0 24 24"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="display: inline-block; vertical-align: bottom; margin-left: 8px; margin-bottom: 2px;">
                        <circle cx="6" cy="19" r="3" />
                        <path d="M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15" />
                        <circle cx="18" cy="5" r="3" />
                    </svg></h1>
            </div>

            <nav class="nav-menu">
                <!-- Dashboard -->
                <a href="index.html" class="nav-item active">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                        </svg>
                    </span>
                    Dashboard
                </a>

                <!-- PLANNING -->
                <div class="menu-header">PLANNING</div>

                <a href="customers.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </span>
                    Customers
                </a>

                <a href="services.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                    </span>
                    Services
                </a>

                <a href="bookings.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                    </span>
                    Bookings
                </a>

                <a href="calendar.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </span>
                    Calendar
                </a>

                <a href="locations.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </span>
                    Locations
                </a>

                <!-- FLEET -->
                <div class="menu-header">FLEET</div>

                <a href="vehicles.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                    </span>
                    Vehicles
                </a>

                <a href="drivers.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </span>
                    Drivers
                </a>

                <!-- OPERATIONS -->
                <div class="menu-header">OPERATIONS</div>

                <a href="routes.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="6" cy="19" r="3" />
                            <path d="M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15" />
                            <circle cx="18" cy="5" r="3" />
                        </svg>
                    </span>
                    Routes
                </a>

                <a href="#" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </span>
                    Dispatch
                    <span class="badge new">New</span>
                </a>

                <!-- SYSTEM -->
                <div class="menu-header">SYSTEM</div>

                <a href="#" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                    </span>
                    Reports
                </a>

                <a href="settings.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </span>
                    Settings
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="avatar">JM</div>
                    <div class="details">
                        <span class="name">Admin User</span>
                        <span class="role">Administrator</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" placeholder="Search routes, drivers...">
                </div>
                <div class="actions">
                    <button class="btn-icon">üîî</button>
                    <!-- <button class="btn-primary">+ New Route</button> -->
                </div>
            </header>

            <div class="content-wrapper">
                <!-- Page Header -->
                <div class="page-header">
                    <div>
                        <span class="date" id="current-date"></span>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="card stat-card" onclick="window.location.href='bookings.html'">
                        <div class="stat-header primary">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <span class="label">Active Bookings</span>
                        </div>
                        <span class="stat-value" id="active-bookings-count">--</span>
                        <span class="trend positive" style="display: none;">‚Üë --% vs. --</span>
                    </div>
                    <div class="card stat-card" onclick="window.location.href='routes.html'">
                        <div class="stat-header success">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="6" cy="19" r="3" />
                                <path d="M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15" />
                                <circle cx="18" cy="5" r="3" />
                            </svg>
                            <span class="label">Active Routes</span>
                        </div>
                        <span class="stat-value" id="active-routes-count">--</span>
                        <span class="trend positive" style="display: none;">‚Üë --% vs. --</span>
                    </div>
                    <div class="card stat-card" onclick="window.location.href='vehicles.html'">
                        <div class="stat-header primary">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                            </svg>
                            <span class="label">Active Vehicles</span>
                        </div>
                        <span class="stat-value" id="active-vehicles-count">--</span>
                        <span class="trend positive" style="display: none;">‚Üë --% vs. --</span>
                    </div>
                    <div class="card stat-card" onclick="window.location.href='customers.html'">
                        <div class="stat-header muted">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                            </svg>
                            <span class="label">Active Customers</span>
                        </div>
                        <span class="stat-value" id="active-customers-count">--</span>
                        <span class="trend positive" style="display: none;">‚Üë --% vs. --</span>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions-section">
                    <div class="card">
                        <div class="card-header">
                            <h3>Quick Actions</h3>
                        </div>
                        <div class="quick-actions-grid">
                            <button class="quick-action-btn primary"
                                onclick="window.location.href='bookings.html?action=new'">
                                <span class="action-icon">
                                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4" />
                                    </svg>
                                </span>
                                <span class="action-label">New Booking</span>
                            </button>
                            <button class="quick-action-btn secondary"
                                onclick="window.location.href='customers.html?action=new'">
                                <span class="action-icon">
                                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                                    </svg>
                                </span>
                                <span class="action-label">New Client</span>
                            </button>
                            <button class="quick-action-btn success"
                                onclick="window.location.href='routes.html?action=plan'">
                                <span class="action-icon">
                                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="6" cy="19" r="3" />
                                        <path d="M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15" />
                                        <circle cx="18" cy="5" r="3" />
                                    </svg>
                                </span>
                                <span class="action-label">Plan Routes</span>
                            </button>
                            <button class="quick-action-btn info" onclick="window.location.href='routes.html'">
                                <span class="action-icon">
                                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                                    </svg>
                                </span>
                                <span class="action-label">Today's Routes</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Main Dashboard Section -->
                <div class="dashboard-split">
                    <div class="card chart-section chat-widget">
                        <div class="card-header">
                            <h3>OptiRoute Assistant</h3>
                            <span class="assistant-status">
                                <span class="status-dot online"></span>
                                Online
                            </span>
                        </div>
                        <div class="chat-container" id="chat-container">
                            <div class="chat-messages" id="chat-messages">
                                <div class="chat-message assistant">
                                    <div class="message-bubble">
                                        Hi! I'm your OptiRoute assistant. I can help you with bookings, routes,
                                        customers, vehicles, and services. What would you like to know?
                                    </div>
                                    <div class="suggestions-container">
                                        <button class="suggestion-chip">How do I add a booking?</button>
                                        <button class="suggestion-chip">Plan routes for today</button>
                                        <button class="suggestion-chip">Show active vehicles</button>
                                    </div>
                                </div>
                            </div>
                            <div class="chat-input-container">
                                <input type="text" id="chat-input" class="chat-input"
                                    placeholder="Ask about bookings, routes, customers..." autocomplete="off">
                                <button id="chat-send-btn" class="chat-send-btn" title="Send message">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card recent-activity">
                        <div class="card-header">
                            <h3>Recent Activity</h3>
                        </div>
                        <ul class="activity-list" id="activity-list">
                            <li class="activity-item">
                                <span class="dot info"></span>
                                <div class="activity-text">
                                    <p>Loading activities...</p>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- System Info (From Electron) -->

            </div>
        </main>
    </div>
    <script src="preload.js"></script>
    <script>
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set current date
            const now = new Date();
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', dateOptions);

            loadDashboardStats();
        });

        async function loadDashboardStats() {
            try {
                // 1. Active Bookings (Scheduled or In Progress or Confirmed)
                const scheduledBookings = await window.electronAPI.bookings.count({ status: 'scheduled' });
                const confirmedBookings = await window.electronAPI.bookings.count({ status: 'confirmed' });
                const inProgressBookings = await window.electronAPI.bookings.count({ status: 'in_progress' });
                const activeBookingsCount = (scheduledBookings || 0) + (confirmedBookings || 0) + (inProgressBookings || 0);

                document.getElementById('active-bookings-count').textContent = activeBookingsCount;

                // 2. Active Routes (All routes for now)
                const routesCount = await window.electronAPI.routes.count({});
                document.getElementById('active-routes-count').textContent = routesCount || 0;

                // 3. Active Vehicles (status: 'available')
                const vehiclesCount = await window.electronAPI.vehicles.count({ status: 'available' });
                document.getElementById('active-vehicles-count').textContent = vehiclesCount || 0;

                // 4. Active Customers
                const customersCount = await window.electronAPI.clients.count({ status: 'active' });
                document.getElementById('active-customers-count').textContent = customersCount || 0;

            } catch (error) {
                console.error('Failed to load dashboard stats:', error);
            }
        }

        // Load recent activities
        async function loadRecentActivities() {
            const activityList = document.getElementById('activity-list');

            try {
                const activities = await window.electronAPI.activities.getRecent(5);

                if (!activities || activities.length === 0) {
                    activityList.innerHTML = `
                        <li class="activity-item">
                            <span class="dot info"></span>
                            <div class="activity-text">
                                <p>No recent activity</p>
                            </div>
                        </li>
                    `;
                    return;
                }

                activityList.innerHTML = activities.map(activity => `
                    <li class="activity-item">
                        <span class="dot ${getSeverityClass(activity.severity)}"></span>
                        <div class="activity-text">
                            <p>${escapeHtml(activity.title)}</p>
                            <small>${formatRelativeTime(activity.createdAt)}</small>
                        </div>
                    </li>
                `).join('');

            } catch (error) {
                console.error('Failed to load activities:', error);
                activityList.innerHTML = `
                    <li class="activity-item">
                        <span class="dot warning"></span>
                        <div class="activity-text">
                            <p>Failed to load activities</p>
                        </div>
                    </li>
                `;
            }
        }

        // Map severity to CSS class
        function getSeverityClass(severity) {
            const classMap = {
                'success': 'success',
                'warning': 'warning',
                'error': 'error',
                'info': 'primary'
            };
            return classMap[severity] || 'primary';
        }

        // Format date as relative time
        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);

            if (diffSec < 60) return 'Just now';
            if (diffMin < 60) return `${diffMin} minute${diffMin !== 1 ? 's' : ''} ago`;
            if (diffHour < 24) return `${diffHour} hour${diffHour !== 1 ? 's' : ''} ago`;
            if (diffDay < 7) return `${diffDay} day${diffDay !== 1 ? 's' : ''} ago`;

            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load activities on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadRecentActivities();
            initializeChatWidget();
        });

        // ========================================
        // CHAT WIDGET FUNCTIONALITY
        // ========================================

        // Chat configuration - will be updated when Gradient agent is deployed
        const CHAT_CONFIG = {
            // Deployed Gradient Agent Endpoint
            endpoint: 'https://agents.do-ai.run/e7b58fd7-d32f-4d4c-bee0-adf3a7d0d8db/optiroute-support/run',
            apiKey: '',   // Security Note: In production, do not expose this key. Use a backend proxy.
            enabled: true
        };

        // Conversation history for context
        let conversationHistory = [];

        function initializeChatWidget() {
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send-btn');

            // Load history from session storage
            const savedHistory = sessionStorage.getItem('optiroute_chat_history');
            if (savedHistory) {
                try {
                    conversationHistory = JSON.parse(savedHistory);
                    conversationHistory.forEach(msg => {
                        addMessageToChat(msg.role, msg.content);
                    });
                } catch (e) {
                    console.error('Failed to load chat history', e);
                }
            }

            // Send on button click
            sendBtn.addEventListener('click', handleSendMessage);

            // Send on Enter key
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            });

            // Handle suggestion chips
            document.querySelectorAll('.suggestion-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    chatInput.value = chip.textContent;
                    handleSendMessage();
                });
            });
        }

        function saveChatHistory() {
            sessionStorage.setItem('optiroute_chat_history', JSON.stringify(conversationHistory));
        }

        async function handleSendMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();

            if (!message) return;

            // Clear input
            chatInput.value = '';

            // Add user message to UI
            addMessageToChat('user', message);

            // Add to history and save
            conversationHistory.push({ role: 'user', content: message });
            saveChatHistory();

            // Show typing indicator
            const typingId = showTypingIndicator();

            let assistantMessageDiv = null;
            let fullContent = '';

            try {
                // Stream response
                await streamAssistantResponse(message, (chunk) => {
                    if (!chunk) return;

                    // Remove typing indicator on first chunk
                    if (!assistantMessageDiv) {
                        removeTypingIndicator(typingId);
                        assistantMessageDiv = addMessageToChat('assistant', '');
                    }

                    fullContent += chunk;

                    // Update bubble content
                    const bubble = assistantMessageDiv.querySelector('.message-bubble');
                    if (bubble) {
                        bubble.innerHTML = formatMessageContent(fullContent);
                    }

                    // Auto-scroll
                    const messagesContainer = document.getElementById('chat-messages');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });

                // Add assistant response to history and save
                if (fullContent) {
                    conversationHistory.push({ role: 'assistant', content: fullContent });
                    saveChatHistory();
                }

                // Fallback if no chunks received
                if (!assistantMessageDiv) {
                    removeTypingIndicator(typingId);
                    addMessageToChat('assistant', 'I could not process that request.');
                }

            } catch (error) {
                console.error('Chat error:', error);
                removeTypingIndicator(typingId);
                addMessageToChat('assistant', 'Sorry, I encountered an error. Please try again.');
            }
        }

        // Format message content with basic markdown
        function formatMessageContent(content) {
            return escapeHtml(content)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        async function streamAssistantResponse(message, onChunk) {
            // Build conversation history from DOM for context
            const historyLimit = 10;
            const messagesContainer = document.getElementById('chat-messages');
            const conversationHistory = [];

            const previousMessages = messagesContainer.querySelectorAll('.chat-message');
            const startIdx = Math.max(0, previousMessages.length - historyLimit);

            for (let i = startIdx; i < previousMessages.length; i++) {
                const msg = previousMessages[i];
                if (msg.classList.contains('typing')) continue;

                const role = msg.classList.contains('user') ? 'user' : 'assistant';
                // Use innerText to get text content without HTML tags (approximate)
                const contentText = msg.innerText;
                conversationHistory.push({ role, content: contentText });
            }
            // Add current message
            conversationHistory.push({ role: 'user', content: message });

            // If agent is not configured, use local fallback
            if (!CHAT_CONFIG.enabled || !CHAT_CONFIG.endpoint) {
                const text = getLocalResponse(message);
                if (onChunk) onChunk(text);
                return;
            }

            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    endpoint: CHAT_CONFIG.endpoint,
                    messages: conversationHistory
                })
            });

            if (!response.ok) {
                const err = await response.json().catch(() => ({}));
                throw new Error(err.error || `API error: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                if (onChunk) onChunk(chunk);
            }
        }

        // Local fallback responses when agent is not deployed
        function getLocalResponse(message) {
            const lowerMessage = message.toLowerCase();

            // Simple keyword matching for demo
            if (lowerMessage.includes('booking') && (lowerMessage.includes('create') || lowerMessage.includes('new') || lowerMessage.includes('add'))) {
                return "To create a booking:\n\n1. Click **Bookings** in the sidebar\n2. Click **New Booking** button\n3. Select a customer and service\n4. Choose date and time\n5. Click **Save**\n\nNeed help with specific fields?";
            }

            if (lowerMessage.includes('customer') && (lowerMessage.includes('add') || lowerMessage.includes('new') || lowerMessage.includes('create'))) {
                return "To add a customer:\n\n1. Click **Customers** in the sidebar\n2. Click **New Customer** button\n3. Enter name, contact info, and address\n4. Set status to active\n5. Click **Save**";
            }

            if (lowerMessage.includes('route') && (lowerMessage.includes('plan') || lowerMessage.includes('create'))) {
                return "To plan routes:\n\n1. Click **Routes** in the sidebar\n2. Click **Plan Routes** button\n3. Select date range and vehicles\n4. The system will optimize stop order\n5. Review and click **Create Routes**";
            }

            if (lowerMessage.includes('vehicle')) {
                return "Vehicle management is under **Vehicles** in the sidebar. You can view status (available, in_use, maintenance), assign drivers, and track your fleet.";
            }

            if (lowerMessage.includes('service')) {
                return "Services are managed under **Services** in the sidebar. Each service has a name, duration estimate, and pricing. You can create new service types for your business.";
            }

            if (lowerMessage.includes('help') || lowerMessage.includes('what can')) {
                return "I can help you with:\n\n‚Ä¢ **Bookings** - creating, scheduling, status\n‚Ä¢ **Routes** - planning optimal routes\n‚Ä¢ **Customers** - managing client info\n‚Ä¢ **Vehicles** - fleet status\n‚Ä¢ **Services** - service types and pricing\n\nJust ask!";
            }

            return "I'd be happy to help! Try asking about:\n‚Ä¢ How to create a booking\n‚Ä¢ How to add a customer\n‚Ä¢ How to plan routes\n‚Ä¢ Vehicle management\n‚Ä¢ Service configuration";
        }

        function addMessageToChat(role, content) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;

            messageDiv.innerHTML = `<div class="message-bubble">${formatMessageContent(content)}</div>`;
            messagesContainer.appendChild(messageDiv);

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            return messageDiv;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            const typingId = 'typing-' + Date.now();
            typingDiv.id = typingId;
            typingDiv.className = 'chat-message assistant typing';
            typingDiv.innerHTML = `
                <div class="message-bubble">
                    <span class="typing-dots">
                        <span></span><span></span><span></span>
                    </span>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return typingId;
        }

        function removeTypingIndicator(typingId) {
            const typingDiv = document.getElementById(typingId);
            if (typingDiv) {
                typingDiv.remove();
            }
        }
    </script>
</body>

</html>