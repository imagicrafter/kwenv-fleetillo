<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locations - OptiRoute</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .nav-group.expanded .nav-children {
            display: flex;
        }

        /* Address Autocomplete Styles */
        .address-search-container {
            position: relative;
        }

        .address-input-wrapper {
            position: relative;
        }

        .address-input-wrapper input {
            padding-right: 40px;
        }

        .address-status {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
        }

        .address-status.verified {
            color: #3fb950;
        }

        .address-status.pending {
            color: #d29922;
        }

        .address-status.error {
            color: #f85149;
        }

        .autocomplete-dropdown {
            display: none;
            position: absolute;
            width: 100%;
            top: 100%;
            left: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            margin-top: 4px;
        }

        .autocomplete-dropdown.active {
            display: block;
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-subtle);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .autocomplete-item .main-text {
            font-weight: 500;
            color: var(--text-primary);
        }

        .autocomplete-item .secondary-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .autocomplete-loading {
            padding: 16px;
            text-align: center;
            color: var(--text-secondary);
        }

        .manual-entry-toggle {
            margin-top: 8px;
            font-size: 0.85rem;
        }

        .manual-entry-toggle a {
            color: var(--accent-color);
            cursor: pointer;
            text-decoration: none;
        }

        .manual-entry-toggle a:hover {
            text-decoration: underline;
        }

        .manual-fields {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .manual-fields.active {
            display: block;
        }

        .coords-display {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 8px;
            font-family: monospace;
        }

        .coords-display.verified {
            color: #3fb950;
        }

        /* Layout Fixes for Main Page Scrolling */
        html,
        body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        .app-container {
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .main-content {
            flex: 1;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%;
            padding-bottom: 0 !important;
        }

        .table-container {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            border-bottom: none !important;
        }

        .data-table thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--bg-card);
        }

        .pagination-footer {
            flex-shrink: 0;
            background-color: var(--bg-card);
            border-top: 1px solid var(--border-color);
            z-index: 20;
        }
    </style>
    <style>
        /* Action Buttons & Tooltips */
        .action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            color: var(--text-secondary);
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 0 2px;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .action-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Tooltip */
        .action-btn::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.75rem;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-bottom: 8px;
            z-index: 100;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            font-weight: 500;
        }

        .action-btn:hover::after {
            opacity: 1;
        }
    </style>
</head>

<body class="dark-theme">
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <h1>OptiRoute<svg width="22" height="22" fill="none" stroke="var(--accent-success)" viewBox="0 0 24 24"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="display: inline-block; vertical-align: bottom; margin-left: 8px; margin-bottom: 2px;">
                        <circle cx="6" cy="19" r="3" />
                        <path d="M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15" />
                        <circle cx="18" cy="5" r="3" />
                    </svg></h1>
            </div>

            <nav class="nav-menu">
                <!-- Dashboard -->
                <a href="index.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                        </svg>
                    </span>
                    Dashboard
                </a>

                <!-- PLANNING -->
                <div class="menu-header">PLANNING</div>

                <a href="customers.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </span>
                    Customers
                </a>

                <a href="services.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                    </span>
                    Services
                </a>

                <a href="bookings.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                    </span>
                    Bookings
                </a>

                <a href="calendar.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </span>
                    Calendar
                </a>

                <a href="locations.html" class="nav-item active">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </span>
                    Locations
                </a>

                <!-- FLEET -->
                <div class="menu-header">FLEET</div>

                <a href="vehicles.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                    </span>
                    Vehicles
                </a>

                <a href="drivers.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </span>
                    Drivers
                </a>

                <!-- OPERATIONS -->
                <div class="menu-header">OPERATIONS</div>

                <a href="routes.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="6" cy="19" r="3" />
                            <path d="M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15" />
                            <circle cx="18" cy="5" r="3" />
                        </svg>
                    </span>
                    Routes
                </a>

                <a href="dispatch.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </span>
                    Dispatch
                    <span class="badge new">New</span>
                </a>

                <!-- SYSTEM -->
                <div class="menu-header">SYSTEM</div>

                <a href="#" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                    </span>
                    Reports
                </a>

                <a href="settings.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </span>
                    Settings
                </a>
            </nav>
            <script>
                // Auto-expand current group if any
                document.addEventListener('DOMContentLoaded', () => {
                    const activeLink = document.querySelector('.nav-item.active');
                    if (activeLink) {
                        // Ensure it's visible, though flatter structure makes this simpler
                    }
                });
            </script>


            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="avatar">JM</div>
                    <div class="details">
                        <span class="name">Admin User</span>
                        <span class="role">Administrator</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" id="search-input" placeholder="Search locations...">
                </div>
                <div class="actions">
                    <div class="filter-dropdown">
                        <select id="type-filter" class="filter-select">
                            <option value="">All Types</option>
                            <option value="client">Client</option>
                            <option value="depot">Depot</option>
                            <option value="disposal">Disposal</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="home">Home</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <button class="btn-primary" id="add-location-btn">+ New Location</button>
                </div>
            </header>

            <div class="content-wrapper">
                <div class="page-header">
                    <h2>Locations</h2>
                    <span class="date" id="current-date">October 24, 2025</span>
                </div>

                <div class="card table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name/Type</th>
                                <th>Address</th>
                                <th>Client (Optional)</th>
                                <th>City/State</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="locations-table-body">
                            <!-- Dynamic Content -->
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 20px;">Loading locations...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Footer -->
                <div class="pagination-footer"
                    style="padding: 16px 20px; border-top: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between;">
                    <div class="rows-per-page">
                        <label for="rows-select" style="margin-right: 8px; color: var(--text-secondary);">Rows per
                            page:</label>
                        <select id="rows-select"
                            style="background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); color: var(--text-primary); border-radius: 4px; padding: 4px 8px;">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="pagination-controls" style="display: flex; align-items: center; gap: 16px;">
                        <span id="pagination-info" style="color: var(--text-secondary); font-size: 0.9rem;">0-0 of
                            0</span>
                        <div class="page-nav">
                            <button id="prev-page-btn" class="action-btn" style="padding: 4px 8px;"
                                disabled>Previous</button>
                            <button id="next-page-btn" class="action-btn" style="padding: 4px 8px;"
                                disabled>Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Location Modal -->
    <div id="add-location-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="modal-title">Add New Location</h3>
                <span class="close-modal">&times;</span>
            </div>
            <form id="location-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="location-name">Location Name *</label>
                        <input type="text" id="location-name" required placeholder="e.g. Main Depot">
                    </div>
                    <div class="form-group">
                        <label for="location-type">Type *</label>
                        <select id="location-type" required>
                            <option value="client">Client</option>
                            <option value="depot">Depot</option>
                            <option value="disposal">Disposal</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="home">Home</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>

                <!-- Client Selection Section -->
                <div class="form-group" id="client-association-section"
                    style="padding: 12px; border: 1px solid var(--border-subtle); border-radius: 8px; background: rgba(0,0,0,0.1);">
                    <label style="margin-bottom: 8px;">Associated Client</label>
                    <div style="display: flex; gap: 16px; margin-bottom: 12px;">
                        <label style="font-weight: normal; cursor: pointer;">
                            <input type="radio" name="client-mode" value="existing" checked id="mode-existing"> Existing
                            Client
                        </label>
                        <label style="font-weight: normal; cursor: pointer;">
                            <input type="radio" name="client-mode" value="new" id="mode-new"> New Client
                        </label>
                    </div>

                    <!-- Existing Client Search -->
                    <div id="existing-client-section">
                        <div style="position: relative;">
                            <input type="text" id="client-search" placeholder="Search client by name, email...">
                            <input type="hidden" id="selected-client-id">
                            <div id="client-search-results"
                                style="display: none; position: absolute; width: 100%; top: 100%; background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 6px; z-index: 10; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                            </div>
                        </div>
                        <div id="selected-client-display"
                            style="display: none; margin-top: 8px; padding: 6px 12px; background: rgba(88, 166, 255, 0.1); border-radius: 4px; font-size: 0.9rem; align-items: center; justify-content: space-between;">
                            <span id="selected-client-name"></span>
                            <button type="button" id="clear-client-btn"
                                style="background:none; border:none; color: var(--text-secondary); cursor: pointer;">‚úï</button>
                        </div>
                    </div>

                    <!-- New Client Form -->
                    <div id="new-client-section" style="display: none;">
                        <input type="text" id="new-client-name" placeholder="Client Name *" style="margin-bottom: 8px;">
                        <div class="form-grid" style="gap: 8px;">
                            <input type="email" id="new-client-email" placeholder="Email">
                            <input type="tel" id="new-client-phone" placeholder="Phone">
                        </div>
                        <small style="color: var(--text-secondary); display: block; margin-top: 4px;">Location address
                            below will be set as primary address.</small>
                    </div>
                </div>

                <!-- Address Search (Unified) -->
                <div class="form-group address-search-container">
                    <label for="address-search">Address *</label>
                    <div class="address-input-wrapper">
                        <input type="text" id="address-search" required placeholder="Start typing an address..."
                            autocomplete="off">
                        <span class="address-status" id="address-status"></span>
                    </div>
                    <div class="autocomplete-dropdown" id="autocomplete-dropdown"></div>
                    <div class="coords-display" id="coords-display"></div>
                    <div class="manual-entry-toggle">
                        <a id="toggle-manual-entry">Enter address manually</a>
                    </div>
                </div>

                <!-- Hidden coordinate fields -->
                <input type="hidden" id="location-latitude">
                <input type="hidden" id="location-longitude">
                <input type="hidden" id="location-place-id">

                <!-- Manual Entry Fields (hidden by default) -->
                <div class="manual-fields" id="manual-fields">
                    <div class="form-group">
                        <label for="address-line1">Address Line 1</label>
                        <input type="text" id="address-line1" placeholder="Street Address">
                    </div>

                    <div class="form-group">
                        <label for="address-line2">Address Line 2</label>
                        <input type="text" id="address-line2" placeholder="Suite, Unit, etc.">
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="city">City</label>
                            <input type="text" id="city">
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <input type="text" id="state">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="postal-code">Postal Code</label>
                            <input type="text" id="postal-code">
                        </div>
                        <div class="form-group">
                            <label for="country">Country</label>
                            <input type="text" id="country" value="USA">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="is-primary"> Primary Location
                    </label>
                </div>

                <div class="form-group">
                    <label for="notes">Notes</label>
                    <textarea id="notes" rows="2"></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-text close-modal-btn">Cancel</button>
                    <button type="submit" class="btn-primary">Save Location</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="preload.js"></script>
    <script src="confirmation-modal.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Update date
            const dateElement = document.getElementById('current-date');
            if (dateElement) {
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                dateElement.textContent = new Date().toLocaleDateString('en-US', options);
            }

            const tableBody = document.getElementById('locations-table-body');
            const searchInput = document.getElementById('search-input');
            const typeFilter = document.getElementById('type-filter');
            const addBtn = document.getElementById('add-location-btn');
            const modal = document.getElementById('add-location-modal');
            const form = document.getElementById('location-form');
            const modalTitle = document.getElementById('modal-title');
            const closeButtons = document.querySelectorAll('.close-modal, .close-modal-btn');

            // Address Autocomplete Elements
            const addressSearchInput = document.getElementById('address-search');
            const autocompleteDropdown = document.getElementById('autocomplete-dropdown');
            const addressStatus = document.getElementById('address-status');
            const coordsDisplay = document.getElementById('coords-display');
            const toggleManualEntry = document.getElementById('toggle-manual-entry');
            const manualFields = document.getElementById('manual-fields');
            const latitudeInput = document.getElementById('location-latitude');
            const longitudeInput = document.getElementById('location-longitude');
            const placeIdInput = document.getElementById('location-place-id');

            // Manual address fields
            const addressLine1Input = document.getElementById('address-line1');
            const addressLine2Input = document.getElementById('address-line2');
            const cityInput = document.getElementById('city');
            const stateInput = document.getElementById('state');
            const postalCodeInput = document.getElementById('postal-code');
            const countryInput = document.getElementById('country');

            // Client Selection Elements
            const modeExisting = document.getElementById('mode-existing');
            const modeNew = document.getElementById('mode-new');
            const sectionExisting = document.getElementById('existing-client-section');
            const sectionNew = document.getElementById('new-client-section');
            const clientSearchInput = document.getElementById('client-search');
            const clientSearchResults = document.getElementById('client-search-results');
            const selectedClientDisplay = document.getElementById('selected-client-display');
            const selectedClientName = document.getElementById('selected-client-name');
            const clearClientBtn = document.getElementById('clear-client-btn');
            const selectedClientIdInput = document.getElementById('selected-client-id');
            const newClientName = document.getElementById('new-client-name');


            let autocompleteTimeout = null;
            let sessionToken = null;
            let currentPage = 1;
            let limit = 10;
            let totalItems = 0;

            const rowsSelect = document.getElementById('rows-select');
            const prevPageBtn = document.getElementById('prev-page-btn');
            const nextPageBtn = document.getElementById('next-page-btn');
            const paginationInfo = document.getElementById('pagination-info');

            // Generate session token for autocomplete
            function generateSessionToken() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            // Load initial data
            loadLocations();

            const locationTypeSelect = document.getElementById('location-type');
            const clientAssociationSection = document.getElementById('client-association-section');

            // ============ ADDRESS AUTOCOMPLETE ============

            // Toggle manual entry
            toggleManualEntry.addEventListener('click', (e) => {
                e.preventDefault();
                const isManual = manualFields.classList.toggle('active');
                toggleManualEntry.textContent = isManual ? 'Use address search' : 'Enter address manually';

                if (isManual) {
                    addressSearchInput.removeAttribute('required');
                    addressLine1Input.setAttribute('required', 'true');
                    cityInput.setAttribute('required', 'true');
                    stateInput.setAttribute('required', 'true');
                } else {
                    addressSearchInput.setAttribute('required', 'true');
                    addressLine1Input.removeAttribute('required');
                    cityInput.removeAttribute('required');
                    stateInput.removeAttribute('required');
                }
            });

            // Autocomplete input handler
            addressSearchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();

                // Clear previous timeout
                if (autocompleteTimeout) {
                    clearTimeout(autocompleteTimeout);
                }

                // Reset status
                addressStatus.textContent = '';
                addressStatus.className = 'address-status';

                if (query.length < 3) {
                    autocompleteDropdown.classList.remove('active');
                    return;
                }

                // Generate session token if not exists
                if (!sessionToken) {
                    sessionToken = generateSessionToken();
                }

                // Show loading
                addressStatus.textContent = '‚è≥';
                addressStatus.className = 'address-status pending';

                // Debounce API call
                autocompleteTimeout = setTimeout(async () => {
                    try {
                        const predictions = await window.electronAPI.geocoding.autocomplete({
                            input: query,
                            sessionToken: sessionToken,
                            types: ['address'],
                            region: 'us'
                        });

                        renderAutocompleteResults(predictions);
                    } catch (err) {
                        console.error('Autocomplete error:', err);
                        addressStatus.textContent = '‚ùå';
                        addressStatus.className = 'address-status error';
                        autocompleteDropdown.innerHTML = `<div class="autocomplete-loading" style="color: #f85149;">Error: ${err.message}</div>`;
                        autocompleteDropdown.classList.add('active');
                    }
                }, 300);
            });

            function renderAutocompleteResults(predictions) {
                autocompleteDropdown.innerHTML = '';

                if (!predictions || predictions.length === 0) {
                    autocompleteDropdown.innerHTML = '<div class="autocomplete-loading">No results found</div>';
                    autocompleteDropdown.classList.add('active');
                    addressStatus.textContent = '‚ö†Ô∏è';
                    addressStatus.className = 'address-status pending';
                    return;
                }

                predictions.forEach(prediction => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.innerHTML = `
                        <div class="main-text">${prediction.mainText}</div>
                        <div class="secondary-text">${prediction.secondaryText}</div>
                    `;
                    item.addEventListener('click', () => selectAddress(prediction));
                    autocompleteDropdown.appendChild(item);
                });

                autocompleteDropdown.classList.add('active');
                addressStatus.textContent = '';
            }

            async function selectAddress(prediction) {
                // Hide dropdown
                autocompleteDropdown.classList.remove('active');

                // Set search field value
                addressSearchInput.value = prediction.description;

                // Show loading
                addressStatus.textContent = '‚è≥';
                addressStatus.className = 'address-status pending';
                coordsDisplay.textContent = 'Geocoding address...';

                try {
                    // Geocode to get coordinates
                    const geocodeResult = await window.electronAPI.geocoding.geocodeAddress(prediction.description);

                    if (geocodeResult && geocodeResult.coordinates) {
                        const { latitude, longitude } = geocodeResult.coordinates;

                        // Store coordinates
                        latitudeInput.value = latitude;
                        longitudeInput.value = longitude;
                        placeIdInput.value = geocodeResult.placeId || '';

                        // Parse address components
                        parseAddressComponents(geocodeResult);

                        // Update UI
                        addressStatus.textContent = '‚úì';
                        addressStatus.className = 'address-status verified';
                        coordsDisplay.textContent = `üìç ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                        coordsDisplay.className = 'coords-display verified';

                        // Clear session token (session complete)
                        sessionToken = null;
                    } else {
                        throw new Error('No coordinates returned');
                    }
                } catch (err) {
                    console.error('Geocoding error:', err);
                    addressStatus.textContent = '‚ö†Ô∏è';
                    addressStatus.className = 'address-status error';
                    coordsDisplay.textContent = 'Could not geocode address. Please try again or enter manually.';
                    coordsDisplay.className = 'coords-display';
                }
            }

            function parseAddressComponents(geocodeResult) {
                // Parse address components from geocoding result
                const components = geocodeResult.addressComponents || [];

                const getComponent = (type) => {
                    const comp = components.find(c => c.types && c.types.includes(type));
                    return comp ? comp.longName : '';
                };

                const getShortComponent = (type) => {
                    const comp = components.find(c => c.types && c.types.includes(type));
                    return comp ? comp.shortName : '';
                };

                // Build address line 1
                const streetNumber = getComponent('street_number');
                const route = getComponent('route');
                addressLine1Input.value = [streetNumber, route].filter(Boolean).join(' ');

                // Other fields
                cityInput.value = getComponent('locality') || getComponent('sublocality');
                stateInput.value = getShortComponent('administrative_area_level_1');
                postalCodeInput.value = getComponent('postal_code');
                countryInput.value = getShortComponent('country') || 'USA';
            }

            // Close dropdown on click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.address-search-container')) {
                    autocompleteDropdown.classList.remove('active');
                }
            });

            // Reset session on focus
            addressSearchInput.addEventListener('focus', () => {
                sessionToken = generateSessionToken();
            });

            // ============ CLIENT SELECTION ============

            // Client Mode Toggle
            function toggleClientMode() {
                if (modeNew.checked) {
                    sectionExisting.style.display = 'none';
                    sectionNew.style.display = 'block';
                    newClientName.setAttribute('required', 'true');
                } else {
                    sectionExisting.style.display = 'block';
                    sectionNew.style.display = 'none';
                    newClientName.removeAttribute('required');
                }
            }
            modeExisting.addEventListener('change', toggleClientMode);
            modeNew.addEventListener('change', toggleClientMode);

            // Toggle Client Section Visibility based on Type
            function toggleClientSection() {
                if (locationTypeSelect.value === 'client') {
                    clientAssociationSection.style.display = 'block';
                    toggleClientMode();
                } else {
                    clientAssociationSection.style.display = 'none';
                    newClientName.removeAttribute('required');
                }
            }
            locationTypeSelect.addEventListener('change', toggleClientSection);

            // Client Search Logic
            let clientSearchTimeout;
            clientSearchInput.addEventListener('input', (e) => {
                clearTimeout(clientSearchTimeout);
                const term = e.target.value.trim();

                if (term.length < 2) {
                    clientSearchResults.style.display = 'none';
                    return;
                }

                clientSearchTimeout = setTimeout(async () => {
                    try {
                        const result = await window.electronAPI.clients.getAll({ searchTerm: term, limit: 5 });
                        const clients = result.data.data || result.data || [];
                        renderClientResults(clients);
                    } catch (err) {
                        console.error('Search failed', err);
                    }
                }, 300);
            });

            function renderClientResults(clients) {
                clientSearchResults.innerHTML = '';
                if (clients.length === 0) {
                    const div = document.createElement('div');
                    div.style.padding = '8px 12px';
                    div.style.color = 'var(--text-secondary)';
                    div.textContent = 'No clients found';
                    clientSearchResults.appendChild(div);
                } else {
                    clients.forEach(client => {
                        const div = document.createElement('div');
                        div.style.padding = '8px 12px';
                        div.style.cursor = 'pointer';
                        div.style.borderBottom = '1px solid var(--border-subtle)';
                        div.innerHTML = `<div style="font-weight:500">${client.name}</div><div style="font-size:0.8rem; color:var(--text-secondary)">${client.email || 'No email'}</div>`;
                        div.addEventListener('mouseover', () => div.style.backgroundColor = 'rgba(255,255,255,0.05)');
                        div.addEventListener('mouseout', () => div.style.backgroundColor = 'transparent');
                        div.addEventListener('click', () => {
                            selectClient(client);
                        });
                        clientSearchResults.appendChild(div);
                    });
                }
                clientSearchResults.style.display = 'block';
            }

            function selectClient(client) {
                selectedClientIdInput.value = client.id;
                selectedClientName.textContent = client.name;
                clientSearchInput.style.display = 'none';
                clientSearchResults.style.display = 'none';
                selectedClientDisplay.style.display = 'flex';
            }

            clearClientBtn.addEventListener('click', () => {
                selectedClientIdInput.value = '';
                selectedClientDisplay.style.display = 'none';
                clientSearchInput.style.display = 'block';
                clientSearchInput.value = '';
                clientSearchInput.focus();
            });

            // Close search dropdown on click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#existing-client-section')) {
                    clientSearchResults.style.display = 'none';
                }
            });


            // Event Listeners
            addBtn.addEventListener('click', () => openModal());

            closeButtons.forEach(btn => {
                btn.addEventListener('click', closeModal);
            });

            // Prevent clicks inside the modal content from bubbling
            const modalContent = document.querySelector('.modal-content');
            if (modalContent) {
                modalContent.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }

            // Prevent Enter key from submitting form, except on textareas
            form.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                }
            });

            form.addEventListener('submit', handleFormSubmit);

            // Search and Filter (Locations)
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    loadLocations();
                }, 300);
            });

            // Pagination Event Listeners
            if (rowsSelect) {
                rowsSelect.addEventListener('change', (e) => {
                    limit = parseInt(e.target.value);
                    currentPage = 1;
                    loadLocations();
                });
            }

            if (prevPageBtn) {
                prevPageBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        loadLocations();
                    }
                });
            }

            if (nextPageBtn) {
                nextPageBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(totalItems / limit);
                    if (currentPage < totalPages) {
                        currentPage++;
                        loadLocations();
                    }
                });
            }

            typeFilter.addEventListener('change', () => {
                currentPage = 1;
                loadLocations();
            });

            async function loadLocations() {
                try {
                    const filters = {};
                    if (searchInput.value) filters.searchTerm = searchInput.value;
                    if (typeFilter.value) filters.type = typeFilter.value;

                    const pagination = { page: currentPage, limit };

                    const response = await window.electronAPI.locations.getAll(filters, pagination);

                    let locations = [];
                    if (response.pagination) {
                        locations = response.data;
                        const meta = response.pagination;
                        totalItems = meta.total;
                        updatePaginationControls(meta);
                    } else if (response.data && response.data.data) {
                        // Double check structure if nested differently
                        locations = response.data.data;
                        const meta = response.data.pagination;
                        if (meta) {
                            totalItems = meta.total;
                            updatePaginationControls(meta);
                        } else {
                            totalItems = locations.length;
                            updatePaginationControls({ page: 1, limit: totalItems, total: totalItems, totalPages: 1 });
                        }
                    } else {
                        // Fallback
                        locations = response.data || response || [];
                        totalItems = locations.length;
                        updatePaginationControls({ page: 1, limit: totalItems, total: totalItems, totalPages: 1 });
                    }

                    renderTable(locations);
                } catch (error) {
                    console.error('Error loading locations:', error);
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--danger);">Error loading locations</td></tr>';
                }
            }

            function updatePaginationControls(meta) {
                if (!paginationInfo) return;

                const { page, limit, total, totalPages } = meta;
                const start = total === 0 ? 0 : (page - 1) * limit + 1;
                const end = Math.min(page * limit, total);

                paginationInfo.textContent = `${start}-${end} of ${total}`;

                if (prevPageBtn) prevPageBtn.disabled = page <= 1;
                if (nextPageBtn) nextPageBtn.disabled = page >= totalPages;
            }

            function renderTable(locations) {
                tableBody.innerHTML = '';

                if (!locations || locations.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">No locations found</td></tr>';
                    return;
                }

                locations.forEach(loc => {
                    const row = document.createElement('tr');

                    let badgeClass = 'inactive';
                    if (loc.locationType === 'client') badgeClass = 'active';
                    else if (loc.locationType === 'depot') badgeClass = 'success';
                    else if (loc.locationType === 'maintenance') badgeClass = 'warning';

                    const typeBadge = `<span class="status-badge ${badgeClass}">${loc.locationType}</span>`;

                    // Show coords indicator if available
                    const coordsIndicator = (loc.latitude && loc.longitude)
                        ? '<span style="color: #3fb950; font-size: 0.8rem;" title="Geocoded">üìç</span>'
                        : '<span style="color: #d29922; font-size: 0.8rem;" title="No coordinates">‚ö†Ô∏è</span>';

                    row.innerHTML = `
                        <td>
                            <div style="font-weight: 500;">${loc.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">${typeBadge}</div>
                        </td>
                        <td>
                            <div>${loc.addressLine1} ${coordsIndicator}</div>
                            ${loc.addressLine2 ? `<div style="font-size: 0.8rem; color: var(--text-secondary);">${loc.addressLine2}</div>` : ''}
                        </td>
                        <td>${loc.clientName ? `<div style="font-weight:500">${loc.clientName}</div>` : (loc.clientId ? `<span style="font-family: monospace; color: var(--text-secondary);">${loc.clientId.substr(0, 8)}...</span>` : '<span style="color: var(--text-secondary);">-</span>')}</td>
                        <td>${loc.city}, ${loc.state}</td>
                        <td>${loc.isPrimary ? '<span style="color: var(--success); font-size: 0.8rem;">‚òÖ Primary</span>' : '-'}</td>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <button class="action-btn edit-btn" data-id="${loc.id}" data-tooltip="Edit Location">
                                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button class="action-btn delete-btn" data-id="${loc.id}" data-tooltip="Delete Location">
                                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    `;

                    tableBody.appendChild(row);
                });

                // Attach Action Listeners
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        openEditModal(id);
                    });
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        deleteLocation(id);
                    });
                });
            }

            function openModal(mode = 'add', data = null) {
                modal.style.display = 'block';

                // Reset address autocomplete state
                sessionToken = generateSessionToken();
                autocompleteDropdown.classList.remove('active');
                addressStatus.textContent = '';
                coordsDisplay.textContent = '';
                manualFields.classList.remove('active');
                toggleManualEntry.textContent = 'Enter address manually';
                addressSearchInput.setAttribute('required', 'true');
                addressLine1Input.removeAttribute('required');
                cityInput.removeAttribute('required');
                stateInput.removeAttribute('required');

                if (mode === 'edit' && data) {
                    isEditing = true;
                    currentLocationId = data.id;
                    modalTitle.innerText = 'Edit Location';

                    document.getElementById('location-name').value = data.name || '';
                    document.getElementById('location-type').value = data.locationType || 'client';

                    // Client Handling for Edit
                    modeExisting.checked = true;

                    if (data.clientId) {
                        if (data.clientName) {
                            selectedClientIdInput.value = data.clientId;
                            selectedClientName.textContent = data.clientName;
                            clientSearchInput.style.display = 'none';
                            selectedClientDisplay.style.display = 'flex';
                        } else {
                            selectedClientIdInput.value = data.clientId;
                            selectedClientName.textContent = `Client ID: ${data.clientId.substr(0, 8)}...`;
                            clientSearchInput.style.display = 'none';
                            selectedClientDisplay.style.display = 'flex';
                        }
                    } else {
                        clearClientBtn.click();
                    }

                    // Address handling
                    const fullAddress = [data.addressLine1, data.city, data.state, data.postalCode].filter(Boolean).join(', ');
                    addressSearchInput.value = fullAddress;

                    addressLine1Input.value = data.addressLine1 || '';
                    addressLine2Input.value = data.addressLine2 || '';
                    cityInput.value = data.city || '';
                    stateInput.value = data.state || '';
                    postalCodeInput.value = data.postalCode || '';
                    countryInput.value = data.country || 'USA';

                    // Coordinates
                    if (data.latitude && data.longitude) {
                        latitudeInput.value = data.latitude;
                        longitudeInput.value = data.longitude;
                        addressStatus.textContent = '‚úì';
                        addressStatus.className = 'address-status verified';
                        coordsDisplay.textContent = `üìç ${data.latitude.toFixed(6)}, ${data.longitude.toFixed(6)}`;
                        coordsDisplay.className = 'coords-display verified';
                    }

                    document.getElementById('is-primary').checked = data.isPrimary || false;
                    document.getElementById('notes').value = data.notes || '';
                } else {
                    isEditing = false;
                    currentLocationId = null;
                    modalTitle.innerText = 'Add New Location';
                    form.reset();
                    // Set defaults
                    countryInput.value = 'USA';
                    document.getElementById('location-type').value = 'client';
                    modeExisting.checked = true;
                    clearClientBtn.click();
                    latitudeInput.value = '';
                    longitudeInput.value = '';
                    placeIdInput.value = '';
                }
                toggleClientSection();
            }

            function closeModal() {
                modal.style.display = 'none';
            }

            async function openEditModal(id) {
                try {
                    const response = await window.electronAPI.locations.getById(id);
                    const location = response.data || response;
                    if (location) {
                        openModal('edit', location);
                    }
                } catch (error) {
                    console.error('Error details:', error);
                    alert('Failed to fetch location details');
                }
            }

            async function deleteLocation(id) {
                if (await showConfirm('Are you sure you want to delete this location?', 'Delete Location', 'Delete', 'Cancel')) {
                    try {
                        const result = await window.electronAPI.locations.delete(id);
                        if (result) {
                            loadLocations();
                        } else {
                            alert('Failed to delete location');
                        }
                    } catch (error) {
                        console.error('Error deleting:', error);
                        alert('Error deleting location');
                    }
                }
            }

            async function handleFormSubmit(e) {
                e.preventDefault();

                let finalClientId = selectedClientIdInput.value || null;
                const isClientType = locationTypeSelect.value === 'client';

                // Handle Existing Client Mode Validation - ONLY if Client Type
                if (isClientType && modeExisting.checked) {
                    const searchTerm = clientSearchInput.value.trim();
                    if (!finalClientId && searchTerm.length > 0) {
                        alert('Please select a client from the search results or clear the search field.');
                        return;
                    }
                }

                // Handle New Client Creation - ONLY if Client Type
                if (isClientType && modeNew.checked) {
                    const name = document.getElementById('new-client-name').value;
                    const email = document.getElementById('new-client-email').value;
                    const phone = document.getElementById('new-client-phone').value;

                    if (!name) {
                        alert('Client Name is required');
                        return;
                    }

                    try {
                        const clientData = {
                            name,
                            email: email || undefined,
                            phoneNumber: phone || undefined,
                            addressLine1: addressLine1Input.value,
                            addressLine2: addressLine2Input.value,
                            city: cityInput.value,
                            state: stateInput.value,
                            postalCode: postalCodeInput.value,
                            country: countryInput.value
                        };

                        const response = await window.electronAPI.clients.create(clientData, { skipLocationCreation: true });
                        if (response && response.id) {
                            finalClientId = response.id;
                        } else if (response && response.data && response.data.id) {
                            finalClientId = response.data.id;
                        } else {
                            throw new Error('Failed to create client');
                        }
                    } catch (err) {
                        console.error('Client creation failed:', err);
                        alert('Failed to create new client: ' + err.message);
                        return;
                    }
                } else if (!isClientType) {
                    finalClientId = null;
                }

                const formData = {
                    name: document.getElementById('location-name').value,
                    locationType: document.getElementById('location-type').value,
                    clientId: finalClientId,
                    addressLine1: addressLine1Input.value,
                    addressLine2: addressLine2Input.value || null,
                    city: cityInput.value,
                    state: stateInput.value,
                    postalCode: postalCodeInput.value,
                    country: countryInput.value,
                    isPrimary: document.getElementById('is-primary').checked,
                    notes: document.getElementById('notes').value || null,
                    latitude: latitudeInput.value ? parseFloat(latitudeInput.value) : null,
                    longitude: longitudeInput.value ? parseFloat(longitudeInput.value) : null
                };

                try {
                    let result;
                    if (isEditing) {
                        formData.id = currentLocationId;
                        result = await window.electronAPI.locations.update(formData);
                    } else {
                        result = await window.electronAPI.locations.create(formData);
                    }

                    if (result) {
                        closeModal();
                        loadLocations();
                    }
                } catch (error) {
                    console.error('Error saving location:', error);
                    alert('Failed to save location. Check console for details.');
                }
            }
        });
    </script>
</body>

</html>