name: Secret Scanning

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  gitleaks:
    name: Scan for Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for gitleaks

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_UPLOAD_ARTIFACT: true
          GITLEAKS_ENABLE_SUMMARY: true

      - name: Upload Gitleaks Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: results.sarif
          retention-days: 30

      - name: Comment on PR (if secrets found)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.name,
              body: `## ‚ö†Ô∏è Secret Detection Alert

            **Gitleaks detected potential secrets in this PR.**

            ### Action Required
            1. Review the Gitleaks report in the workflow artifacts
            2. Remove any hardcoded secrets from the code
            3. Use environment variables or SECRET type in deployment specs
            4. Push updated code to re-trigger checks

            ### Resources
            - Secret management guide: \`deploy/SECRETS.md\`
            - Security guidelines: \`.claude/rules/security.md\`
            - Gitleaks report: Download from workflow artifacts

            **This PR cannot be merged until secrets are removed.**

            ---
            ü§ñ Automated secret scanning via GitHub Actions`
            })
