<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dispatch Management - Fleetillo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Specific styles for dispatch dashboard */
        .dispatch-timeline {
            position: relative;
            padding-left: 20px;
            margin-top: 10px;
        }

        .channel-stats {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-bar {
            background-color: var(--bg-card);
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .channel-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 4px;
        }
    </style>
</head>

<body class="dark-theme">
    <div class="app-container">
        <!-- Sidebar (matches routes.html but with active Dispatch) -->
        <aside class="sidebar">
            <div class="brand">
                <img src="assets/images/fleetillo_logo.png" alt="Fleetillo" style="height: 60px;">
            </div>

            <nav class="nav-menu">
                <a href="index.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
                        </svg>
                    </span>
                    Dashboard
                </a>

                <div class="menu-header">PLANNING</div>
                <a href="customers.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </span>
                    Customers
                </a>
                <a href="services.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                    </span>
                    Services
                </a>
                <a href="bookings.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                    </span>
                    Bookings
                </a>
                <a href="calendar.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </span>
                    Calendar
                </a>
                <a href="locations.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </span>
                    Locations
                </a>

                <div class="menu-header">FLEET</div>
                <a href="vehicles.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                    </span>
                    Vehicles
                </a>
                <a href="drivers.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </span>
                    Drivers
                </a>

                <div class="menu-header">OPERATIONS</div>
                <a href="routes.html" class="nav-item">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15" />
                        </svg>
                    </span>
                    Routes
                </a>

                <a href="dispatch.html" class="nav-item active">
                    <span class="icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </span>
                    Dispatch
                </a>

                <div class="menu-header">SYSTEM</div>
                <a href="#" class="nav-item">... Reports</a>
                <a href="settings.html" class="nav-item">... Settings</a>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="avatar">JM</div>
                    <div class="details">
                        <span class="name">Admin User</span>
                        <span class="role">Administrator</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" placeholder="Search dispatch history..." id="search-input">
                </div>
                <div class="actions">
                    <button class="btn-primary" id="schedule-dispatch-btn">+ Dispatch</button>
                </div>
            </header>

            <div class="content-wrapper">
                <div class="page-header">
                    <h2>Dispatch Management</h2>
                    <span class="date">Observability and Intervention</span>
                </div>

                <!-- Metrics Grid -->
                <div class="stats-grid">
                    <div class="card stat-card">
                        <div class="stat-header primary">
                            <span class="label">Active Dispatches</span>
                        </div>
                        <div class="stat-value" id="stats-active">--</div>
                        <div class="stat-details">
                            <span class="trend neutral">Live status</span>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-header success">
                            <span class="label">Success Rate (24h)</span>
                        </div>
                        <div class="stat-value" id="stats-success">--%</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-header warning">
                            <span class="label">Pending</span>
                        </div>
                        <div class="stat-value" id="stats-pending">--</div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-header danger">
                            <span class="label">Failed</span>
                        </div>
                        <div class="stat-value" id="stats-failed">--</div>
                        <div class="stat-details">
                            <span class="trend negative" style="cursor: pointer;" onclick="filterFailed()">View
                                failed</span>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filter-bar">
                    <select id="filter-status" class="form-control"
                        style="width: auto; padding: 6px; border-radius: 6px; background: rgba(0,0,0,0.2); color:white; border: 1px solid var(--border-subtle);">
                        <option value="">All Statuses</option>
                        <option value="delivered">Delivered</option>
                        <option value="pending">Pending</option>
                        <option value="sending">Sending</option>
                        <option value="failed">Failed</option>
                    </select>
                    <select id="filter-channel" class="form-control" style="width: auto;">
                        <option value="">All Channels</option>
                        <option value="telegram">Telegram</option>
                        <option value="email">Email</option>
                    </select>
                    <button class="btn-secondary" onclick="loadDispatchHistory()">Refresh</button>
                </div>

                <!-- History Table -->
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Route</th>
                                <th>Driver</th>
                                <th>Status</th>
                                <th>Channels</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dispatch-table-body">
                            <tr class="loading-row">
                                <td colspan="6" style="text-align:center; padding: 20px;">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Dispatch Detail Modal -->
    <div class="modal-overlay" id="dispatch-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Dispatch Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="dispatch-detail-content">
                <!-- Populated by JS -->
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn-primary" id="retry-btn">Retry Dispatch</button>
            </div>
        </div>
    </div>

    <!-- Schedule Dispatch Modal -->
    <div class="modal-overlay" id="schedule-dispatch-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Schedule Dispatch</h3>
                <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <!-- Driver Selection -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Select Drivers</label>
                    <div id="driver-checklist"
                        style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px; background: rgba(0,0,0,0.2);">
                        <p style="color: var(--text-secondary);">Loading drivers...</p>
                    </div>
                    <p id="driver-error"
                        style="color: var(--accent-danger); font-size: 0.85rem; margin-top: 8px; display: none;"></p>
                </div>

                <!-- Schedule Time -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">When to Dispatch</label>
                    <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="dispatch-timing" value="now" checked
                                style="accent-color: var(--accent-primary);">
                            <span>Send Immediately</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="radio" name="dispatch-timing" value="scheduled"
                                style="accent-color: var(--accent-primary);">
                            <span>Schedule for Later</span>
                        </label>
                    </div>
                    <div id="schedule-time-picker" style="margin-top: 12px; display: none;">
                        <input type="datetime-local" id="scheduled-datetime"
                            style="padding: 10px; border-radius: 8px; border: 1px solid var(--border-subtle); background: rgba(0,0,0,0.2); color: var(--text-primary); width: 100%;">
                    </div>
                </div>

                <!-- Route Preview -->
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Routes to Dispatch</label>
                    <div id="route-preview"
                        style="border: 1px solid var(--border-subtle); border-radius: 8px; padding: 12px; background: rgba(0,0,0,0.2); min-height: 60px;">
                        <p style="color: var(--text-secondary); text-align: center;">Select drivers to see their next
                            routes</p>
                    </div>
                </div>
            </div>
            <div class="modal-actions" style="padding: 16px 20px; border-top: 1px solid var(--border-subtle);">
                <button class="btn-secondary" onclick="closeScheduleModal()">Cancel</button>
                <button class="btn-primary" id="confirm-schedule-btn" disabled>Schedule Dispatch</button>
            </div>
        </div>
    </div>

    <script src="dispatch-client.js"></script>
    <script>
        const client = new DispatchClient();

        // Mock data logic for now until endpoint exists
        // This simulates the response we expect from the future GET /dispatch/history endpoint
        const mockHistory = [
            {
                id: '1',
                created_at: new Date().toISOString(),
                route: { name: 'Route A', code: 'R-101' },
                driver: { name: 'John Doe' },
                status: 'delivered',
                channels: ['telegram']
            },
            {
                id: '2',
                created_at: new Date(Date.now() - 3600000).toISOString(),
                route: { name: 'Route B', code: 'R-102' },
                driver: { name: 'Jane Smith' },
                status: 'failed',
                channels: ['telegram', 'email'],
                error: 'Invalid Telegram Chat ID'
            }
        ];

        async function loadDispatchHistory() {
            const tableBody = document.getElementById('dispatch-table-body');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading...</td></tr>';

            const statusFilter = document.getElementById('filter-status').value;
            const channelFilter = document.getElementById('filter-channel').value; // Not supported by backend yet, but we can pass it or ignore

            try {
                const [historyResponse, statsResponse] = await Promise.all([
                    client.getHistory({ status: statusFilter }),
                    client.getStats()
                ]);

                renderTable(historyResponse.dispatches || []);
                renderStats(statsResponse?.stats || { active: 0, success: 0, pending: 0, failed: 0 });

            } catch (error) {
                console.error("Error loading history", error);
                tableBody.innerHTML = `<tr><td colspan="6" style="color: var(--accent-danger); text-align:center;">Error loading data: ${error.message}</td></tr>`;
            }
        }

        function renderStats(stats) {
            document.getElementById('stats-active').innerText = stats.active || 0;
            // distinct success vs delivered? Backend has 'success' count which comes from 'delivered' status.
            // Requirement says "Success Rate". We only have counts.
            // Success Rate = success / total * 100?
            const total = (stats.active || 0) + (stats.success || 0) + (stats.failed || 0) + (stats.pending || 0);
            const rate = total > 0 ? Math.round(((stats.success || 0) / total) * 100) : 0;

            document.getElementById('stats-success').innerText = rate + '%';
            document.getElementById('stats-pending').innerText = stats.pending || 0;
            document.getElementById('stats-failed').innerText = stats.failed || 0;
        }

        function renderTable(dispatches) {
            const tableBody = document.getElementById('dispatch-table-body');
            if (!dispatches || dispatches.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No dispatch history found.</td></tr>';
                return;
            }

            tableBody.innerHTML = dispatches.map(d => `
                <tr>
                    <td>${new Date(d.created_at).toLocaleString()}</td>
                    <td>${d.route_name || d.route_id || 'Unknown'}</td>
                    <td>${d.driver_name || d.driver_id || 'Unknown'}</td>
                    <td><span class="status-badge ${getStatusClass(d.status)}">${d.status}</span></td>
                    <td>${d.requested_channels ? d.requested_channels.join(', ') : ''}</td>
                    <td>
                        <button class="action-btn" onclick="viewDetails('${d.id}')">üëÅÔ∏è</button>
                        ${d.status === 'failed' ? `<button class="action-btn" onclick="retry('${d.id}')">üîÑ</button>` : ''}
                    </td>
                </tr>
             `).join('');
        }

        function getStatusClass(status) {
            if (status === 'delivered') return 'active'; // green
            if (status === 'viewed') return 'active'; // green
            if (status === 'acknowledged') return 'active'; // green
            if (status === 'failed') return 'suspended'; // red
            if (status === 'sending') return 'archived'; // yellow/orange
            if (status === 'pending') return 'archived'; // yellow/orange
            return 'inactive';
        }

        async function viewDetails(id) {
            const modal = document.getElementById('dispatch-modal');
            const content = document.getElementById('dispatch-detail-content');
            content.innerHTML = `<p>Loading details for ${id}...</p>`;
            modal.style.display = 'block';

            try {
                const data = await client.getDispatchStatus(id);
                const d = data; // backend returns detailed object directly

                content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <p><strong>Dispatch ID:</strong> ${d.id}</p>
                    <p><strong>Route ID:</strong> ${d.route_id}</p>
                    <p><strong>Driver ID:</strong> ${d.driver_id}</p>
                    <p><strong>Status:</strong> <span class="status-badge ${getStatusClass(d.status)}">${d.status}</span></p>
                </div>
                <h4>Channels</h4>
                <ul style="list-style:none; padding:0;">
                    ${d.channel_dispatches.map(cd => `
                        <li style="margin-bottom:10px; padding:10px; background:var(--bg-subtle); border-radius:6px;">
                            <strong>${cd.channel}</strong>: ${cd.status}
                            <br><small>Sent: ${cd.sent_at ? new Date(cd.sent_at).toLocaleString() : 'Pending'}</small>
                            ${cd.delivered_at ? `<br><small>Delivered: ${new Date(cd.delivered_at).toLocaleString()}</small>` : ''}
                            ${cd.error_message ? `<br><small style="color:red">${cd.error_message}</small>` : ''}
                        </li>
                    `).join('')}
                </ul>
             `;
            } catch (e) {
                content.innerHTML = `<p style="color:red">Failed to load details: ${e.message}</p>`;
            }
        }

        function closeModal() {
            document.getElementById('dispatch-modal').style.display = 'none';
        }

        // ===== Schedule Dispatch Modal =====
        let availableDrivers = [];
        let selectedDriverIds = new Set();
        let driverRouteMap = new Map(); // driverId -> route info

        function openScheduleModal() {
            document.getElementById('schedule-dispatch-modal').style.display = 'block';
            document.getElementById('driver-error').style.display = 'none';
            selectedDriverIds.clear();
            driverRouteMap.clear();
            loadDriversForSchedule();
            updateRoutePreview();
            updateScheduleButton();

            // Set default datetime to now + 30 minutes
            const now = new Date();
            now.setMinutes(now.getMinutes() + 30);
            const localISOTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('scheduled-datetime').value = localISOTime;
        }

        function closeScheduleModal() {
            document.getElementById('schedule-dispatch-modal').style.display = 'none';
        }

        async function loadDriversForSchedule() {
            const checklist = document.getElementById('driver-checklist');
            checklist.innerHTML = '<p style="color: var(--text-secondary);">Loading drivers...</p>';

            try {
                // Fetch drivers from API
                const response = await fetch('/api/v1/drivers');
                const result = await response.json();
                const drivers = result.data?.data || result.data || [];

                // Filter only active drivers
                availableDrivers = drivers.filter(d => d.status === 'active');

                if (availableDrivers.length === 0) {
                    checklist.innerHTML = '<p style="color: var(--text-secondary);">No active drivers found</p>';
                    return;
                }

                // Check which drivers are already in active dispatch jobs
                let activeJobDrivers = [];
                try {
                    activeJobDrivers = await client.getActiveDriverIds();
                } catch (e) {
                    console.warn('Could not fetch active job drivers:', e);
                }

                checklist.innerHTML = availableDrivers.map(driver => {
                    const isInActiveJob = activeJobDrivers.includes(driver.id);
                    const disabledAttr = isInActiveJob ? 'disabled' : '';
                    const labelStyle = isInActiveJob ? 'opacity: 0.5;' : '';
                    const warningText = isInActiveJob ? '<span style="color: var(--accent-warning); font-size: 0.75rem; margin-left: 8px;">(In active job)</span>' : '';

                    return `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 6px; cursor: pointer; ${labelStyle}" 
                               onmouseover="this.style.background='rgba(255,255,255,0.05)'" 
                               onmouseout="this.style.background='transparent'">
                            <input type="checkbox" class="driver-checkbox" value="${driver.id}" ${disabledAttr}
                                   style="accent-color: var(--accent-primary);"
                                   onchange="handleDriverSelection(this)">
                            <span>${driver.firstName} ${driver.lastName}</span>
                            ${warningText}
                        </label>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading drivers:', error);
                checklist.innerHTML = '<p style="color: var(--accent-danger);">Error loading drivers</p>';
            }
        }

        async function handleDriverSelection(checkbox) {
            const driverId = checkbox.value;

            if (checkbox.checked) {
                selectedDriverIds.add(driverId);
                // Fetch the next route for this driver
                await fetchRouteForDriver(driverId);
            } else {
                selectedDriverIds.delete(driverId);
                driverRouteMap.delete(driverId);
            }

            updateRoutePreview();
            updateScheduleButton();
        }

        async function fetchRouteForDriver(driverId) {
            try {
                // Get today's date
                const today = new Date().toISOString().split('T')[0];

                // Fetch routes for this driver with status 'planned'
                const response = await fetch(`/api/v1/routes?driverId=${driverId}&status=planned`);
                const result = await response.json();
                const routes = result.data?.data || result.data || [];
                const nextRoute = routes.find(r => r.routeDate >= today);

                if (nextRoute) {
                    driverRouteMap.set(driverId, {
                        id: nextRoute.id,
                        routeCode: nextRoute.routeCode || nextRoute.routeName || nextRoute.id,
                        routeDate: nextRoute.routeDate,
                        stopCount: nextRoute.bookings?.length || nextRoute.stops?.length || 0
                    });
                } else {
                    driverRouteMap.set(driverId, null);
                }
            } catch (error) {
                console.error('Error fetching route for driver:', driverId, error);
                driverRouteMap.set(driverId, null);
            }
        }

        function updateRoutePreview() {
            const preview = document.getElementById('route-preview');

            if (selectedDriverIds.size === 0) {
                preview.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Select drivers to see their next routes</p>';
                return;
            }

            const items = [];
            let hasValidRoutes = false;

            selectedDriverIds.forEach(driverId => {
                const driver = availableDrivers.find(d => d.id === driverId);
                const routeInfo = driverRouteMap.get(driverId);

                if (driver) {
                    if (routeInfo) {
                        hasValidRoutes = true;
                        items.push(`
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,255,100,0.1); border-radius: 6px; margin-bottom: 6px;">
                                <span><strong>${driver.firstName} ${driver.lastName}</strong></span>
                                <span style="color: var(--accent-success);">${routeInfo.routeCode} (${routeInfo.routeDate})</span>
                            </div>
                        `);
                    } else {
                        items.push(`
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,100,0,0.1); border-radius: 6px; margin-bottom: 6px;">
                                <span>${driver.firstName} ${driver.lastName}</span>
                                <span style="color: var(--accent-warning);">No planned route</span>
                            </div>
                        `);
                    }
                }
            });

            preview.innerHTML = items.join('');
        }

        function updateScheduleButton() {
            const btn = document.getElementById('confirm-schedule-btn');
            let hasValidRoutes = false;

            selectedDriverIds.forEach(driverId => {
                if (driverRouteMap.get(driverId)) hasValidRoutes = true;
            });

            btn.disabled = !hasValidRoutes;
            btn.textContent = selectedDriverIds.size > 0
                ? `Schedule Dispatch (${selectedDriverIds.size} driver${selectedDriverIds.size > 1 ? 's' : ''})`
                : 'Schedule Dispatch';
        }

        async function scheduleDispatch() {
            const btn = document.getElementById('confirm-schedule-btn');
            btn.disabled = true;
            btn.textContent = 'Scheduling...';

            try {
                const timing = document.querySelector('input[name="dispatch-timing"]:checked').value;
                const scheduledTime = timing === 'now'
                    ? new Date().toISOString()
                    : new Date(document.getElementById('scheduled-datetime').value).toISOString();

                const driverIds = Array.from(selectedDriverIds);

                // Create dispatch job via API
                const result = await client.createDispatchJob({
                    driverIds: driverIds,
                    scheduledTime: scheduledTime,
                    name: `Dispatch ${new Date().toLocaleString()}`
                });

                console.log('Dispatch job created:', result);

                closeScheduleModal();
                loadDispatchHistory(); // Refresh the history table

            } catch (error) {
                console.error('Error scheduling dispatch:', error);
                document.getElementById('driver-error').textContent = `Error: ${error.message}`;
                document.getElementById('driver-error').style.display = 'block';
            } finally {
                updateScheduleButton();
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadDispatchHistory();

            // Schedule dispatch button
            document.getElementById('schedule-dispatch-btn').addEventListener('click', openScheduleModal);

            // Confirm schedule button
            document.getElementById('confirm-schedule-btn').addEventListener('click', scheduleDispatch);

            // Toggle schedule time picker visibility
            document.querySelectorAll('input[name="dispatch-timing"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const picker = document.getElementById('schedule-time-picker');
                    picker.style.display = e.target.value === 'scheduled' ? 'block' : 'none';
                });
            });
        });

    </script>
</body>

</html>